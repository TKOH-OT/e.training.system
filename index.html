<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TKOH A&OT Training & Quality Monitoring System </title>
    <style>
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
           background: linear-gradient(135deg, #00c853 0%, #69f0ae 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 1400px;
            width: 100%;
            animation: slideIn 0.5s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            text-align: center;
            color: #ffa502;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        h2 {
            color: #ffa502;
            margin-bottom: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* ÁôªÂÖ•È†ÅÈù¢ */
        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #ffa502;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ffa502 0%, #ff9500 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-danger:hover {
            background: #e84118;
        }

        .btn-success {
            background: #2ed573;
            color: white;
        }

        .btn-success:hover {
            background: #26d07c;
        }

        .btn-warning {
            background: #ffa502;
            color: white;
        }

        .btn-warning:hover {
            background: #ff9500;
        }

        .btn-info {
            background: #1e90ff;
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* ‰∏ªÈÅ∏ÂñÆ */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .menu-card {
            background: linear-gradient(135deg, #ffa502 0%, #ff9500 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }

        .menu-card .emoji {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .menu-card .title {
            font-size: 1.2em;
            font-weight: bold;
        }

        /* ËÅ∑Á¥öÈ°èËâ≤ */
.level-WM { background: linear-gradient(135deg, #c23616 0%, #e84118 100%) !important; }
.level-APN { background: linear-gradient(135deg, #ff6b81 0%, #ee5a6f 100%) !important; }
.level-RN { background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%) !important; }
.level-PCA1, .level-PCA2, .level-PCA3, .level-OTA { 
    background: linear-gradient(135deg, #ffa502 0%, #ff9500 100%) !important;
}
        
.level-WM:hover { box-shadow: 0 15px 30px rgba(194, 54, 22, 0.4) !important; }
.level-APN:hover { box-shadow: 0 15px 30px rgba(255, 107, 129, 0.4) !important; }
.level-RN:hover { box-shadow: 0 15px 30px rgba(0, 210, 255, 0.4) !important; }
.level-PCA1:hover, .level-PCA2:hover, .level-PCA3:hover, .level-OTA:hover { 
    box-shadow: 0 15px 30px rgba(255, 165, 2, 0.4) !important; 
}

        /* Â∏≥Êà∂ÁÆ°ÁêÜ */
        .account-list {
            margin-top: 20px;
        }

        .account-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .account-info {
            flex: 1;
        }

        .account-info .name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        .account-info .details {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .account-actions {
            display: flex;
            gap: 10px;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
            margin-right: 5px;
            display: inline-block;
        }

        .badge-admin {
            background: #ff4757;
            color: white;
        }

        .badge-supervisor {
            background: #ffa502;
            color: white;
        }

        .badge-staff {
            background: #2ed573;
            color: white;
        }

        .badge-info {
            background: #1e90ff;
            color: white;
        }

        .critical-warning {
    color: #ff4757 !important;
    font-weight: bold;
}
        
        .badge-critical {
            background: #ff4757;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .badge-WM { background: #c23616; color: white; }
        .badge-APN { background: #ff6b81; color: white; }
        .badge-RN { background: #00d2ff; color: white; }
        .badge-PCA1, .badge-PCA2, .badge-PCA3, .badge-OTA { 
            background: #2ed573; color: white; 
        }

        /* ==================== Dashboard Âç°ÁâáÂºèË®≠Ë®à ==================== */
        .dashboard-header {
            background: linear-gradient(135deg, #ffa502 0%, #ff9500 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .dashboard-title {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .dashboard-subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }

        /* ÈáçË¶ÅË©ïÊ†∏ÊôÇÈñìË°® */
        .important-timeline {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .timeline-header {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffa502;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timeline-items {
            display: grid;
            gap: 15px;
        }

        .timeline-item {
            background: linear-gradient(135deg, #ffa502 0%, #ff9500 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .timeline-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(255, 165, 2, 0.4);
        }

        .timeline-item.overdue {
            background: linear-gradient(135deg, #ff4757 0%, #e84118 100%);
        }

        .timeline-item.completed {
            background: linear-gradient(135deg, #2ed573 0%, #26d07c 100%);
        }

        .timeline-item-info {
            flex: 1;
        }

        .timeline-item-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .timeline-item-details {
            font-size: 0.9em;
            opacity: 0.95;
        }

        .timeline-item-status {
            font-size: 1.1em;
            font-weight: bold;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }

        .training-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .training-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .training-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .training-card.completed {
            background: linear-gradient(135deg, #2ed573 0%, #26d07c 100%);
            color: white;
        }

        .training-card.completed .card-title,
        .training-card.completed .card-stats,
        .training-card.completed .progress-percent {
            color: white;
        }

        /* ==================== Quiz Ê∏¨È©óÂç°ÁâáÈ°èËâ≤ÁãÄÊÖã ==================== */
.training-card.quiz-pending {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.training-card.quiz-pending .card-title,
.training-card.quiz-pending .card-stats,
.training-card.quiz-pending .progress-percent,
.training-card.quiz-pending .progress-label {
    color: white;
}

.training-card.quiz-pending .progress-ring-circle {
    stroke: white;
}

.training-card.quiz-pending .progress-ring-bg {
    stroke: rgba(255,255,255,0.3);
}

.training-card.quiz-passed {
    background: linear-gradient(135deg, #2ed573 0%, #26d07c 100%);
    color: white;
}

.training-card.quiz-passed .card-title,
.training-card.quiz-passed .card-stats,
.training-card.quiz-passed .progress-percent,
.training-card.quiz-passed .progress-label {
    color: white;
}

.training-card.quiz-passed .progress-ring-circle {
    stroke: white;
}

.training-card.quiz-passed .progress-ring-bg {
    stroke: rgba(255,255,255,0.3);
}

.training-card.quiz-failed {
    background: linear-gradient(135deg, #ff4757 0%, #e84118 100%);
    color: white;
    animation: pulse 2s infinite;
}

.training-card.quiz-failed .card-title,
.training-card.quiz-failed .card-stats,
.training-card.quiz-failed .progress-percent,
.training-card.quiz-failed .progress-label {
    color: white;
}

.training-card.quiz-failed .progress-ring-circle {
    stroke: white;
}

.training-card.quiz-failed .progress-ring-bg {
    stroke: rgba(255,255,255,0.3);
}

.training-card.quiz-incomplete {
    background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
    color: white;
}

.training-card.quiz-incomplete .card-title,
.training-card.quiz-incomplete .card-stats,
.training-card.quiz-incomplete .progress-percent,
.training-card.quiz-incomplete .progress-label {
    color: white;
}

.training-card.quiz-incomplete .progress-ring-circle {
    stroke: white;
}

.training-card.quiz-incomplete .progress-ring-bg {
    stroke: rgba(255,255,255,0.3);
}
        
        .training-card.in-progress {
            border: 2px solid #;
        }

        .card-icon {
            font-size: 3em;
            margin-bottom: 15px;
            text-align: center;
        }

        .card-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .card-progress {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease;
            stroke: #ffa502;
        }

        .training-card.completed .progress-ring-circle {
            stroke: white;
        }

        .progress-ring-bg {
            stroke: #e0e0e0;
        }

        .training-card.completed .progress-ring-bg {
            stroke: rgba(255,255,255,0.3);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percent {
            font-size: 2em;
            font-weight: bold;
            color: #ffa502;
        }

        .progress-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .training-card.completed .progress-label {
            color: white;
        }

        .card-stats {
            text-align: center;
            color: #666;
            font-size: 0.95em;
        }

        .card-success-badge {
            background: white;
            color: #2ed573;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            color: #333;
        }

        /* ÂüπË®ìÈ†ÖÁõÆË©≥ÊÉÖ */
        .item-detail-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .item-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .score-info {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #ffa502;
        }

        .score-info .score-title {
            font-weight: bold;
            color: #ffa502;
            margin-bottom: 8px;
        }

        .score-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .score-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .score-item-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .score-item-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffa502;
        }

        .score-item-value.pass {
            color: #2ed573;
        }

        .score-item-value.fail {
            color: #ff4757;
        }

        .checklist-container {
            margin-top: 20px;
        }

        .checklist-header {
            font-weight: bold;
            margin-bottom: 15px;
            color: #ffa502;
            font-size: 1.1em;
        }

        .checklist-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid #e0e0e0;
            transition: all 0.3s;
        }

        .checklist-item:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .checklist-item.critical {
            border-left-color: #ff4757;
            background: #fff5f5;
        }

        .checklist-item.completed {
            border-left-color: #2ed573;
            background: #f0fff4;
        }

        .checklist-item.failed {
            border-left-color: #ff4757;
            background: #fff5f5;
        }

        .checklist-step-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .checklist-step-name {
            flex: 1;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checklist-step-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .step-btn {
            padding: 8px 16px;
            font-size: 13px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .step-btn-pass {
            background: #2ed573;
            color: white;
        }

        .step-btn-pass:hover {
            background: #26d07c;
            transform: translateY(-2px);
        }

        .step-btn-fail {
            background: #ff4757;
            color: white;
        }

        .step-btn-fail:hover {
            background: #e84118;
            transform: translateY(-2px);
        }

        .step-btn-reset {
            background: #ffa502;
            color: white;
        }

        .step-btn-reset:hover {
            background: #ff9500;
            transform: translateY(-2px);
        }

        .step-remarks {
            margin-top: 12px;
        }

        .step-remarks label {
            display: block;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .step-remarks textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            min-height: 60px;
            resize: vertical;
            font-family: inherit;
        }

        .step-remarks textarea:focus {
            outline: none;
            border-color: #ffa502;
        }

        .evaluation-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        /* ÂΩàÂá∫Ë¶ñÁ™ó */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ffa502;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        /* ÂêêÂè∏ÈÄöÁü• */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-success {
            border-left: 4px solid #2ed573;
        }

        .toast-error {
            border-left: 4px solid #ff4757;
        }

        .toast-warning {
            border-left: 4px solid #ffa502;
        }

        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .emoji-option {
            font-size: 2em;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .emoji-option:hover {
            border-color: #ffa502;
            transform: scale(1.1);
        }

        .emoji-option.selected {
            border-color: #ffa502;
            background: #f0f4ff;
        }

        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .staff-card {
            color: white;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .staff-card:hover {
            transform: translateY(-5px);
        }

        .staff-card-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .staff-card-info {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        .steps-editor {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
        }

        .step-edit-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #ffa502;
        }

.step-edit-item.critical {
    border-left-color: #ff4757;
}

/* ADD THESE 3 NEW RULES BELOW ‚Üì */
.step-subtitle {
    background: #ffa502;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: bold;
    font-size: 0.95em;
    margin-bottom: 8px;
    display: inline-block;
}

.step-edit-item.subtitle {
    border-left-color: #ffa502;
    background: #f0f4ff;
}

        .step-edit-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .step-number {
            font-weight: bold;
            color: #ffa502;
        }

        .loading-message {
            text-align: center;
            color: #ffa502;
            font-size: 1.2em;
            padding: 20px;
        }

        .no-data-message {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 1.1em;
        }

        /* ÂüπË®ìÈ°ûÂûãÈÅ∏Êìá */
        .training-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .type-card {
            background: linear-gradient(135deg, #ffa502 0%, #ff9500 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }

        .type-card.selected {
            border: 4px solid #ffa502;
            box-shadow: 0 10px 30px rgba(255, 165, 2, 0.5);
        }

        .type-card .emoji {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .type-card .title {
            font-size: 1.5em;
            font-weight: bold;
        }

        /* Êà™Ê≠¢Êó•ÊúüË®≠ÂÆö */
        .deadline-settings {
            background: #fff9e6;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #ffa502;
        }

        .deadline-settings-title {
            font-weight: bold;
            color: #ffa502;
            margin-bottom: 10px;
        }

        .deadline-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            align-items: end;
        }

        .deadline-inputs input {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
        }

        /* ÂüπË®ìÈ†ÖÁõÆÈ§ÖÁãÄÂç°Áâá */
.items-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.item-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    transition: all 0.3s;
    cursor: pointer;
    position: relative;
}

.item-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.item-card.expanded {
    grid-column: 1 / -1;
    cursor: default;
}

.item-card-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.item-card.expanded .item-card-header {
    flex-direction: row;
    justify-content: flex-start;  /* Change from space-between to flex-start */
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 15px;
    margin-bottom: 20px;
    gap: 30px;  /* Add gap between items */
}

.item-card-title-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
}

.item-card.expanded .item-card-title-section {
    align-items: flex-start;
    flex: 0 0 auto;  /* Don't let it grow */
}

.item-card-progress {
    position: relative;
    width: 80px;
    height: 80px;
    flex-shrink: 0;
}

.item-card.expanded .item-card-progress {
    width: 100px;
    height: 100px;
    margin-right: auto;
}

.item-progress-ring {
    transform: rotate(-90deg);
    width: 100%;
    height: 100%;
}

.item-progress-ring-circle {
    transition: stroke-dashoffset 0.5s ease;
    stroke: #ffa502;
}

.item-card.completed .item-progress-ring-circle {
    stroke: #2ed573;
}

.item-progress-ring-bg {
    stroke: #e0e0e0;
}

.item-progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    pointer-events: none; /* Prevent blocking clicks */
}

.item-progress-percent {
    font-size: 1.5em;
    font-weight: bold;
    color: #ffa502;
    line-height: 1;
}

.item-card.completed .item-progress-percent {
    color: #2ed573;
}

.item-progress-label {
    font-size: 0.75em;
    color: #666;
    margin-top: 3px;
    line-height: 1;
}

.item-card-actions {
    display: none;
    gap: 10px;
    margin-top: 15px;
}

.item-card.expanded .item-card-actions {
    display: flex;
}

.item-card-content {
    display: none;
    margin-top: 20px;
}

.item-card.expanded .item-card-content {
    display: block;
}

.back-button {
    position: absolute;
    top: 25px;
    right: 25px;
    background: #6c757d;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s;
}

.back-button:hover {
    background: #5a6268;
    transform: translateY(-2px);
}

.item-card.expanded .back-button {
    display: block;
}

.item-card:not(.expanded) .back-button {
    display: none;
}

.no-items-message {
    grid-column: 1 / -1;
    text-align: center;
    color: #999;
    padding: 40px;
    font-size: 1.1em;
}

        /* ==================== Audit System Styles ==================== */
.audit-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
}

.audit-section-title {
    font-size: 1.3em;
    font-weight: bold;
    color: #ffa502;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
}

.audit-item-group {
    margin-bottom: 15px;
}

.audit-item-row {
    display: grid;
    grid-template-columns: 2fr 80px 80px 80px 1fr;
    gap: 10px;
    align-items: center;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 10px;
}

.audit-item-name {
    font-weight: 500;
    color: #333;
}

.audit-checkbox-group {
    display: flex;
    align-items: center;
    justify-content: center;
}

.audit-checkbox-group input[type="radio"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.audit-checkbox-group label {
    margin: 0;
    margin-left: 5px;
    font-size: 0.9em;
}

.audit-remark-input {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    font-size: 0.9em;
}

.audit-measurement-group {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 10px;
}

.audit-measurement-item {
    display: flex;
    flex-direction: column;
}

.audit-measurement-item label {
    font-size: 0.85em;
    color: #666;
    margin-bottom: 5px;
}

.audit-measurement-item input {
    padding: 6px 10px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    font-size: 0.9em;
}

.audit-summary {
    background: linear-gradient(135deg, #ffa502 0%, #ff9500 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin-top: 20px;
    text-align: center;
}

.audit-summary-title {
    font-size: 1.2em;
    font-weight: bold;
    margin-bottom: 10px;
}

.audit-summary-rate {
    font-size: 2.5em;
    font-weight: bold;
    margin: 10px 0;
}

.audit-summary-status {
    font-size: 1.1em;
    opacity: 0.95;
}

.audit-history-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: all 0.3s;
}

.audit-history-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.12);
}

.audit-history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.audit-history-date {
    font-size: 1.1em;
    font-weight: bold;
    color: #333;
}

.audit-history-rate {
    font-size: 1.3em;
    font-weight: bold;
}

.audit-history-rate.pass {
    color: #2ed573;
}

.audit-history-rate.fail {
    color: #ff4757;
}

.audit-history-details {
    color: #666;
    font-size: 0.9em;
    margin-top: 5px;
}

.location-selector {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin: 20px 0;
}

.location-card {
    background: linear-gradient(135deg, #ffa502 0%, #ff9500 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.location-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(255, 165, 2, 0.4);
}

.location-card.selected {
    border: 4px solid #ff6b00;
    box-shadow: 0 10px 30px rgba(255, 107, 0, 0.5);
}

.subsection-title {
    background: #f0f4ff;
    padding: 10px 15px;
    border-radius: 8px;
    font-weight: bold;
    color: #ffa502;
    margin: 15px 0 10px 0;
    border-left: 4px solid #ffa502;
}

        /* ==================== AuditBoard Dashboard Styles ==================== */
.audit-dashboard-header {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    color: white;
    padding: 40px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 5px 20px rgba(30, 58, 138, 0.3);
}

.audit-dashboard-title {
    font-size: 2.2em;
    margin-bottom: 10px;
    font-weight: bold;
}

.audit-dashboard-subtitle {
    font-size: 1.1em;
    opacity: 0.95;
}

.audit-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.audit-stat-card {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    transition: all 0.3s;
    border-left: 5px solid #3b82f6;
}

.audit-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
}

.audit-stat-card.success {
    border-left-color: #10b981;
}

.audit-stat-card.warning {
    border-left-color: #f59e0b;
}

.audit-stat-card.danger {
    border-left-color: #ef4444;
}

.audit-stat-icon {
    font-size: 2.5em;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.audit-stat-value {
    font-size: 2.8em;
    font-weight: bold;
    color: #1e3a8a;
    margin-bottom: 8px;
    line-height: 1;
}

.audit-stat-label {
    color: #64748b;
    font-size: 1em;
    font-weight: 500;
}

.audit-stat-trend {
    font-size: 0.9em;
    color: #10b981;
    margin-top: 8px;
}

.audit-action-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.audit-action-card {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    padding: 40px;
    border-radius: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 5px 20px rgba(59, 130, 246, 0.3);
}

.audit-action-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 35px rgba(59, 130, 246, 0.4);
}

.audit-action-card.secondary {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    box-shadow: 0 5px 20px rgba(139, 92, 246, 0.3);
}

.audit-action-card.secondary:hover {
    box-shadow: 0 15px 35px rgba(139, 92, 246, 0.4);
}

.audit-action-icon {
    font-size: 4em;
    margin-bottom: 20px;
}

.audit-action-title {
    font-size: 1.6em;
    font-weight: bold;
    margin-bottom: 10px;
}

.audit-action-desc {
    font-size: 1em;
    opacity: 0.95;
}

.audit-history-grid {
    display: grid;
    gap: 20px;
}

.audit-history-card-modern {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: all 0.3s;
    border-left: 5px solid #3b82f6;
}

.audit-history-card-modern:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
}

.audit-history-card-modern.passed {
    border-left-color: #10b981;
}

.audit-history-card-modern.failed {
    border-left-color: #ef4444;
}

.audit-history-card-modern.draft {
    border-left-color: #f59e0b;
    opacity: 0.85;
}

.audit-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
}

.audit-card-date {
    font-size: 1.3em;
    font-weight: bold;
    color: #1e293b;
    margin-bottom: 8px;
}

.audit-card-location {
    color: #64748b;
    font-size: 0.95em;
}

.audit-card-score {
    text-align: right;
}

.audit-score-big {
    font-size: 3em;
    font-weight: bold;
    line-height: 1;
    margin-bottom: 5px;
}

.audit-score-big.pass {
    color: #10b981;
}

.audit-score-big.fail {
    color: #ef4444;
}

.audit-score-label {
    font-size: 0.85em;
    color: #64748b;
}

.audit-card-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    padding: 15px;
    background: #f8fafc;
    border-radius: 10px;
    margin-top: 15px;
}

.audit-detail-item {
    text-align: center;
}

.audit-detail-value {
    font-size: 1.8em;
    font-weight: bold;
    color: #1e293b;
}

.audit-detail-value.success {
    color: #10b981;
}

.audit-detail-value.danger {
    color: #ef4444;
}

.audit-detail-label {
    font-size: 0.85em;
    color: #64748b;
    margin-top: 5px;
}

.audit-empty-state {
    text-align: center;
    padding: 80px 40px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.05);
}

.audit-empty-icon {
    font-size: 5em;
    color: #cbd5e1;
    margin-bottom: 20px;
}

.audit-empty-title {
    font-size: 1.5em;
    font-weight: bold;
    color: #64748b;
    margin-bottom: 10px;
}

.audit-empty-desc {
    color: #94a3b8;
    font-size: 1.1em;
}

        /* Ë®ìÁ∑¥Ë®òÈåÑÊ®£Âºè */
.training-record-container {
    margin-top: 20px;
}

.training-record-header {
    font-weight: 900;  /* ‚≠ê ÊîπÔºöÂêåË©ïÊ†∏È†ÖÁõÆ‰∏ÄÊ®£Á≤ó */
    margin-bottom: 15px;
    color: #ffa502;
    font-size: 1.8em;  /* ‚≠ê ÊîπÔºöÂêåË©ïÊ†∏È†ÖÁõÆ‰∏ÄÊ®£Â§ß */
    text-align: center;  /* ‚≠ê Êñ∞Â¢ûÔºöÁΩÆ‰∏≠ */
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);  /* ‚≠ê Êñ∞Â¢ûÔºöÂêåË©ïÊ†∏È†ÖÁõÆ‰∏ÄÊ®£ÂòÖÈô∞ÂΩ± */
    letter-spacing: 0.5px;  /* ‚≠ê Êñ∞Â¢ûÔºöÂ≠óË∑ù */
}

.training-record-item {
    background: #f8f9fa;
    padding: 20px;
    margin-bottom: 15px;
    border-radius: 10px;
    border-left: 4px solid #2ed573;
}

.training-record-row {
    display: grid;
    grid-template-columns: 180px 1fr;  /* ‚≠ê ÊîπÁÇ∫ 180pxÔºåÂ¢ûÂä†Ê®ôÁ±§ÂØ¨Â∫¶ */
    gap: 15px;
    align-items: start;  /* ‚≠ê ÊîπÁÇ∫ startÔºåËÆìÁ∞ΩÂêçÊ°Ü‰∏çË¶ÅÂ§™È´ò */
    margin-bottom: 12px;
}

.training-record-label {
    font-weight: 500;
    color: #666;
    padding-top: 8px;  /* ‚≠ê Êñ∞Â¢ûÔºöÂ∞çÈΩäÈ†ÇÈÉ® */
}

.signature-box {
    border: 2px dashed #e0e0e0;
    border-radius: 8px;
    padding: 10px 15px;  /* ‚≠ê ÊîπÂ∞è paddingÔºåÂéüÊú¨ÊòØ 15px */
    background: white;
    min-height: 45px;  /* ‚≠ê ÊîπÂ∞èÈ´òÂ∫¶ÔºåÂéüÊú¨ÊòØ 80px */
    max-height: 50px;  /* ‚≠ê Êñ∞Â¢ûÔºöÈôêÂà∂ÊúÄÂ§ßÈ´òÂ∫¶ */
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
    font-style: italic;
    font-size: 0.9em;  /* ‚≠ê Êñ∞Â¢ûÔºöÂ≠óÈ´îÁ®çÂæÆÂ∞è‰∏ÄÈªû */
    cursor: pointer;  /* ‚≠ê Êñ∞Â¢ûÔºöÈ°ØÁ§∫ÂèØÈªûÊìä */
    transition: all 0.3s;  /* ‚≠ê Êñ∞Â¢ûÔºöÂπ≥ÊªëÈÅéÊ∏°ÊïàÊûú */
}

.signature-box:hover {
    border-color: #ffa502;  /* ‚≠ê Êñ∞Â¢ûÔºöhover ÊïàÊûú */
    background: #fffbf0;
}

.signature-box.signed {
    border-color: #2ed573;
    border-style: solid;
    color: #2ed573;
    font-weight: bold;
    font-style: normal;  /* ‚≠ê Êñ∞Â¢ûÔºöÁ∞ΩÂêçÂæå‰∏çË¶ÅÊñúÈ´î */
}

/* ‚≠ê Êñ∞Â¢ûÔºöStep Ê®ôÈ°åÊ®£ÂºèÂä†Âº∑ */
.checklist-step-name {
    flex: 1;
    font-weight: 600;  /* ‚≠ê Âä†Á≤ó */
    font-size: 1.1em;  /* ‚≠ê Âä†Â§ßÂ≠óÈ´î */
    display: flex;
    align-items: center;
    gap: 10px;
    color: #333;  /* ‚≠ê Ê∑±Ëâ≤ÊñáÂ≠ó */
}

.step-number {
    font-weight: bold;
    color: #ffa502;
    font-size: 1.05em;  /* ‚≠ê Á®çÂæÆÂä†Â§ß */
}

        /* ==================== Quiz System Styles ==================== */
.quiz-question-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    border-left: 5px solid #ffa502;
}

.quiz-question-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.quiz-question-number {
    font-size: 1.2em;
    font-weight: bold;
    color: #ffa502;
}

.quiz-question-score {
    background: #ffa502;
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: bold;
}

.quiz-question-text {
    font-size: 1.1em;
    margin-bottom: 20px;
    line-height: 1.6;
    color: #333;
}

.quiz-answer-area {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-top: 15px;
}

.quiz-option {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    margin: 8px 0;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.quiz-option:hover {
    border-color: #ffa502;
    background: #fffbf0;
}

.quiz-option.selected {
    border-color: #ffa502;
    background: #fff3cd;
}

.quiz-option.correct {
    border-color: #2ed573;
    background: #f0fff4;
}

.quiz-option.incorrect {
    border-color: #ff4757;
    background: #fff5f5;
}

.quiz-option input[type="checkbox"],
.quiz-option input[type="radio"] {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    cursor: pointer;
}

.quiz-sort-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    margin: 8px 0;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: move;
}

.quiz-sort-item .sort-number {
    width: 60px;
    padding: 8px;
    text-align: center;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    margin-right: 12px;
    background: #f0f0f0;
    font-size: 1em;
}

.quiz-sort-item .sort-text {
    flex: 1;
}

.quiz-result-summary {
    background: linear-gradient(135deg, #ffa502 0%, #ff9500 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    margin-bottom: 30px;
}

.quiz-result-summary.passed {
    background: linear-gradient(135deg, #2ed573 0%, #26d07c 100%);
}

.quiz-result-summary.failed {
    background: linear-gradient(135deg, #ff4757 0%, #e84118 100%);
}

.quiz-score-display {
    font-size: 3em;
    font-weight: bold;
    margin: 15px 0;
}

.quiz-status-badge {
    font-size: 1.5em;
    padding: 10px 20px;
    background: rgba(255,255,255,0.3);
    border-radius: 25px;
    display: inline-block;
    margin-top: 10px;
}

.quiz-grading-input {
    display: grid;
    grid-template-columns: 100px 1fr;
    gap: 15px;
    align-items: start;
    margin-top: 15px;
}

.quiz-grading-input input[type="number"] {
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1.1em;
    text-align: center;
}

.quiz-grading-input textarea {
    min-height: 80px;
    resize: vertical;
}

.quiz-record-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: all 0.3s;
    border-left: 5px solid #3b82f6;
}

.quiz-record-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
}

.quiz-record-card.pending {
    border-left-color: #f59e0b;
}

.quiz-record-card.graded {
    border-left-color: #2ed573;
}

.quiz-type-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: bold;
    margin-left: 10px;
}

.quiz-type-badge.fill {
    background: #e3f2fd;
    color: #1976d2;
}

.quiz-type-badge.choice {
    background: #f3e5f5;
    color: #7b1fa2;
}

.quiz-type-badge.sort {
    background: #fff3e0;
    color: #e65100;
}
        
    </style>
</head>
<body>
    <div class="container">
<!-- ÁôªÂÖ•È†ÅÈù¢ -->
<div id="loginPage" class="page active">
    <!-- ‚ú® Âä†ÂÖ• Logo ÂçÄÂüü ‚ú® -->
    <div style="text-center; margin-bottom: 30px;">
        <img src="imagestkoh-logo.png" 
             alt="Â∞áËªçÊæ≥ÈÜ´Èô¢" 
             style="max-width: 200px; height: auto; display: block; margin: 0 auto 20px auto; 
                    animation: logoFadeIn 1s ease-in; filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.1));">
    </div>
    
    <h1>TKOH A&OT Training & Quality Monitoring System</h1>
    <div class="login-form">
                <div class="input-group">
                    <label>üë§ Â∏≥Ëôü</label>
                    <input type="text" id="loginId" placeholder="Ë´ãËº∏ÂÖ•Â∏≥Ëôü">
                </div>
                <div class="input-group">
                    <label>üîí ÂØÜÁ¢º</label>
                    <input type="password" id="loginPw" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º">
                </div>
                <button class="btn btn-primary" onclick="login()">üöÄ ÁôªÂÖ•Á≥ªÁµ±</button>
                <div id="loginStatus" class="loading-message" style="display:none;"></div>
            </div>
        </div>

        <!-- ‰∏ªÈÅ∏ÂñÆÈ†ÅÈù¢ -->
        <div id="mainPage" class="page">
            <div class="top-bar">
                <div class="user-info">
                    <span id="userWelcome">üë§ Ê≠°ËøéÔºåÁ≥ªÁµ±ÁÆ°ÁêÜÂì°</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">üö™ ÁôªÂá∫</button>
            </div>

            <h2>üìã ‰∏ªÈÅ∏ÂñÆ</h2>
            <div class="menu-grid" id="mainMenu">
                <!-- ÂãïÊÖãÁîüÊàêÈÅ∏ÂñÆ -->
            </div>
        </div>

        <!-- Â∏≥Êà∂ÁÆ°ÁêÜÈ†ÅÈù¢ -->
        <div id="accountPage" class="page">
            <div class="top-bar">
                <h2>üë• Â∏≥Êà∂ÁÆ°ÁêÜÁ≥ªÁµ±</h2>
                <div>
                    <button class="btn btn-success" onclick="showAddAccountModal()">‚ûï Êñ∞Â¢ûÂ∏≥Êà∂</button>
                    <button class="btn btn-secondary" onclick="showPage('mainPage')">üîô ËøîÂõû</button>
                </div>
            </div>
            <div class="account-list" id="accountList">
                <!-- ÂãïÊÖãÁîüÊàêÂ∏≥Êà∂ÂàóË°® -->
            </div>
        </div>

        <!-- ÈÅ∏ÊìáÂüπË®ìÈ°ûÂûãÈ†ÅÈù¢ (PCA/OTA) -->
        <div id="selectTrainingTypePage" class="page">
            <div class="dashboard-header">
                <div class="dashboard-title">üìö Âì°Â∑•ÂüπË®ìË®òÈåÑ‰ªãÈù¢</div>
                <div class="dashboard-subtitle">Ë´ãÈÅ∏ÊìáÂüπË®ìÈ°ûÂûã</div>
            </div>
            <div style="text-align: right; margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="showPage('mainPage')">üîô ËøîÂõû‰∏ªÈÅ∏ÂñÆ</button>
            </div>
            <div class="training-type-selector">
                <div class="type-card" onclick="selectTrainingType('PCA')">
                    <div class="emoji">üßëüèª</div>
                    <div class="title">PCA ÂüπË®ì</div>
                </div>
                <div class="type-card" onclick="selectTrainingType('OTA')">
                    <div class="emoji">üíâ</div>
                    <div class="title">OTA ÂüπË®ì</div>
                </div>
            </div>
        </div>

        <!-- Âì°Â∑•ÂüπË®ìË®òÈåÑ‰ªãÈù¢ÔºàDashboard Ë®≠Ë®àÔºâ-->
        <div id="trainingManagePage" class="page">
            <div class="dashboard-header">
                <div class="dashboard-title" id="trainingTypeTitle">üìö Âì°Â∑•ÂüπË®ìË®òÈåÑ‰ªãÈù¢</div>
                <div class="dashboard-subtitle">ÂüπË®ìÁÆ°ÁêÜÁ≥ªÁµ±</div>
            </div>
            <div style="text-align: right; margin-bottom: 20px;">
                <button class="btn btn-success" onclick="showAddCategoryModal()">‚ûï Êñ∞Â¢ûÂüπË®ìÂàÜÈ°û</button>
                <button class="btn btn-secondary" onclick="showPage('selectTrainingTypePage')">üîô ËøîÂõûÈÅ∏Êìá</button>
            </div>
            <div class="training-dashboard" id="categoryDashboard">
                <!-- ÂãïÊÖãÁîüÊàêÂüπË®ìÂàÜÈ°ûÂç°Áâá -->
            </div>
        </div>

        <!-- ÂüπË®ìÂàÜÈ°ûË©≥ÊÉÖÈ†ÅÈù¢ -->
        <div id="categoryDetailPage" class="page">
            <div class="top-bar">
                <h2 id="categoryDetailTitle">ÂüπË®ìÈ†ÖÁõÆ</h2>
                <div>
                    <button class="btn btn-success btn-small" id="addItemBtn" onclick="showAddItemModal()">‚ûï Êñ∞Â¢ûÈ†ÖÁõÆ</button>
                    <button class="btn btn-secondary btn-small" onclick="backToDashboard()">üîô ËøîÂõû</button>
                </div>
            </div>
            <div id="categoryDetailContent">
                <!-- ÂãïÊÖãÁîüÊàêÂüπË®ìÈ†ÖÁõÆ -->
            </div>
        </div>

        <!-- Âì°Â∑•ÂüπË®ìË®òÈåÑÁ≥ªÁµ±È†ÅÈù¢ -->
        <div id="staffLevelPage" class="page">
            <div class="top-bar">
                <h2>üìä Âì°Â∑•ÂüπË®ìË®òÈåÑÁ≥ªÁµ±</h2>
                <button class="btn btn-secondary" onclick="showPage('mainPage')">üîô ËøîÂõû</button>
            </div>
            <div class="menu-grid">
                <div class="menu-card level-PCA1" onclick="showStaffList('PCA1')">
                    <div class="emoji">üôãüèª</div>
                    <div class="title">PCA1</div>
                </div>
                <div class="menu-card level-PCA2" onclick="showStaffList('PCA2')">
                    <div class="emoji">üôãüèª‚Äç‚ôÇÔ∏è</div>
                    <div class="title">PCA2</div>
                </div>
                <div class="menu-card level-PCA3" onclick="showStaffList('PCA3')">
                    <div class="emoji">üôãüèª‚Äç‚ôÄÔ∏è</div>
                    <div class="title">PCA3</div>
                </div>
                <div class="menu-card level-OTA" onclick="showStaffList('OTA')">
                    <div class="emoji">üíâ</div>
                    <div class="title">OTA</div>
                </div>
            </div>
        </div>

 <!-- Âì°Â∑•ÂàóË°®È†ÅÈù¢ -->
<div id="staffListPage" class="page">
    <div class="top-bar">
        <h2 id="staffListTitle">Âì°Â∑•ÂàóË°®</h2>
        <button class="btn btn-secondary" onclick="showPage('staffLevelPage')">üîô ËøîÂõû</button>
    </div>
    
    <!-- ‚≠ê Êñ∞Â¢ûÔºöÊêúÂ∞ãÊ°Ü ‚≠ê -->
    <div style="margin-bottom: 20px;">
        <div style="position: relative; max-width: 500px;">
            <input type="text" 
                   id="staffSearchInput" 
                   placeholder="üîç Ëº∏ÂÖ•Âêå‰∫ãÂêçÁ®±ÊêúÂ∞ã..." 
                   onkeyup="filterStaffList()"
                   style="width: 100%; 
                          padding: 12px 45px 12px 15px; 
                          border: 2px solid #ffa502; 
                          border-radius: 8px; 
                          font-size: 16px; 
                          transition: all 0.3s;
                          box-shadow: 0 2px 8px rgba(255, 165, 2, 0.2);">
            <span style="position: absolute; 
                         right: 15px; 
                         top: 50%; 
                         transform: translateY(-50%); 
                         font-size: 1.2em; 
                         color: #ffa502; 
                         pointer-events: none;">
                üîç
            </span>
        </div>
        <div id="staffSearchCount" style="margin-top: 8px; color: #666; font-size: 0.9em;"></div>
    </div>
    
    <div class="staff-grid" id="staffList">
        <!-- ÂãïÊÖãÁîüÊàêÂì°Â∑•ÂàóË°® -->
    </div>
    
    <!-- ‚≠ê Êñ∞Â¢ûÔºöÁÑ°ÁµêÊûúÊèêÁ§∫ ‚≠ê -->
    <div id="noStaffResults" style="display: none; text-align: center; padding: 40px; color: #999;">
        <div style="font-size: 3em; margin-bottom: 15px;">üîç</div>
        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 8px;">ÊêµÂîîÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÂòÖÂêå‰∫ã</div>
        <div style="font-size: 0.95em;">Ë©¶‰∏ãÁî®ÂÖ∂‰ªñÈóúÈçµÂ≠óÊêúÂ∞ã</div>
    </div>
</div>
        
        <!-- ÂüπË®ìÈÄ≤Â∫¶È†ÅÈù¢ÔºàDashboard Ë®≠Ë®àÔºâ-->
        <div id="trainingProgressPage" class="page">
            <div class="dashboard-header">
                <div class="dashboard-title" id="progressStaffName">ÂüπË®ìÈÄ≤Â∫¶</div>
                <div class="dashboard-subtitle">Training Progress Dashboard</div>
            </div>
            <div style="text-align: right; margin-bottom: 20px;">
                <button class="btn btn-info btn-small" onclick="exportToPDF()">üìÑ ÂåØÂá∫ PDF</button>
                <button class="btn btn-secondary btn-small" onclick="backToStaffList()">üîô ËøîÂõûÂì°Â∑•ÂàóË°®</button>
            </div>

            <!-- ÈáçË¶ÅË©ïÊ†∏ÊôÇÈñìË°® -->
            <div class="important-timeline" id="importantTimeline" style="display:none;">
                <div class="timeline-header">
                    ‚è∞ ÈáçË¶ÅË©ïÊ†∏ÊôÇÈñìË°®
                </div>
                <div class="timeline-items" id="timelineItems">
                    <!-- ÂãïÊÖãÁîüÊàêÊôÇÈñìË°®È†ÖÁõÆ -->
                </div>
            </div>

            <div class="training-dashboard" id="trainingProgress">
                <!-- ÂãïÊÖãÁîüÊàêÂüπË®ìÈÄ≤Â∫¶Âç°Áâá -->
            </div>
        </div>

      <!-- ÂüπË®ìÈ†ÖÁõÆË©ïÊ†∏È†ÅÈù¢ -->
        <div id="itemEvaluationPage" class="page">
            <div class="top-bar">
                <h2 id="evaluationCategoryTitle">ÂüπË®ìÈ†ÖÁõÆË©ïÊ†∏</h2>
                <button class="btn btn-secondary btn-small" onclick="backToProgress()">üîô ËøîÂõûÈÄ≤Â∫¶</button>
            </div>
            <div id="evaluationContent">
                <!-- ÂãïÊÖãÁîüÊàêË©ïÊ†∏ÂÖßÂÆπ -->
            </div>
        </div>

        <!-- ‚Üì‚Üì‚Üì ADD ALL THE NEW PAGES HERE ‚Üì‚Üì‚Üì -->

<!-- Ë≥™ÈáèÁõ£Ê∏¨Á≥ªÁµ±‰∏ªÈ†Å (AuditBoard Style) -->
<div id="auditMainPage" class="page">
    <!-- Dashboard Header -->
    <div class="audit-dashboard-header">
        <div class="audit-dashboard-title">üìã Ë≥™ÈáèÁõ£Ê∏¨Á≥ªÁµ±(ÈñãÁôº‰∏≠)</div>
        <div class="audit-dashboard-subtitle">Decontamination Area Quality Monitoring Dashboard</div>
    </div>

    <!-- Return Button -->
    <div style="text-align: right; margin-bottom: 20px;">
        <button class="btn btn-secondary" onclick="showPage('mainPage')">üîô ËøîÂõû‰∏ªÈÅ∏ÂñÆ</button>
    </div>

    <!-- Statistics Cards -->
    <div class="audit-stats-grid" id="auditStatsGrid">
        <div class="audit-stat-card">
            <div class="audit-stat-icon">
                <span>üìä</span>
                <span style="font-size: 0.4em; color: #3b82f6;">‚óè</span>
            </div>
            <div class="audit-stat-value" id="statTotalAudits">0</div>
            <div class="audit-stat-label">Á∏ΩÂØ©Ê†∏Ê¨°Êï∏</div>
        </div>

        <div class="audit-stat-card success">
            <div class="audit-stat-icon">
                <span>‚úÖ</span>
                <span style="font-size: 0.4em; color: #10b981;">‚ñ≤</span>
            </div>
            <div class="audit-stat-value" id="statPassRate" style="color: #10b981;">0%</div>
            <div class="audit-stat-label">Âπ≥ÂùáÂêàÊ†ºÁéá</div>
            <div class="audit-stat-trend" id="statTrend">Êú¨ÊúàË°®ÁèæËâØÂ•Ω</div>
        </div>

        <div class="audit-stat-card warning">
            <div class="audit-stat-icon">
                <span>üìÖ</span>
            </div>
            <div class="audit-stat-value" id="statThisMonth" style="color: #f59e0b;">0</div>
            <div class="audit-stat-label">Êú¨ÊúàÂØ©Ê†∏Ê¨°Êï∏</div>
        </div>

        <div class="audit-stat-card danger">
            <div class="audit-stat-icon">
                <span>‚ö†Ô∏è</span>
            </div>
            <div class="audit-stat-value" id="statFailCount" style="color: #ef4444;">0</div>
            <div class="audit-stat-label">‰∏çÂêàÊ†ºÊ¨°Êï∏</div>
        </div>
    </div>

    <!-- Action Cards -->
    <div class="audit-action-cards">
        <div class="audit-action-card" onclick="startNewAudit()">
            <div class="audit-action-icon">‚ûï</div>
            <div class="audit-action-title">Êñ∞Â¢ûÁõ£Ê∏¨Ë®òÈåÑ</div>
            <div class="audit-action-desc">ÈñãÂßãÊñ∞ÁöÑË≥™ÈáèÁõ£Ê∏¨ÂØ©Ê†∏</div>
        </div>

        <div class="audit-action-card secondary" onclick="viewAuditHistory()">
            <div class="audit-action-icon">üìä</div>
            <div class="audit-action-title">Ê≠∑Âè≤Ë®òÈåÑ</div>
            <div class="audit-action-desc">Êü•ÁúãÊâÄÊúâÂØ©Ê†∏Ë®òÈåÑ</div>
        </div>
    </div>

    <!-- Recent Audits Preview -->
    <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 3px 15px rgba(0,0,0,0.05);">
        <h3 style="color: #1e293b; margin-bottom: 20px; font-size: 1.3em;">üìå ÊúÄËøëÂØ©Ê†∏Ë®òÈåÑ</h3>
        <div id="recentAuditsPreview">
            <div class="loading-message">ËºâÂÖ•‰∏≠...</div>
        </div>
    </div>
</div>

        <!-- ÈÅ∏ÊìáÁõ£Ê∏¨Âú∞Èªû -->
        <div id="selectLocationPage" class="page">
            <div class="top-bar">
                <h2>üìç ÈÅ∏ÊìáÁõ£Ê∏¨Âú∞Èªû</h2>
                <button class="btn btn-secondary" onclick="showPage('auditMainPage')">üîô ËøîÂõû</button>
            </div>
            <div class="location-selector">
                <div class="location-card" onclick="selectLocation('2F_DA')">
                    <div style="font-size: 3em; margin-bottom: 10px;">üè•</div>
                    <div style="font-size: 1.5em; font-weight: bold;">2/F DA</div>
                    <div style="margin-top: 10px; opacity: 0.9;">2Ê®ìÂéªÊ±°ÂçÄ</div>
                </div>
                <div class="location-card" onclick="selectLocation('LGF_DA')">
                    <div style="font-size: 3em; margin-bottom: 10px;">üè¢</div>
                    <div style="font-size: 1.5em; font-weight: bold;">LG/F DA</div>
                    <div style="margin-top: 10px; opacity: 0.9;">Âú∞Â∫´ÂéªÊ±°ÂçÄ</div>
                </div>
            </div>
        </div>

        <!-- ÂØ©Ê†∏Ë°®Ê†ºÈ†ÅÈù¢ -->
        <div id="auditFormPage" class="page">
            <div class="top-bar">
                <h2 id="auditFormTitle">Ê∂àÊØíË≥™ÈáèÁõ£Ê∏¨ (ÂéªÊ±°ÂçÄ)</h2>
                <div>
                    <button class="btn btn-success" onclick="saveAuditDraft()">üíæ ÂÑ≤Â≠òËçâÁ®ø</button>
                    <button class="btn btn-secondary" onclick="cancelAudit()">‚ùå ÂèñÊ∂à</button>
                </div>
            </div>
            <div id="auditFormContent">
                <!-- ÂãïÊÖãÁîüÊàêÂØ©Ê†∏Ë°®Ê†º -->
            </div>
            <div class="evaluation-actions">
                <button class="btn btn-success" style="flex: 1;" onclick="submitAudit()">‚úÖ Êèê‰∫§ÂØ©Ê†∏</button>
            </div>
        </div>

 <!-- Ê≠∑Âè≤Ë®òÈåÑÈ†ÅÈù¢ (AuditBoard Style) -->
<div id="auditHistoryPage" class="page">
    <div class="audit-dashboard-header">
        <div class="audit-dashboard-title">üìä Ë≥™ÈáèÁõ£Ê∏¨Ê≠∑Âè≤Ë®òÈåÑ</div>
        <div class="audit-dashboard-subtitle">Audit History & Reports</div>
    </div>

    <div style="text-align: right; margin-bottom: 20px;">
        <button class="btn btn-secondary" onclick="showPage('auditMainPage')">üîô ËøîÂõû</button>
    </div>

    <div class="audit-history-grid" id="auditHistoryContent">
        <!-- ÂãïÊÖãÁîüÊàêÊ≠∑Âè≤Ë®òÈåÑ -->
    </div>
</div>

        <!-- ÂØ©Ê†∏Ë©≥ÊÉÖÈ†ÅÈù¢ -->
        <div id="auditDetailPage" class="page">
            <div class="top-bar">
                <h2 id="auditDetailTitle">ÂØ©Ê†∏Ë©≥ÊÉÖ</h2>
                <div>
                    <button class="btn btn-info btn-small" onclick="exportAuditToPDF()">üìÑ ÂåØÂá∫ PDF</button>
                    <button class="btn btn-secondary btn-small" onclick="showPage('auditHistoryPage')">üîô ËøîÂõû</button>
                </div>
            </div>
            <div id="auditDetailContent">
                <!-- ÂãïÊÖãÁîüÊàêÂØ©Ê†∏Ë©≥ÊÉÖ -->
            </div>
        </div>

        <!-- Quiz ‰∏ªÈÅ∏ÂñÆÈ†ÅÈù¢ -->
<div id="quizMainPage" class="page">
    <div class="dashboard-header">
        <div class="dashboard-title">üìù Quiz Ê∏¨È©óÁ≥ªÁµ±</div>
        <div class="dashboard-subtitle">Training Assessment & Quiz Management</div>
    </div>
    <div style="text-align: right; margin-bottom: 20px;">
        <button class="btn btn-success" onclick="showAddQuizCategoryModal()" id="addQuizCategoryBtn" style="display:none;">‚ûï Êñ∞Â¢ûÊ∏¨È©óÂàÜÈ°û</button>
        <button class="btn btn-secondary" onclick="showPage('mainPage')">üîô ËøîÂõû‰∏ªÈÅ∏ÂñÆ</button>
    </div>
    <div class="training-dashboard" id="quizCategoryDashboard">
        <!-- ÂãïÊÖãÁîüÊàêÊ∏¨È©óÂàÜÈ°ûÂç°Áâá -->
    </div>
</div>

<!-- Quiz ÂàÜÈ°ûË©≥ÊÉÖÈ†ÅÈù¢ÔºàÈ°åÁõÆÁÆ°ÁêÜÔºâ-->
<div id="quizCategoryDetailPage" class="page">
    <div class="top-bar">
        <h2 id="quizCategoryDetailTitle">Ê∏¨È©óÈ°åÁõÆÁÆ°ÁêÜ</h2>
        <div>
            <button class="btn btn-success btn-small" onclick="showAddQuizItemModal()" id="addQuizItemBtn" style="display:none;">‚ûï Êñ∞Â¢ûÈ°åÁõÆ</button>
            <button class="btn btn-secondary btn-small" onclick="backToQuizDashboard()">üîô ËøîÂõû</button>
        </div>
    </div>
    <div id="quizCategoryDetailContent">
        <!-- ÂãïÊÖãÁîüÊàêÈ°åÁõÆÂàóË°® -->
    </div>
</div>

<!-- Quiz Á≠îÈ°åÈ†ÅÈù¢ÔºàÂì°Â∑•‰ΩúÁ≠îÔºâ-->
<div id="quizTakingPage" class="page">
    <div class="top-bar">
        <h2 id="quizTakingTitle">Quiz Ê∏¨È©ó</h2>
        <div>
            <button class="btn btn-success" onclick="submitQuizAnswers()">‚úÖ Êèê‰∫§Ê∏¨È©ó</button>
            <button class="btn btn-secondary" onclick="cancelQuizTaking()">‚ùå ÂèñÊ∂à</button>
        </div>
    </div>
    <div id="quizTakingContent">
        <!-- ÂãïÊÖãÁîüÊàêÁ≠îÈ°åË°®ÂñÆ -->
    </div>
</div>

<!-- Quiz ÊâπÊîπÈ†ÅÈù¢Ôºà‰∏ªÁÆ°ÊâπÊîπÔºâ-->
<div id="quizGradingPage" class="page">
    <div class="top-bar">
        <h2 id="quizGradingTitle">ÊâπÊîπÊ∏¨È©ó</h2>
        <div>
            <button class="btn btn-success" onclick="submitQuizGrade()">‚úÖ ÂÆåÊàêÊâπÊîπ</button>
            <button class="btn btn-secondary" onclick="backToQuizRecords()">üîô ËøîÂõû</button>
        </div>
    </div>
    <div id="quizGradingContent">
        <!-- ÂãïÊÖãÁîüÊàêÊâπÊîπ‰ªãÈù¢ -->
    </div>
</div>

<!-- Quiz Ë®òÈåÑÂàóË°®È†ÅÈù¢ -->
<div id="quizRecordsPage" class="page">
    <div class="dashboard-header">
        <div class="dashboard-title" id="quizRecordsTitle">Ê∏¨È©óË®òÈåÑ</div>
        <div class="dashboard-subtitle">Quiz Records & Results</div>
    </div>
    <div style="text-align: right; margin-bottom: 20px;">
        <button class="btn btn-secondary" onclick="backToQuizDashboard()">üîô ËøîÂõû</button>
    </div>
    <div id="quizRecordsContent">
        <!-- ÂãïÊÖãÁîüÊàêË®òÈåÑÂàóË°® -->
    </div>
</div>

<!-- Quiz ÁµêÊûúË©≥ÊÉÖÈ†ÅÈù¢ -->
<div id="quizResultPage" class="page">
    <div class="top-bar">
        <h2 id="quizResultTitle">Ê∏¨È©óÁµêÊûú</h2>
        <button class="btn btn-secondary" onclick="backToQuizRecords()">üîô ËøîÂõû</button>
    </div>
    <div id="quizResultContent">
        <!-- ÂãïÊÖãÁîüÊàêÁµêÊûúË©≥ÊÉÖ -->
    </div>
</div>
    </div>  

    <!-- ÂΩàÂá∫Ë¶ñÁ™ó -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Ê®ôÈ°å</div>
            <div id="modalBody">
                <!-- ÂãïÊÖãÂÖßÂÆπ -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // ==================== Firebase ÂàùÂßãÂåñ ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDDkALOTGl6fZunGU_Xd5FOy45WnXZWT8E",
            authDomain: "tkoh-ot-training-system.firebaseapp.com",
            projectId: "tkoh-ot-training-system",
            storageBucket: "tkoh-ot-training-system.firebasestorage.app",
            messagingSenderId: "1027139549127",
            appId: "1:1027139549127:web:b987293382058a54d08be2"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ==================== ÂÖ®ÂüüËÆäÊï∏ ====================
        let currentUser = null;
        let currentStaffLevel = '';
        let currentStaffId = '';
        let currentCategoryId = '';
        let currentTrainingType = ''; // 'PCA' Êàñ 'OTA'
        let selectedEmoji = 'üìö';
        let systemInitialized = false;
        let checklistSteps = [];

        // ==================== Ê¨äÈôêÊ™¢Êü•ÂáΩÊï∏ ====================
// ‚≠ê‚≠ê‚≠ê Êñ∞Â¢ûÔºöÊ™¢Êü•Áî®Êà∂ÊòØÂê¶ÊúâÊ¨äÈôêÁ∑®ËºØË®ìÁ∑¥Ë®òÈåÑ ‚≠ê‚≠ê‚≠ê
function canEditTrainingRecord(categoryName, targetStaffLevel) {
    // 1. Admin & Supervisor Ê∞∏ÈÅ†ÊúâÊ¨äÈôê
    if (currentUser.role === 'admin' || currentUser.role === 'supervisor') {
        return true;
    }
    
    // 2. PCA1 Âì°Â∑•Âè™ËÉΩÁÇ∫ PCA2 & PCA3 Á∑®ËºØ„ÄêÊñ∞ÂÖ•ËÅ∑PCA Èô™Â∏∂Ë®ìÁ∑¥Ë®òÈåÑ„Äë
    if (currentUser.role === 'staff' && currentUser.level === 'PCA1') {
        // ÂøÖÈ†à‰øÇ„ÄêÊñ∞ÂÖ•ËÅ∑PCA Èô™Â∏∂Ë®ìÁ∑¥Ë®òÈåÑ„ÄëÂàÜÈ°û
        const isNewStaffTraining = categoryName.includes('Êñ∞ÂÖ•ËÅ∑') || 
                                   categoryName.includes('Èô™Â∏∂') || 
                                   categoryName.includes('PCA');
        
        // ÁõÆÊ®ôÂì°Â∑•ÂøÖÈ†à‰øÇ PCA2 Êàñ PCA3
        const isTargetPCA2or3 = targetStaffLevel === 'PCA2' || targetStaffLevel === 'PCA3';
        
        return isNewStaffTraining && isTargetPCA2or3;
    }
    
    // 3. ÂÖ∂‰ªñÊÉÖÊ≥Å‰∏ÄÂæãÁÑ°Ê¨äÈôê
    return false;
}
        
        // ==================== Emoji ÂàóË°® ====================
        const EMOJI_LIST = [
            'üìö', 'üìñ', 'üìù', 'üìã', 'üìä', 'üìà', 'üìâ', 'üìÑ', 'üìÉ', 'üìë',
            'üõ°Ô∏è', '‚öîÔ∏è', 'üî∞', 'üéØ', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', 'üèÖ', 'üéñÔ∏è',
            'üíº', 'üíª', '‚å®Ô∏è', 'üñ•Ô∏è', 'üñ®Ô∏è', 'üì±', 'üì≤', '‚òéÔ∏è', 'üìû', 'üìü',
            '‚öïÔ∏è', 'ü©∫', 'üíä', 'üíâ', 'ü©π', 'ü©º', 'ü¶∑', 'üß¨', 'üî¨', 'üî≠',
            'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è', '‚öôÔ∏è', 'üî©', '‚ö°', 'üîå', 'üí°', 'üî¶',
            'üéì', 'üéí', 'üìê', 'üìè', '‚úèÔ∏è', '‚úíÔ∏è', 'üñäÔ∏è', 'üñçÔ∏è', 'üñåÔ∏è', 'üñãÔ∏è',
            'üåü', '‚≠ê', '‚ú®', 'üí´', 'üå†', 'üéÜ', 'üéá', 'üéâ', 'üéä', 'üéà',
            'üîë', 'üóùÔ∏è', 'üîê', 'üîí', 'üîì', 'üîè', 'üóÑÔ∏è', 'üóÇÔ∏è', 'üìÅ', 'üìÇ',
            'üßº', 'üßπ', 'üßΩ', 'üß¥', 'üß™', 'üß´', 'ü©∏', 'üíâ', 'üî¨', 'üî≠',
            'üè•', 'üè®', 'üè¢', 'üèõÔ∏è', 'üèóÔ∏è', 'üè≠', 'üè¨', 'üè™', 'üè©', 'üè¶',
            'üîç', 'üîé', 'üì°', 'üìª', 'üì∫', 'üìπ', 'üì∑', 'üì∏', 'üé¨', 'üé§',
            'üî•', 'üíß', 'üåä', '‚ùÑÔ∏è', '‚òÄÔ∏è', 'üåô', 'ü§ñ', 'üßΩ', 'üóÑÔ∏è', '‚úîÔ∏è'
        ];

        // ==================== ÂàùÂßãÂåñÁ≥ªÁµ± ====================
        async function initializeSystem() {
            if (systemInitialized) return;
            
            try {
                console.log('üîß ÈñãÂßãÂàùÂßãÂåñÁ≥ªÁµ±...');
                
                const adminSnapshot = await db.collection('accounts')
                    .where('id', '==', 'tkohot')
                    .limit(1)
                    .get();
                
                if (adminSnapshot.empty) {
                    console.log('üìù ÂâµÂª∫Á≥ªÁµ±ÁÆ°ÁêÜÂì°Â∏≥Êà∂...');
                    await db.collection('accounts').add({
                        id: 'tkohot',
                        password: 'A123456*#',
                        name: 'Á≥ªÁµ±ÁÆ°ÁêÜÂì°',
                        role: 'admin',
                        level: 'ADMIN',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úÖ Á≥ªÁµ±ÁÆ°ÁêÜÂì°Â∏≥Êà∂Â∑≤ÂâµÂª∫');
                }

                systemInitialized = true;
                console.log('‚úÖ Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàê');
            } catch (error) {
                console.error('‚ùå Á≥ªÁµ±ÂàùÂßãÂåñÂ§±Êïó:', error);
                showToast('‚ö†Ô∏è Á≥ªÁµ±ÂàùÂßãÂåñ‰∏≠ÔºåË´ãÁ®çÂæåÂÜçË©¶', 'warning');
            }
        }

        window.addEventListener('load', () => {
            initializeSystem();
        });

        // ==================== ÁôªÂÖ•Á≥ªÁµ± ====================
        async function login() {
            const id = document.getElementById('loginId').value.trim();
            const pw = document.getElementById('loginPw').value;
            const statusDiv = document.getElementById('loginStatus');

            if (!id || !pw) {
                showToast('‚ùå Ë´ãËº∏ÂÖ•Â∏≥ËôüÂíåÂØÜÁ¢º', 'error');
                return;
            }

            try {
                statusDiv.style.display = 'block';
                statusDiv.textContent = 'üîç Ê≠£Âú®È©óË≠â...';

                await initializeSystem();

                const accountsSnapshot = await db.collection('accounts')
                    .where('id', '==', id)
                    .limit(1)
                    .get();

                if (!accountsSnapshot.empty) {
                    const doc = accountsSnapshot.docs[0];
                    const account = doc.data();
                    
                    if (account.password === pw) {
                        currentUser = { docId: doc.id, ...account };
                        
                        statusDiv.style.display = 'none';
                        showToast(`‚úÖ Ê≠°ËøéÔºå${currentUser.name}ÔºÅ`, 'success');
                        showMainPage();
                    } else {
                        statusDiv.style.display = 'none';
                        showToast('‚ùå Â∏≥ËôüÊàñÂØÜÁ¢ºÈåØË™§', 'error');
                    }
                } else {
                    statusDiv.style.display = 'none';
                    showToast('‚ùå Â∏≥ËôüÊàñÂØÜÁ¢ºÈåØË™§', 'error');
                }
            } catch (error) {
                console.error('‚ùå ÁôªÂÖ•ÈåØË™§:', error);
                statusDiv.style.display = 'none';
                showToast('‚ùå ÁôªÂÖ•Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

        // ==================== ÁôªÂá∫Á≥ªÁµ± ====================
        function logout() {
            if (confirm('‚ùì Á¢∫ÂÆöË¶ÅÁôªÂá∫ÂóéÔºü')) {
                currentUser = null;
                document.getElementById('loginId').value = '';
                document.getElementById('loginPw').value = '';
                showPage('loginPage');
                showToast('üëã Â∑≤ÁôªÂá∫Á≥ªÁµ±', 'success');
            }
        }

        // ==================== È°ØÁ§∫‰∏ªÈÅ∏ÂñÆ ====================
        function showMainPage() {
            const welcomeText = document.getElementById('userWelcome');
            welcomeText.textContent = `üë§ Ê≠°ËøéÔºå${currentUser.name}`;

            const menuHtml = [];

            if (currentUser.role === 'admin' || currentUser.role === 'supervisor') {
                menuHtml.push(`
                    <div class="menu-card" onclick="showPage('staffLevelPage')">
                        <div class="emoji">üìä</div>
                        <div class="title">Âì°Â∑•ÂüπË®ìË®òÈåÑÁ≥ªÁµ±</div>
                    </div>
                `);
} else if (currentUser.role === 'staff') {
    menuHtml.push(`
        <div class="menu-card" onclick="viewMyProgress()">
            <div class="emoji">üìà</div>
            <div class="title">ÊàëÁöÑÂüπË®ìÈÄ≤Â∫¶</div>
        </div>
    `);
    
    // ‚≠ê‚≠ê‚≠ê Êñ∞Â¢ûÔºöPCA1 Âì°Â∑•ÂèØ‰ª•ÁÇ∫ PCA2 & PCA3 ÂÅöÈô™Â∏∂Ë®ìÁ∑¥Ë®òÈåÑ ‚≠ê‚≠ê‚≠ê
    if (currentUser.level === 'PCA1') {
        menuHtml.push(`
            <div class="menu-card" onclick="showPCA1MentorMenu()">
                <div class="emoji">üë®‚Äçüè´</div>
                <div class="title">Èô™Â∏∂Ë®ìÁ∑¥Ë®òÈåÑ<br><small style="font-size: 0.75em; opacity: 0.9;">(ÁÇ∫ PCA2/PCA3)</small></div>
            </div>
        `);
    }
}

            if (currentUser.role === 'admin') {
                menuHtml.push(`
                    <div class="menu-card" onclick="showAccountManage()">
                        <div class="emoji">üë•</div>
                        <div class="title">Â∏≥Êà∂ÁÆ°ÁêÜÁ≥ªÁµ±</div>
                    </div>
                `);
            }

// ‚≠ê ÈñãÊîæÁµ¶ admin Âíå supervisor
if (currentUser.role === 'admin' || currentUser.role === 'supervisor') {
    menuHtml.push(`
        <div class="menu-card" onclick="showPage('auditMainPage')">
            <div class="emoji">üìã</div>
            <div class="title">Ë≥™ÈáèÁõ£Ê∏¨Á≥ªÁµ±</div>
        </div>
    `);
}

            if (currentUser.role === 'admin') {
                menuHtml.push(`
                    <div class="menu-card" onclick="showPage('selectTrainingTypePage')">
                        <div class="emoji">üìö</div>
                        <div class="title">Âì°Â∑•ÂüπË®ìË®òÈåÑ‰ªãÈù¢</div>
                    </div>
                `);
            }

            // ‚≠ê‚≠ê‚≠ê Êñ∞Â¢ûÔºöQuiz Ê∏¨È©óÁ≥ªÁµ±ÂÖ•Âè£ ‚≠ê‚≠ê‚≠ê
if (currentUser.role === 'admin' || currentUser.role === 'supervisor') {
    menuHtml.push(`
        <div class="menu-card" onclick="showQuizMain()">
            <div class="emoji">üìù</div>
            <div class="title">Quiz Ê∏¨È©óÁ≥ªÁµ±</div>
        </div>
    `);
} else if (currentUser.role === 'staff') {
    menuHtml.push(`
        <div class="menu-card" onclick="showQuizMain()">
            <div class="emoji">‚úçÔ∏è</div>
            <div class="title">ÊàëÁöÑ Quiz Ê∏¨È©ó</div>
        </div>
    `);
}
            
            document.getElementById('mainMenu').innerHTML = menuHtml.join('');
            showPage('mainPage');
        }

        // ==================== ÈÅ∏ÊìáÂüπË®ìÈ°ûÂûã ====================
        function selectTrainingType(type) {
            currentTrainingType = type;
            showTrainingManage();
        }

        // ==================== Âì°Â∑•Êü•ÁúãËá™Â∑±ÁöÑÈÄ≤Â∫¶ ====================
        function viewMyProgress() {
            currentStaffId = currentUser.docId;
            showTrainingProgress(currentStaffId);
        }

        // ==================== È°ØÁ§∫Â∏≥Êà∂ÁÆ°ÁêÜ ====================
        async function showAccountManage() {
            showPage('accountPage');
            await loadAccounts();
        }

// ==================== ËºâÂÖ•Â∏≥Êà∂ÂàóË°® ====================
async function loadAccounts() {
    try {
        const accountsSnapshot = await db.collection('accounts').get();
        
        // ‚≠ê ÂÆöÁæ©ËÅ∑Á¥öÊéíÂ∫èÈ†ÜÂ∫è
        const levelOrder = { 'WM': 1, 'APN': 2, 'RN': 3, 'PCA1': 4, 'PCA2': 5, 'PCA3': 6, 'OTA': 7 };
        
        // ‚≠ê Êî∂ÈõÜÊâÄÊúâÂ∏≥Êà∂‰∏¶ÈÅéÊøæÊéâ admin
        const accounts = [];
        accountsSnapshot.forEach(doc => {
            const account = doc.data();
            if (account.role !== 'admin') {
                accounts.push({ docId: doc.id, ...account });
            }
        });
        
        // ‚≠ê ÊåâËÅ∑Á¥öÊéíÂ∫è
        accounts.sort((a, b) => {
            const orderA = levelOrder[a.level] || 999;
            const orderB = levelOrder[b.level] || 999;
            return orderA - orderB;
        });
        
        // ‚≠ê ÊåâËÅ∑Á¥öÂàÜÁµÑ
        const groupedAccounts = {};
        accounts.forEach(account => {
            if (!groupedAccounts[account.level]) {
                groupedAccounts[account.level] = [];
            }
            groupedAccounts[account.level].push(account);
        });
        
        const accountListHtml = [];
        
        // ‚≠ê ÊåâÈ†ÜÂ∫èÈ°ØÁ§∫ÊØèÂÄãËÅ∑Á¥ö
        ['WM', 'APN', 'RN', 'PCA1', 'PCA2', 'PCA3', 'OTA'].forEach(level => {
            if (groupedAccounts[level] && groupedAccounts[level].length > 0) {
                // ËÅ∑Á¥öÊ®ôÈ°å
                accountListHtml.push(`
                    <div style="background: rgba(255, 165, 2, 0.1); padding: 12px 20px; 
                                border-radius: 10px; margin: 20px 0 10px 0; 
                                border-left: 4px solid #ffa502;">
                        <h3 style="color: #ffa502; margin: 0; font-size: 1.2em;">
                            üìã ${level} (${groupedAccounts[level].length} ‰Ωç)
                        </h3>
                    </div>
                `);
                
                // Ë©≤ËÅ∑Á¥öÁöÑÂ∏≥Êà∂ÂàóË°®
                groupedAccounts[level].forEach(account => {
                    const roleBadge = account.role === 'supervisor' 
                        ? '<span class="badge badge-supervisor">üëî ‰∏ªÁÆ°</span>'
                        : '<span class="badge badge-staff">üë§ Âì°Â∑•</span>';

                    const levelBadge = `<span class="badge badge-${account.level}">${account.level}</span>`;

                    accountListHtml.push(`
                        <div class="account-item">
                            <div class="account-info">
                                <div class="name">üë§ ${account.name} ${roleBadge} ${levelBadge}</div>
                                <div class="details">
                                    üìã Â∏≥Ëôü: ${account.id} | üìÖ ÂÖ•ËÅ∑Êó•Êúü: ${account.joinDate || 'Êú™Ë®≠ÂÆö'}
                                </div>
                            </div>
                            <div class="account-actions">
                                <button class="btn btn-danger btn-small" onclick="deleteAccount('${account.docId}', '${account.name}')">üóëÔ∏è Âà™Èô§</button>
                            </div>
                        </div>
                    `);
                });
            }
        });

        if (accountListHtml.length === 0) {
            accountListHtml.push('<p class="no-data-message">üì≠ Â∞öÁÑ°ÂÖ∂‰ªñÂ∏≥Êà∂</p>');
        }

        document.getElementById('accountList').innerHTML = accountListHtml.join('');
    } catch (error) {
        console.error('ËºâÂÖ•Â∏≥Êà∂Â§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â∏≥Êà∂Â§±Êïó', 'error');
    }
}

        // ==================== È°ØÁ§∫Êñ∞Â¢ûÂ∏≥Êà∂Ë¶ñÁ™ó ====================
        function showAddAccountModal() {
            const modalBody = `
                <div class="input-group">
                    <label>üë§ ÂßìÂêç</label>
                    <input type="text" id="newAccountName" placeholder="Ë´ãËº∏ÂÖ•ÂßìÂêç">
                </div>
                <div class="input-group">
                    <label>üìä Áî®Êà∂ËÅ∑Á¥ö</label>
                    <select id="newAccountLevel" onchange="updateRoleOptions()">
                        <option value="">Ë´ãÈÅ∏ÊìáËÅ∑Á¥ö</option>
                        <option value="WM">WM (ÁóÖÊàøÁ∂ìÁêÜ)</option>
                        <option value="APN">APN (Ë≥áÊ∑±Ë≠∑Â∏´)</option>
                        <option value="RN">RN (Ë®ªÂÜäË≠∑Â£´)</option>
                        <option value="PCA1">PCA1</option>
                        <option value="PCA2">PCA2</option>
                        <option value="PCA3">PCA3</option>
                        <option value="OTA">OTA</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>üëî Áî®Êà∂ËßíËâ≤</label>
                    <select id="newAccountRole" disabled>
                        <option value="">Ë´ãÂÖàÈÅ∏ÊìáËÅ∑Á¥ö</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>üìÖ ÂÖ•ËÅ∑Êó•Êúü</label>
                    <input type="date" id="newAccountJoinDate">
                </div>
                <div class="input-group">
                    <label>üîë ÁôªÂÖ•Â∏≥Ëôü</label>
                    <input type="text" id="newAccountId" placeholder="Ë´ãËº∏ÂÖ•ÁôªÂÖ•Â∏≥Ëôü">
                </div>
                <div class="input-group">
                    <label>üîí ÁôªÂÖ•ÂØÜÁ¢º</label>
                    <input type="password" id="newAccountPw" placeholder="Ë´ãËº∏ÂÖ•ÁôªÂÖ•ÂØÜÁ¢º">
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-success" onclick="createAccount()">‚úÖ Êñ∞Â¢û</button>
                    <button class="btn btn-secondary" onclick="closeModal()">‚ùå ÂèñÊ∂à</button>
                </div>
            `;

            showModal('‚ûï Êñ∞Â¢ûÂ∏≥Êà∂', modalBody);
        }

        // ==================== Êõ¥Êñ∞ËßíËâ≤ÈÅ∏È†Ö ====================
        function updateRoleOptions() {
            const level = document.getElementById('newAccountLevel').value;
            const roleSelect = document.getElementById('newAccountRole');

            if (!level) {
                roleSelect.disabled = true;
                roleSelect.innerHTML = '<option value="">Ë´ãÂÖàÈÅ∏ÊìáËÅ∑Á¥ö</option>';
                return;
            }

            roleSelect.disabled = false;

            if (['WM', 'APN', 'RN'].includes(level)) {
                roleSelect.innerHTML = '<option value="supervisor">üëî ‰∏ªÁÆ°</option>';
            } else if (['PCA1', 'PCA2', 'PCA3', 'OTA'].includes(level)) {
                roleSelect.innerHTML = '<option value="staff">üë§ Âì°Â∑•</option>';
            }
        }

        // ==================== ÂâµÂª∫Â∏≥Êà∂ ====================
        async function createAccount() {
            const name = document.getElementById('newAccountName').value.trim();
            const level = document.getElementById('newAccountLevel').value;
            const role = document.getElementById('newAccountRole').value;
            const joinDate = document.getElementById('newAccountJoinDate').value;
            const id = document.getElementById('newAccountId').value.trim();
            const pw = document.getElementById('newAccountPw').value;

            if (!name || !level || !role || !joinDate || !id || !pw) {
                showToast('‚ùå Ë´ãÂ°´ÂØ´ÊâÄÊúâÊ¨Ñ‰Ωç', 'error');
                return;
            }

            try {
                const existingSnapshot = await db.collection('accounts')
                    .where('id', '==', id)
                    .limit(1)
                    .get();

                if (!existingSnapshot.empty) {
                    showToast('‚ùå Ê≠§Â∏≥ËôüÂ∑≤Â≠òÂú®', 'error');
                    return;
                }

                await db.collection('accounts').add({
                    id: id,
                    password: pw,
                    name: name,
                    role: role,
                    level: level,
                    joinDate: joinDate,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('‚úÖ Â∏≥Êà∂Êñ∞Â¢ûÊàêÂäü', 'success');
                closeModal();
                loadAccounts();
            } catch (error) {
                console.error('Êñ∞Â¢ûÂ∏≥Êà∂Â§±Êïó:', error);
                showToast('‚ùå Êñ∞Â¢ûÂ∏≥Êà∂Â§±Êïó', 'error');
            }
        }

        // ==================== Âà™Èô§Â∏≥Êà∂ ====================
        async function deleteAccount(docId, name) {
            if (!confirm(`‚ùì Á¢∫ÂÆöË¶ÅÂà™Èô§Â∏≥Êà∂„Äå${name}„ÄçÂóéÔºü\n‚ö†Ô∏è Ê≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`)) {
                return;
            }

            try {
                await db.collection('accounts').doc(docId).delete();

                const recordsSnapshot = await db.collection('trainingRecords')
                    .where('userId', '==', docId)
                    .get();

                const batch = db.batch();
                recordsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                showToast('‚úÖ Â∏≥Êà∂Â∑≤Âà™Èô§', 'success');
                loadAccounts();
            } catch (error) {
                console.error('Âà™Èô§Â∏≥Êà∂Â§±Êïó:', error);
                showToast('‚ùå Âà™Èô§Â∏≥Êà∂Â§±Êïó', 'error');
            }
        }

        // ==================== È°ØÁ§∫ÂüπË®ìÁÆ°ÁêÜ Dashboard ====================
        async function showTrainingManage() {
            const typeTitle = currentTrainingType === 'PCA' ? 'PCA ÂüπË®ì' : 'OTA ÂüπË®ì';
            document.getElementById('trainingTypeTitle').textContent = `üìö ${typeTitle}`;
            
            showPage('trainingManagePage');
            await loadCategoryDashboard();
        }

        // ==================== ËºâÂÖ•ÂüπË®ìÂàÜÈ°û Dashboard ====================
        async function loadCategoryDashboard() {
            try {
                const categoriesSnapshot = await db.collection('trainingCategories')
                    .where('trainingType', '==', currentTrainingType)
                    .get();
                
                const categories = [];
                categoriesSnapshot.forEach(doc => {
                    categories.push({ docId: doc.id, ...doc.data() });
                });
                categories.sort((a, b) => (a.order || 0) - (b.order || 0));

                const dashboardHtml = [];

                for (const category of categories) {
                    const itemsSnapshot = await db.collection('trainingItems')
                        .where('categoryId', '==', category.docId)
                        .get();

                    const totalItems = itemsSnapshot.size;
                    const percentage = 100;

                    const circumference = 2 * Math.PI * 60;
                    const offset = circumference - (percentage / 100) * circumference;

                    dashboardHtml.push(`
                        <div class="training-card" onclick="showCategoryDetail('${category.docId}')">
                            <div class="card-icon">${category.emoji}</div>
                            <div class="card-title">${category.name}</div>
                            <div class="card-progress">
                                <svg class="progress-ring" width="150" height="150" viewBox="0 0 150 150">
    <circle class="progress-ring-bg" cx="75" cy="75" r="60" 
        fill="none" stroke-width="12"/>
    <circle class="progress-ring-circle" cx="75" cy="75" r="60" 
        fill="none" stroke-width="12"
        stroke-dasharray="${circumference}" 
        stroke-dashoffset="${offset}"
        stroke-linecap="round"/>
</svg>
                                <div class="progress-text">
                                    <div class="progress-percent">${totalItems}</div>
                                    <div class="progress-label">ÂÄãÈ†ÖÁõÆ</div>
                                </div>
                            </div>
                            <div class="card-stats">${totalItems} È†ÖÂüπË®ìÈ†ÖÁõÆ</div>
                            <div class="card-actions">
                                <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteCategory('${category.docId}', '${category.name}')">üóëÔ∏è Âà™Èô§</button>
                            </div>
                        </div>
                    `);
                }

                if (dashboardHtml.length === 0) {
                    dashboardHtml.push('<div class="no-data-message">üì≠ Â∞öÁÑ°ÂüπË®ìÂàÜÈ°ûÔºåË´ãÊñ∞Â¢ûÂàÜÈ°ûÈñãÂßã‰ΩøÁî®</div>');
                }

                document.getElementById('categoryDashboard').innerHTML = dashboardHtml.join('');
            } catch (error) {
                console.error('ËºâÂÖ•ÂüπË®ìDashboardÂ§±Êïó:', error);
                showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
            }
        }

// ==================== È°ØÁ§∫ÂàÜÈ°ûË©≥ÊÉÖÔºàÁÆ°ÁêÜÊ®°ÂºèÔºâ====================
async function showCategoryDetail(categoryId) {
    currentCategoryId = categoryId;
    showPage('categoryDetailPage');

    try {
        const categoryDoc = await db.collection('trainingCategories').doc(categoryId).get();
        const category = categoryDoc.data();

        document.getElementById('categoryDetailTitle').textContent = `${category.emoji} ${category.name}`;

        const itemsSnapshot = await db.collection('trainingItems')
            .where('categoryId', '==', categoryId)
            .get();

        const items = [];
        itemsSnapshot.forEach(doc => {
            items.push({ docId: doc.id, ...doc.data() });
        });
        items.sort((a, b) => (a.order || 0) - (b.order || 0));

        if (items.length === 0) {
            document.getElementById('categoryDetailContent').innerHTML = 
                '<div class="items-dashboard"><p class="no-items-message">üì≠ Ê≠§ÂàÜÈ°ûÂ∞öÁÑ°ÂüπË®ìÈ†ÖÁõÆ</p></div>';
            return;
        }

        const itemsHtml = items.map(item => {
let badges = '';

// ‚≠ê Êñ∞Â¢ûÔºöÈ°ØÁ§∫Ë®òÈåÑÈ°ûÂûã
if (item.recordType === 'training') {
    badges += '<span class="badge badge-info">üìù Ë®ìÁ∑¥Ë®òÈåÑ</span>';
} else {
    badges += '<span class="badge badge-success">üìã Ë©ïÊ†∏ Checklist</span>';
}

if (item.hasDeadline) {
    badges += `<span class="badge badge-warning">‚è∞ ${item.deadlineValue} ${item.deadlineUnit === 'days' ? 'Êó•' : item.deadlineUnit === 'weeks' ? 'Âë®' : 'Êúà'}</span>`;
}

if (item.isImportant) {
    badges += '<span class="badge badge-critical">‚≠ê ÈáçË¶ÅË©ïÊ†∏</span>';
}
            
            // ‚≠ê ADD THIS LINE - Calculate actual steps (excluding subtitles)
            const actualStepCount = item.checklist ? item.checklist.filter(s => !s.isSubtitle).length : 0;
            const totalSteps = actualStepCount; // Use actualStepCount instead of item.checklist.length
            
            const percentage = item.hasChecklist ? 100 : 0;
            
            const circumference = 2 * Math.PI * 50;
            const offset = circumference - (percentage / 100) * circumference;

let checklistHtml = '';

if (item.hasChecklist && item.checklist && item.checklist.length > 0) {
    let stepCounter = 0;
    
    const stepsHtml = item.checklist.map((step, index) => {
        if (step.isSubtitle) {
            return `
                <div style="margin: 20px 0 10px 0;">
                    <span class="step-subtitle">${step.step}</span>
                </div>
            `;
        }
        
        stepCounter++;
        const criticalBadge = (item.recordType === 'checklist' && step.critical) 
            ? '<span class="badge badge-critical">‚ö†Ô∏è Critical</span>' 
            : '';
        
        return `
            <div class="checklist-item ${step.critical ? 'critical' : ''}">
                <div class="checklist-step-name">
                    <span class="step-number">Step ${stepCounter}:</span>
                    ${step.step} ${criticalBadge}
                </div>
                <div class="checklist-step-actions">
                    <button class="step-btn step-btn-pass" onclick="event.stopPropagation(); editChecklistStep('${item.docId}', ${index})">‚úèÔ∏è Á∑®ËºØ</button>
                    <button class="step-btn step-btn-fail" onclick="event.stopPropagation(); deleteChecklistStep('${item.docId}', ${index})">üóëÔ∏è Âà™Èô§</button>
                </div>
            </div>
        `;
    }).join('');

    const headerText = item.recordType === 'training' ? 'üìù Ë®ìÁ∑¥Ê≠•È©ü' : 'üìã Ë©ïÊ†∏Ê≠•È©ü Checklist';
    
    checklistHtml = `
        <div class="checklist-container">
            <div class="checklist-header">${headerText} (ÂÖ± ${actualStepCount} ÂÄãÊ≠•È©ü)</div>
            ${stepsHtml}
            <button class="btn btn-success btn-small" style="margin-top: 10px;" onclick="event.stopPropagation(); addChecklistStep('${item.docId}')">‚ûï Êñ∞Â¢ûÊ≠•È©ü</button>
        </div>
    `;
}

            return `
                <div class="item-card ${item.hasChecklist ? '' : 'completed'}" id="item_${item.docId}" onclick="toggleItemCard('${item.docId}')">
                    <button class="back-button" onclick="event.stopPropagation(); toggleItemCard('${item.docId}')">üîô Êî∂Ëµ∑</button>
                    
                    <div class="item-card-header">
<div class="item-card-title-section">
    <div class="item-card-name" style="font-size: 1.8em; 
                                       font-weight: 900; 
                                       color: #2c3e50; 
                                       line-height: 1.3;
                                       text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
                                       letter-spacing: 0.5px;
                                       background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);
                                       -webkit-background-clip: text;
                                       -webkit-text-fill-color: transparent;
                                       background-clip: text;
                                       padding: 5px 0;
                                       margin-bottom: 10px;
                                       text-align: center;">
         ${item.name}
    </div>
    <div class="item-card-badges">${badges}</div>
</div>
                        
                        <div class="item-card-progress">
                            <svg class="item-progress-ring" width="120" height="120" viewBox="0 0 120 120">
                                <circle class="item-progress-ring-bg" cx="60" cy="60" r="50" 
                                    fill="none" stroke-width="10"/>
                                <circle class="item-progress-ring-circle" cx="60" cy="60" r="50" 
                                    fill="none" stroke-width="10"
                                    stroke-dasharray="${circumference}" 
                                    stroke-dashoffset="${offset}"
                                    stroke-linecap="round"/>
                            </svg>
                            <div class="item-progress-text">
                                <div class="item-progress-percent">${totalSteps}</div>
                                <div class="item-progress-label">Ê≠•È©ü</div>
                            </div>
                        </div>

                        <div class="item-card-actions">
                            ${!item.hasChecklist ? `<button class="btn btn-info btn-small" onclick="event.stopPropagation(); convertToChecklist('${item.docId}')">üìã ËΩâÊèõÁÇ∫ Checklist</button>` : ''}
                            <button class="btn btn-warning btn-small" onclick="event.stopPropagation(); editItemSettings('${item.docId}')">‚öôÔ∏è Ë®≠ÂÆö</button>
                            <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteTrainingItem('${item.docId}', '${item.name}')">üóëÔ∏è Âà™Èô§È†ÖÁõÆ</button>
                        </div>
                    </div>

                    <div class="item-card-content">
                        ${checklistHtml}
                    </div>
                </div>
            `;
        }).join('');

        document.getElementById('categoryDetailContent').innerHTML = `<div class="items-dashboard">${itemsHtml}</div>`;
    } catch (error) {
        console.error('ËºâÂÖ•ÂàÜÈ°ûË©≥ÊÉÖÂ§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}

// ==================== ÂàáÊèõÈ†ÖÁõÆÂç°ÁâáÂ±ïÈñã/Êî∂Ëµ∑ ====================
function toggleItemCard(itemId) {
    const card = document.getElementById(`item_${itemId}`);
    const allCards = document.querySelectorAll('.item-card');
    
    if (card.classList.contains('expanded')) {
        // Êî∂Ëµ∑Áï∂ÂâçÂç°Áâá
        card.classList.remove('expanded');
    } else {
        // ÂÖàÊî∂Ëµ∑ÊâÄÊúâÂç°Áâá
        allCards.forEach(c => c.classList.remove('expanded'));
        // Â±ïÈñãÁï∂ÂâçÂç°Áâá
        card.classList.add('expanded');
    }
}
        
// ==================== Á∑®ËºØÈ†ÖÁõÆË®≠ÂÆö ====================
async function editItemSettings(itemId) {
    try {
        const itemDoc = await db.collection('trainingItems').doc(itemId).get();
        const item = itemDoc.data();

        const modalBody = `
            <div class="input-group">
                <label>üìù È†ÖÁõÆÂêçÁ®±</label>
                <input type="text" id="editItemName" value="${item.name}" placeholder="Ë´ãËº∏ÂÖ•È†ÖÁõÆÂêçÁ®±">
            </div>
            ${currentTrainingType === 'PCA' ? `
            <div class="input-group">
                <label>üë• ÈÅ©Áî®Á¥öÂà•</label>
                <select id="editPcaLevel">
                    <option value="ALL" ${(item.pcaLevel || 'ALL') === 'ALL' ? 'selected' : ''}>ÂÖ®ÈÉ® PCA (PCA1, PCA2, PCA3)</option>
                    <option value="PCA1" ${item.pcaLevel === 'PCA1' ? 'selected' : ''}>ÂÉÖ PCA1</option>
                    <option value="PCA2" ${item.pcaLevel === 'PCA2' ? 'selected' : ''}>ÂÉÖ PCA2</option>
                    <option value="PCA3" ${item.pcaLevel === 'PCA3' ? 'selected' : ''}>ÂÉÖ PCA3</option>
                </select>
            </div>
            ` : ''}
            <div class="checkbox-group">
                <input type="checkbox" id="editHasDeadline" ${item.hasDeadline ? 'checked' : ''} onchange="toggleEditDeadlineSettings()">
                <label for="editHasDeadline">‚è∞ Ë®≠ÂÆöÊà™Ê≠¢Êó•Êúü</label>
            </div>
            <div id="editDeadlineSettings" class="deadline-settings" style="display: ${item.hasDeadline ? 'block' : 'none'};">
                <div class="deadline-settings-title">‚è∞ Êà™Ê≠¢Êó•ÊúüË®àÁÆóÔºàÂæûÂÖ•ËÅ∑Êó•ÊúüÈñãÂßãÔºâ</div>
                
                <!-- ‚≠ê ÈáçË§áË©ïÊ†∏ÈÅ∏È†Ö -->
                <div class="checkbox-group" style="margin-bottom: 15px;">
                    <input type="checkbox" id="editIsRecurringCheck" ${item.recurringSequence ? 'checked' : ''} onchange="toggleEditRecurringSettings()">
                    <label for="editIsRecurringCheck">üîÑ Ë®≠ÂÆöÁÇ∫ÈáçË§áË©ïÊ†∏</label>
                </div>
                
                <!-- ‚≠ê ÂñÆÊ¨°Ë©ïÊ†∏Ë®≠ÂÆö -->
                <div id="editSingleDeadlineSettings" style="display: ${item.recurringSequence ? 'none' : 'block'};">
                    <div class="deadline-inputs">
                        <div class="input-group" style="margin: 0;">
                            <label>Êï∏ÂÄº</label>
                            <input type="number" id="editDeadlineValue" value="${item.deadlineValue || 1}" min="1" placeholder="Ë´ãËº∏ÂÖ•Êï∏ÂÄº">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>ÂñÆ‰Ωç</label>
                            <select id="editDeadlineUnit">
                                <option value="days" ${item.deadlineUnit === 'days' ? 'selected' : ''}>Êó•</option>
                                <option value="weeks" ${item.deadlineUnit === 'weeks' ? 'selected' : ''}>Âë®</option>
                                <option value="months" ${item.deadlineUnit === 'months' ? 'selected' : ''}>Êúà</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- ‚≠ê ÈáçË§áË©ïÊ†∏Ë®≠ÂÆö -->
                <div id="editRecurringSettings" style="display: ${item.recurringSequence ? 'block' : 'none'};">
                    <label>üìÖ ÈáçË§áÈÄ±ÊúüÔºàË´ãÈÅ∏ÊìáÊâÄÊúâÈúÄË¶ÅÂÆåÊàêÁöÑÊôÇÈñìÈªûÔºâ</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                        <label style="padding: 10px; background: #f0f0f0; border-radius: 8px; cursor: pointer; text-align: center;">
                            <input type="checkbox" value="3" class="edit-recurring-period" style="margin-right: 5px;">
                            3 ÂÄãÊúà
                        </label>
                        <label style="padding: 10px; background: #f0f0f0; border-radius: 8px; cursor: pointer; text-align: center;">
                            <input type="checkbox" value="6" class="edit-recurring-period" style="margin-right: 5px;">
                            6 ÂÄãÊúà
                        </label>
                        <label style="padding: 10px; background: #f0f0f0; border-radius: 8px; cursor: pointer; text-align: center;">
                            <input type="checkbox" value="9" class="edit-recurring-period" style="margin-right: 5px;">
                            9 ÂÄãÊúà
                        </label>
                        <label style="padding: 10px; background: #f0f0f0; border-radius: 8px; cursor: pointer; text-align: center;">
                            <input type="checkbox" value="12" class="edit-recurring-period" style="margin-right: 5px;">
                            12 ÂÄãÊúà
                        </label>
                        <label style="padding: 10px; background: #f0f0f0; border-radius: 8px; cursor: pointer; text-align: center;">
                            <input type="checkbox" value="18" class="edit-recurring-period" style="margin-right: 5px;">
                            18 ÂÄãÊúà
                        </label>
                        <label style="padding: 10px; background: #f0f0f0; border-radius: 8px; cursor: pointer; text-align: center;">
                            <input type="checkbox" value="24" class="edit-recurring-period" style="margin-right: 5px;">
                            24 ÂÄãÊúà
                        </label>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; font-size: 0.9em;">
                        <strong>üí° ÊèêÁ§∫Ôºö</strong>Á≥ªÁµ±ÊúÉËá™ÂãïÁÇ∫ÊØèÂÄãÈÄ±ÊúüÂª∫Á´ãÁç®Á´ãÁöÑË©ïÊ†∏Ë®òÈåÑ
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #ffe6e6; border-radius: 8px; font-size: 0.9em; color: #d32f2f;">
                        <strong>‚ö†Ô∏è Ê≥®ÊÑèÔºö</strong>Ê≠§È†ÖÁõÆÂ∑≤ÊòØÈáçË§áË©ïÊ†∏ÁöÑ‰∏ÄÈÉ®ÂàÜÔºå‰øÆÊîπÊúÉÂΩ±ÈüøÊâÄÊúâÁõ∏ÈóúÈ†ÖÁõÆ
                    </div>
                </div>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="editIsImportant" ${item.isImportant ? 'checked' : ''}>
                <label for="editIsImportant">‚≠ê Âä†ÂÖ•ÈáçË¶ÅË©ïÊ†∏ÊôÇÈñìË°®</label>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="saveItemSettings('${itemId}')">‚úÖ ÂÑ≤Â≠ò</button>
                <button class="btn btn-secondary" onclick="closeModal()">‚ùå ÂèñÊ∂à</button>
            </div>
        `;

        showModal('‚öôÔ∏è Á∑®ËºØÈ†ÖÁõÆË®≠ÂÆö', modalBody);
    } catch (error) {
        console.error('ËºâÂÖ•È†ÖÁõÆË®≠ÂÆöÂ§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}

// ==================== ÂàáÊèõÁ∑®ËºØÊà™Ê≠¢Êó•ÊúüË®≠ÂÆö ====================
function toggleEditDeadlineSettings() {
    const checked = document.getElementById('editHasDeadline').checked;
    document.getElementById('editDeadlineSettings').style.display = checked ? 'block' : 'none';
}

// ==================== ÂàáÊèõÁ∑®ËºØÈáçË§áË©ïÊ†∏Ë®≠ÂÆö ====================
function toggleEditRecurringSettings() {
    const isRecurring = document.getElementById('editIsRecurringCheck').checked;
    document.getElementById('editSingleDeadlineSettings').style.display = isRecurring ? 'none' : 'block';
    document.getElementById('editRecurringSettings').style.display = isRecurring ? 'block' : 'none';
}
        
// ==================== ÂÑ≤Â≠òÈ†ÖÁõÆË®≠ÂÆö ====================
async function saveItemSettings(itemId) {
    const name = document.getElementById('editItemName').value.trim();
    const hasDeadline = document.getElementById('editHasDeadline').checked;
    const isImportant = document.getElementById('editIsImportant').checked;

    if (!name) {
        showToast('‚ùå Ë´ãËº∏ÂÖ•È†ÖÁõÆÂêçÁ®±', 'error');
        return;
    }

    try {
        const updateData = {
            name: name,
            hasDeadline: hasDeadline,
            isImportant: isImportant
        };

        if (currentTrainingType === 'PCA') {
            const pcaLevel = document.getElementById('editPcaLevel').value;
            updateData.pcaLevel = pcaLevel;
        }

        // ‚≠ê Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÈáçË§áË©ïÊ†∏
        const isRecurring = hasDeadline && document.getElementById('editIsRecurringCheck') && document.getElementById('editIsRecurringCheck').checked;

        if (hasDeadline && isRecurring) {
            // üîÑ ÈáçË§áË©ïÊ†∏Ê®°Âºè
            const recurringPeriods = Array.from(document.querySelectorAll('.edit-recurring-period:checked'))
                .map(cb => parseInt(cb.value))
                .sort((a, b) => a - b);
            
            if (recurringPeriods.length === 0) {
                showToast('‚ùå Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãÈáçË§áÈÄ±ÊúüÔºÅ', 'error');
                return;
            }
            
            // ‚ö†Ô∏è ÂèñÂæóÁõÆÂâçÈ†ÖÁõÆÁöÑË≥áÊñô‰ª•Ê™¢Êü•ÊòØÂê¶Â∑≤ÊòØÈáçË§áË©ïÊ†∏ÁöÑ‰∏ÄÈÉ®ÂàÜ
            const itemDoc = await db.collection('trainingItems').doc(itemId).get();
            const currentItem = itemDoc.data();
            
            if (currentItem.recurringSequence) {
                showToast('‚ö†Ô∏è Ê≠§È†ÖÁõÆÂ∑≤ÊòØÈáçË§áË©ïÊ†∏ÁöÑ‰∏ÄÈÉ®ÂàÜÔºåË´ãÂà™Èô§ÂæåÈáçÊñ∞Âª∫Á´ã', 'warning');
                return;
            }
            
            // TODO: ÂØ¶‰ΩúËΩâÊèõÁÇ∫ÈáçË§áË©ïÊ†∏ÁöÑÈÇèËºØ
            showToast('‚ö†Ô∏è Â∞áÁèæÊúâÈ†ÖÁõÆËΩâÊèõÁÇ∫ÈáçË§áË©ïÊ†∏ÂäüËÉΩÈñãÁôº‰∏≠ÔºåË´ãÂª∫Á´ãÊñ∞È†ÖÁõÆ', 'warning');
            return;
            
        } else if (hasDeadline) {
            // ‚è∞ ÂñÆÊ¨°Ë©ïÊ†∏Ê®°Âºè
            const deadlineValue = parseInt(document.getElementById('editDeadlineValue').value) || 1;
            const deadlineUnit = document.getElementById('editDeadlineUnit').value;
            updateData.deadlineValue = deadlineValue;
            updateData.deadlineUnit = deadlineUnit;
            // ‚≠ê Ê∏ÖÈô§ÈáçË§áË©ïÊ†∏Ê®ôË®ò
            updateData.recurringSequence = firebase.firestore.FieldValue.delete();
            updateData.recurringTotal = firebase.firestore.FieldValue.delete();
            updateData.originalName = firebase.firestore.FieldValue.delete();
        } else {
            updateData.deadlineValue = null;
            updateData.deadlineUnit = null;
            updateData.recurringSequence = firebase.firestore.FieldValue.delete();
            updateData.recurringTotal = firebase.firestore.FieldValue.delete();
            updateData.originalName = firebase.firestore.FieldValue.delete();
        }

        await db.collection('trainingItems').doc(itemId).update(updateData);

        showToast('‚úÖ Ë®≠ÂÆöÂ∑≤Êõ¥Êñ∞', 'success');
        closeModal();
        showCategoryDetail(currentCategoryId);
    } catch (error) {
        console.error('Êõ¥Êñ∞Ë®≠ÂÆöÂ§±Êïó:', error);
        showToast('‚ùå Êõ¥Êñ∞Â§±Êïó', 'error');
    }
}

        // ==================== ËøîÂõû Dashboard ====================
        function backToDashboard() {
            showTrainingManage();
        }

        // ==================== È°ØÁ§∫Êñ∞Â¢ûÂàÜÈ°ûË¶ñÁ™ó ====================
        function showAddCategoryModal() {
            selectedEmoji = 'üìö';
            
            const emojiOptions = EMOJI_LIST.map(emoji => 
                `<div class="emoji-option ${emoji === selectedEmoji ? 'selected' : ''}" onclick="selectEmoji('${emoji}')">${emoji}</div>`
            ).join('');

            const modalBody = `
                <div class="input-group">
                    <label>üìù ÂàÜÈ°ûÂêçÁ®±</label>
                    <input type="text" id="newCategoryName" placeholder="Ë´ãËº∏ÂÖ•ÂàÜÈ°ûÂêçÁ®±">
                </div>
                <div class="input-group">
                    <label>üòÄ ÈÅ∏Êìá Emoji</label>
                    <div class="emoji-picker" id="emojiPicker">
                        ${emojiOptions}
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-success" onclick="createCategory()">‚úÖ Êñ∞Â¢û</button>
                    <button class="btn btn-secondary" onclick="closeModal()">‚ùå ÂèñÊ∂à</button>
                </div>
            `;

            showModal('‚ûï Êñ∞Â¢ûÂüπË®ìÂàÜÈ°û', modalBody);
        }

        // ==================== ÈÅ∏Êìá Emoji ====================
        function selectEmoji(emoji) {
            selectedEmoji = emoji;
            document.querySelectorAll('.emoji-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        // ==================== ÂâµÂª∫ÂüπË®ìÂàÜÈ°û ====================
        async function createCategory() {
            const name = document.getElementById('newCategoryName').value.trim();

            if (!name) {
                showToast('‚ùå Ë´ãËº∏ÂÖ•ÂàÜÈ°ûÂêçÁ®±', 'error');
                return;
            }

            try {
                const categoriesSnapshot = await db.collection('trainingCategories')
                    .where('trainingType', '==', currentTrainingType)
                    .get();
                
                let maxOrder = 0;
                categoriesSnapshot.forEach(doc => {
                    const order = doc.data().order || 0;
                    if (order > maxOrder) maxOrder = order;
                });

                await db.collection('trainingCategories').add({
                    name: name,
                    emoji: selectedEmoji,
                    trainingType: currentTrainingType,
                    order: maxOrder + 1,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('‚úÖ ÂàÜÈ°ûÊñ∞Â¢ûÊàêÂäü', 'success');
                closeModal();
                loadCategoryDashboard();
            } catch (error) {
                console.error('Êñ∞Â¢ûÂàÜÈ°ûÂ§±Êïó:', error);
                showToast('‚ùå Êñ∞Â¢ûÂàÜÈ°ûÂ§±Êïó', 'error');
            }
        }

        // ==================== Âà™Èô§ÂüπË®ìÂàÜÈ°û ====================
        async function deleteCategory(docId, name) {
            if (!confirm(`‚ùì Á¢∫ÂÆöË¶ÅÂà™Èô§ÂàÜÈ°û„Äå${name}„ÄçÂóéÔºü\n‚ö†Ô∏è ÂàÜÈ°û‰∏ãÁöÑÊâÄÊúâÂüπË®ìÈ†ÖÁõÆ‰πüÊúÉË¢´Âà™Èô§ÔºÅ`)) {
                return;
            }

            try {
                const itemsSnapshot = await db.collection('trainingItems')
                    .where('categoryId', '==', docId)
                    .get();

                const batch = db.batch();
                itemsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                batch.delete(db.collection('trainingCategories').doc(docId));
                
                await batch.commit();

                showToast('‚úÖ ÂàÜÈ°ûÂ∑≤Âà™Èô§', 'success');
                loadCategoryDashboard();
            } catch (error) {
                console.error('Âà™Èô§ÂàÜÈ°ûÂ§±Êïó:', error);
                showToast('‚ùå Âà™Èô§ÂàÜÈ°ûÂ§±Êïó', 'error');
            }
        }

// ==================== È°ØÁ§∫Êñ∞Â¢ûÈ†ÖÁõÆË¶ñÁ™ó ====================
function showAddItemModal() {
    const modalBody = `
        <div class="input-group">
            <label>üìù È†ÖÁõÆÂêçÁ®±</label>
            <input type="text" id="newItemName" placeholder="Ë´ãËº∏ÂÖ•ÂüπË®ìÈ†ÖÁõÆÂêçÁ®±">
        </div>
        ${currentTrainingType === 'PCA' ? `
        <div class="input-group">
            <label>üë• ÈÅ©Áî®Á¥öÂà•</label>
            <select id="newPcaLevel">
                <option value="ALL">ÂÖ®ÈÉ® PCA (PCA1, PCA2, PCA3)</option>
                <option value="PCA1">ÂÉÖ PCA1</option>
                <option value="PCA2">ÂÉÖ PCA2</option>
                <option value="PCA3">ÂÉÖ PCA3</option>
            </select>
        </div>
        ` : ''}
        
        <!-- ‚≠ê Êñ∞Â¢ûÔºöÈÅ∏ÊìáË®òÈåÑÈ°ûÂûã -->
        <div class="input-group">
            <label>üìã Ë®òÈåÑÈ°ûÂûã</label>
            <select id="recordType" onchange="toggleRecordTypeOptions()">
                <option value="checklist">Ë©ïÊ†∏Ê≠•È©ü Checklist (ÈúÄË©ï‰º∞ÂêàÊ†º/‰∏çÂêàÊ†º)</option>
                <option value="training">Ë®ìÁ∑¥Ë®òÈåÑ (Âè™Ë®òÈåÑÊïôÊéàÊó•ÊúüÂèäÁ∞ΩÂêç)</option>
            </select>
        </div>
        
        <!-- ‚≠ê Ë™™ÊòéË®äÊÅØ -->
        <div id="recordTypeHint" style="background: #f0f4ff; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 0.9em; border-left: 4px solid #ffa502;">
            <strong>üìã Ë©ïÊ†∏Ê≠•È©ü Checklist:</strong> ÈúÄË¶ÅÈÄêÊ≠•Ë©ï‰º∞ÊØèÂÄãÊ≠•È©üÊòØÂê¶ÂêàÊ†º/‰∏çÂêàÊ†ºÔºåÊúâ Critical Ê≠•È©üÊéßÂà∂
        </div>
        
        <!-- ÂÖ±Áî®ÁöÑÊ≠•È©üËº∏ÂÖ•ÂçÄÂüü -->
        <div id="checklistInputGroup" style="margin-top: 15px;">
            <div class="input-group">
                <label id="stepsLabel">üìã Checklist Ê≠•È©ü</label>
                <div id="checklistStepsContainer">
                    <!-- ÂãïÊÖãÁîüÊàê -->
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-success btn-small" onclick="addNewChecklistStep()">‚ûï Êñ∞Â¢ûÊ≠•È©ü</button>
                    <button class="btn btn-info btn-small" onclick="addNewSubtitle()">üìë Êñ∞Â¢ûÁ´†ÁØÄÊ®ôÈ°å</button>
                </div>
            </div>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="hasDeadlineCheck" onchange="toggleDeadlineSettings()">
            <label for="hasDeadlineCheck">‚è∞ Ë®≠ÂÆöÊà™Ê≠¢Êó•Êúü</label>
        </div>
        <div id="deadlineSettings" class="deadline-settings" style="display: none;">
            <div class="deadline-settings-title">‚è∞ Êà™Ê≠¢Êó•ÊúüË®àÁÆóÔºàÂæûÂÖ•ËÅ∑Êó•ÊúüÈñãÂßãÔºâ</div>
            
            <div class="checkbox-group" style="margin-bottom: 15px;">
                <input type="checkbox" id="isRecurringCheck" onchange="toggleRecurringSettings()">
                <label for="isRecurringCheck">üîÑ Ë®≠ÂÆöÁÇ∫ÈáçË§áË©ïÊ†∏</label>
            </div>
            
            <div id="singleDeadlineSettings">
                <div class="deadline-inputs">
                    <div class="input-group" style="margin: 0;">
                        <label>Êï∏ÂÄº</label>
                        <input type="number" id="deadlineValue" value="1" min="1" placeholder="Ë´ãËº∏ÂÖ•Êï∏ÂÄº">
                    </div>
                    <div class="input-group" style="margin: 0;">
                        <label>ÂñÆ‰Ωç</label>
                        <select id="deadlineUnit">
                            <option value="days">Êó•</option>
                            <option value="weeks">Âë®</option>
                            <option value="months">Êúà</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="recurringSettings" style="display: none;">
                <label>üìÖ ÈáçË§áÈÄ±ÊúüÔºàË´ãÈÅ∏ÊìáÊâÄÊúâÈúÄË¶ÅÂÆåÊàêÁöÑÊôÇÈñìÈªûÔºâ</label>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                    <label style="padding: 10px; background: #f0f0f0; border-radius: 8px; cursor: pointer; text-align: center;">
                        <input type="checkbox" value="3" class="recurring-period" style="margin-right: 5px;">
                        3 ÂÄãÊúà
                    </label>
                    <label style="padding: 10px; background: #f0f0f0; border-radius: 8px; cursor: pointer; text-align: center;">
                        <input type="checkbox" value="6" class="recurring-period" style="margin-right: 5px;">
                        6 ÂÄãÊúà
                    </label>
                    <label style="padding: 10px; background: #f0f0f0; border-radius: 8px; cursor: pointer; text-align: center;">
                        <input type="checkbox" value="9" class="recurring-period" style="margin-right: 5px;">
                        9 ÂÄãÊúà
                    </label>
                    <label style="padding: 10px; background: #f0f0f0; border-radius: 8px; cursor: pointer; text-align: center;">
                        <input type="checkbox" value="12" class="recurring-period" style="margin-right: 5px;">
                        12 ÂÄãÊúà
                    </label>
                    <label style="padding: 10px; background: #f0f0f0; border-radius: 8px; cursor: pointer; text-align: center;">
                        <input type="checkbox" value="18" class="recurring-period" style="margin-right: 5px;">
                        18 ÂÄãÊúà
                    </label>
                    <label style="padding: 10px; background: #f0f0f0; border-radius: 8px; cursor: pointer; text-align: center;">
                        <input type="checkbox" value="24" class="recurring-period" style="margin-right: 5px;">
                        24 ÂÄãÊúà
                    </label>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; font-size: 0.9em;">
                    <strong>üí° ÊèêÁ§∫Ôºö</strong>Á≥ªÁµ±ÊúÉËá™ÂãïÁÇ∫ÊØèÂÄãÈÄ±ÊúüÂª∫Á´ãÁç®Á´ãÁöÑË©ïÊ†∏Ë®òÈåÑ
                </div>
            </div>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="isImportantCheck">
            <label for="isImportantCheck">‚≠ê Âä†ÂÖ•ÈáçË¶ÅË©ïÊ†∏ÊôÇÈñìË°®</label>
        </div>
        <div class="modal-buttons">
            <button class="btn btn-success" onclick="createTrainingItem()">‚úÖ Êñ∞Â¢û</button>
            <button class="btn btn-secondary" onclick="closeModal()">‚ùå ÂèñÊ∂à</button>
        </div>
    `;

    showModal('‚ûï Êñ∞Â¢ûÂüπË®ìÈ†ÖÁõÆ', modalBody);
    checklistSteps = [];
    addNewChecklistStep();
}

// ‚≠ê Êñ∞Â¢ûÔºöÂàáÊèõË®òÈåÑÈ°ûÂûãÈÅ∏È†Ö
function toggleRecordTypeOptions() {
    const recordType = document.getElementById('recordType').value;
    const hint = document.getElementById('recordTypeHint');
    const stepsLabel = document.getElementById('stepsLabel');
    
    if (recordType === 'checklist') {
        hint.innerHTML = '<strong>üìã Ë©ïÊ†∏Ê≠•È©ü Checklist:</strong> ÈúÄË¶ÅÈÄêÊ≠•Ë©ï‰º∞ÊØèÂÄãÊ≠•È©üÊòØÂê¶ÂêàÊ†º/‰∏çÂêàÊ†ºÔºåÊúâ Critical Ê≠•È©üÊéßÂà∂';
        hint.style.borderLeftColor = '#ffa502';
        stepsLabel.textContent = 'üìã Checklist Ê≠•È©ü';
    } else {
        hint.innerHTML = '<strong>üìù Ë®ìÁ∑¥Ë®òÈåÑ:</strong> Âè™Ë®òÈåÑÊïôÊéà/Ë¨õËß£Êó•ÊúüÂèäÈõôÊñπÁ∞ΩÂêçÔºå‰∏çÈúÄË©ï‰º∞ÂêàÊ†º/‰∏çÂêàÊ†º';
        hint.style.borderLeftColor = '#2ed573';
        stepsLabel.textContent = 'üìù Ë®ìÁ∑¥Ê≠•È©ü';
    }
}
        
        // ==================== ÂàáÊèõ Checklist Ëº∏ÂÖ• ====================
        function toggleChecklistInput() {
            const checked = document.getElementById('hasChecklistCheck').checked;
            document.getElementById('checklistInputGroup').style.display = checked ? 'block' : 'none';
        }

        // ==================== ÂàáÊèõÊà™Ê≠¢Êó•ÊúüË®≠ÂÆö ====================
        function toggleDeadlineSettings() {
            const checked = document.getElementById('hasDeadlineCheck').checked;
            document.getElementById('deadlineSettings').style.display = checked ? 'block' : 'none';
        }

        // ==================== ÂàáÊèõÈáçË§áË©ïÊ†∏Ë®≠ÂÆö ====================
function toggleRecurringSettings() {
    const isRecurring = document.getElementById('isRecurringCheck').checked;
    document.getElementById('singleDeadlineSettings').style.display = isRecurring ? 'none' : 'block';
    document.getElementById('recurringSettings').style.display = isRecurring ? 'block' : 'none';
}
        
// ==================== Êñ∞Â¢û Checklist Ê≠•È©ü ====================
function addNewChecklistStep() {
    checklistSteps.push({ step: '', critical: false });
    renderChecklistSteps();
}

// ADD THIS NEW FUNCTION BELOW ‚Üì
// ==================== Êñ∞Â¢ûÁ´†ÁØÄÊ®ôÈ°å ====================
function addNewSubtitle() {
    checklistSteps.push({ isSubtitle: true, step: '' });
    renderChecklistSteps();
}

// ==================== Ê∏≤Êüì Checklist Ê≠•È©ü ====================
function renderChecklistSteps() {
    const container = document.getElementById('checklistStepsContainer');
    const recordType = document.getElementById('recordType')?.value || 'checklist';
    
    let stepCounter = 0;
    
    const stepsHtml = checklistSteps.map((step, index) => {
        if (step.isSubtitle) {
            return `
                <div class="step-edit-item subtitle" style="margin-bottom: 12px;">
                    <div class="step-edit-header">
                        <span class="step-number" style="color: #ffa502;">üìë Á´†ÁØÄ:</span>
                        <input type="text" data-index="${index}" value="${step.step}" 
                               placeholder="Ëº∏ÂÖ•Á´†ÁØÄÊ®ôÈ°å" 
                               style="flex: 1; padding: 8px; border: 2px solid #ffa502; border-radius: 6px; font-weight: bold;"
                               onchange="updateChecklistStep(${index}, this.value)">
                        <button class="btn btn-danger btn-small" onclick="removeChecklistStep(${index})">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        } else {
            stepCounter++;
            return `
                <div class="step-edit-item ${step.critical ? 'critical' : ''}" style="margin-bottom: 12px;">
                    <div class="step-edit-header">
                        <span class="step-number">Step ${stepCounter}:</span>
                        <input type="text" data-index="${index}" value="${step.step}" 
                               placeholder="Ëº∏ÂÖ•Ê≠•È©üÂÖßÂÆπ" 
                               style="flex: 1; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px;"
                               onchange="updateChecklistStep(${index}, this.value)">
                        <button class="btn btn-danger btn-small" onclick="removeChecklistStep(${index})">üóëÔ∏è</button>
                    </div>
                    ${recordType === 'checklist' ? `
                        <div class="checkbox-group" style="margin-top: 8px; margin-left: 80px;">
                            <input type="checkbox" id="critical_${index}" ${step.critical ? 'checked' : ''} 
                                   onchange="toggleCritical(${index})">
                            <label for="critical_${index}">‚ö†Ô∏è CriticalÔºàÂøÖÈúÄÂêàÊ†ºÊâçËÉΩÈÄöÈÅéÂüπË®ìÔºâ</label>
                        </div>
                    ` : ''}
                </div>
            `;
        }
    }).join('');

    container.innerHTML = stepsHtml;
}

        // ==================== Êõ¥Êñ∞ Checklist Ê≠•È©ü ====================
        function updateChecklistStep(index, value) {
            checklistSteps[index].step = value;
        }

        // ==================== ÂàáÊèõ Critical ÁãÄÊÖã ====================
        function toggleCritical(index) {
            checklistSteps[index].critical = !checklistSteps[index].critical;
            renderChecklistSteps();
        }

        // ==================== ÁßªÈô§ Checklist Ê≠•È©ü ====================
        function removeChecklistStep(index) {
            checklistSteps.splice(index, 1);
            renderChecklistSteps();
        }

// ==================== ÂâµÂª∫ÂüπË®ìÈ†ÖÁõÆ ====================
async function createTrainingItem() {
    const name = document.getElementById('newItemName').value.trim();
    const recordType = document.getElementById('recordType').value;
    const hasDeadline = document.getElementById('hasDeadlineCheck').checked;
    const isImportant = document.getElementById('isImportantCheck').checked;

    if (!name) {
        showToast('‚ùå Ë´ãËº∏ÂÖ•È†ÖÁõÆÂêçÁ®±', 'error');
        return;
    }

    // ‚≠ê È©óË≠âÊ≠•È©ü
    if (checklistSteps.length === 0 || checklistSteps.some(s => !s.step.trim())) {
        showToast('‚ùå Ë´ãËá≥Â∞ëÊñ∞Â¢û‰∏ÄÂÄãÊ≠•È©ü‰∏¶Â°´ÂØ´ÂÖßÂÆπ', 'error');
        return;
    }

    let itemData = {
        categoryId: currentCategoryId,
        name: name,
        recordType: recordType,
        hasChecklist: true, // ‚≠ê ÂÖ©Á®ÆÈ°ûÂûãÈÉΩÊúâÊ≠•È©ü
        checklist: checklistSteps, // ‚≠ê ÈÉΩÂÑ≤Â≠òÊ≠•È©üÂÖßÂÆπ
        hasDeadline: hasDeadline,
        isImportant: isImportant,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if (currentTrainingType === 'PCA') {
        const pcaLevel = document.getElementById('newPcaLevel').value;
        itemData.pcaLevel = pcaLevel;
    }

    // Êà™Ê≠¢Êó•ÊúüËôïÁêÜÔºà‰øùÊåÅÂéüÊúâÈÇèËºØÔºâ
    const isRecurring = document.getElementById('hasDeadlineCheck').checked && 
                        document.getElementById('isRecurringCheck').checked;

    if (hasDeadline && isRecurring) {
        const recurringPeriods = Array.from(document.querySelectorAll('.recurring-period:checked'))
            .map(cb => parseInt(cb.value))
            .sort((a, b) => a - b);
        
        if (recurringPeriods.length === 0) {
            showToast('‚ùå Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãÈáçË§áÈÄ±ÊúüÔºÅ', 'error');
            return;
        }
        
        try {
            const itemsSnapshot = await db.collection('trainingItems')
                .where('categoryId', '==', currentCategoryId)
                .get();

            let maxOrder = 0;
            itemsSnapshot.forEach(doc => {
                const order = doc.data().order || 0;
                if (order > maxOrder) maxOrder = order;
            });

            for (let i = 0; i < recurringPeriods.length; i++) {
                const months = recurringPeriods[i];
                const recurringItemData = {
                    ...itemData,
                    name: `${name} (${months}ÂÄãÊúà)`,
                    deadlineValue: months,
                    deadlineUnit: 'months',
                    recurringSequence: i + 1,
                    recurringTotal: recurringPeriods.length,
                    originalName: name,
                    order: maxOrder + i + 1
                };
                
                await db.collection('trainingItems').add(recurringItemData);
            }

            showToast(`‚úÖ ÊàêÂäüÊñ∞Â¢û ${recurringPeriods.length} ÂÄãÈáçË§áË©ïÊ†∏ÔºÅ`, 'success');
            closeModal();
            showCategoryDetail(currentCategoryId);
        } catch (error) {
            console.error('Êñ∞Â¢ûÈáçË§áË©ïÊ†∏Â§±Êïó:', error);
            showToast('‚ùå Êñ∞Â¢ûÈáçË§áË©ïÊ†∏Â§±Êïó', 'error');
        }
        
    } else {
        if (hasDeadline) {
            const deadlineValue = parseInt(document.getElementById('deadlineValue').value) || 1;
            const deadlineUnit = document.getElementById('deadlineUnit').value;
            itemData.deadlineValue = deadlineValue;
            itemData.deadlineUnit = deadlineUnit;
        }

        try {
            const itemsSnapshot = await db.collection('trainingItems')
                .where('categoryId', '==', currentCategoryId)
                .get();

            let maxOrder = 0;
            itemsSnapshot.forEach(doc => {
                const order = doc.data().order || 0;
                if (order > maxOrder) maxOrder = order;
            });

            itemData.order = maxOrder + 1;

            await db.collection('trainingItems').add(itemData);

            showToast('‚úÖ ÂüπË®ìÈ†ÖÁõÆÊñ∞Â¢ûÊàêÂäü', 'success');
            closeModal();
            showCategoryDetail(currentCategoryId);
        } catch (error) {
            console.error('Êñ∞Â¢ûÂüπË®ìÈ†ÖÁõÆÂ§±Êïó:', error);
            showToast('‚ùå Êñ∞Â¢ûÂüπË®ìÈ†ÖÁõÆÂ§±Êïó', 'error');
        }
    }
}
        
        // ==================== ËΩâÊèõÁÇ∫ Checklist ====================
        async function convertToChecklist(itemId) {
            if (!confirm('‚ùì Á¢∫ÂÆöË¶ÅÂ∞áÊ≠§È†ÖÁõÆËΩâÊèõÁÇ∫ Checklist Ê†ºÂºèÂóéÔºü')) {
                return;
            }

            try {
                await db.collection('trainingItems').doc(itemId).update({
                    hasChecklist: true,
                    checklist: [
                        { step: 'Step 1: Ë´ãÁ∑®ËºØÊ≠§Ê≠•È©ü', critical: false }
                    ]
                });

                showToast('‚úÖ Â∑≤ËΩâÊèõÁÇ∫ Checklist Ê†ºÂºè', 'success');
                showCategoryDetail(currentCategoryId);
            } catch (error) {
                console.error('ËΩâÊèõÂ§±Êïó:', error);
                showToast('‚ùå ËΩâÊèõÂ§±Êïó', 'error');
            }
        }

        // ==================== Êñ∞Â¢û Checklist Ê≠•È©üÔºàÁ∑®ËºØÁèæÊúâÈ†ÖÁõÆÔºâ====================
        async function addChecklistStep(itemId) {
            try {
                const itemDoc = await db.collection('trainingItems').doc(itemId).get();
                const item = itemDoc.data();

                const newStep = { step: `Êñ∞Ê≠•È©ü`, critical: false };
                const updatedChecklist = [...(item.checklist || []), newStep];

                await db.collection('trainingItems').doc(itemId).update({
                    checklist: updatedChecklist
                });

                showToast('‚úÖ Ê≠•È©üÂ∑≤Êñ∞Â¢û', 'success');
                showCategoryDetail(currentCategoryId);
            } catch (error) {
                console.error('Êñ∞Â¢ûÊ≠•È©üÂ§±Êïó:', error);
                showToast('‚ùå Êñ∞Â¢ûÊ≠•È©üÂ§±Êïó', 'error');
            }
        }

        // ==================== Á∑®ËºØ Checklist Ê≠•È©ü ====================
        async function editChecklistStep(itemId, stepIndex) {
            try {
                const itemDoc = await db.collection('trainingItems').doc(itemId).get();
                const item = itemDoc.data();
                const step = item.checklist[stepIndex];

                const modalBody = `
                    <div class="input-group">
                        <label>üìù Ê≠•È©üÂÖßÂÆπ</label>
                        <input type="text" id="editStepContent" value="${step.step}" placeholder="Ë´ãËº∏ÂÖ•Ê≠•È©üÂÖßÂÆπ">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="editStepCritical" ${step.critical ? 'checked' : ''}>
                        <label for="editStepCritical">‚ö†Ô∏è CriticalÔºàÂøÖÈúÄÂêàÊ†ºÊâçËÉΩÈÄöÈÅéÂüπË®ìÔºâ</label>
                    </div>
                    <div class="modal-buttons">
                        <button class="btn btn-success" onclick="saveEditedStep('${itemId}', ${stepIndex})">‚úÖ ÂÑ≤Â≠ò</button>
                        <button class="btn btn-secondary" onclick="closeModal()">‚ùå ÂèñÊ∂à</button>
                    </div>
                `;

                showModal('‚úèÔ∏è Á∑®ËºØÊ≠•È©ü', modalBody);
            } catch (error) {
                console.error('ËºâÂÖ•Ê≠•È©üÂ§±Êïó:', error);
                showToast('‚ùå ËºâÂÖ•Ê≠•È©üÂ§±Êïó', 'error');
            }
        }

        // ==================== ÂÑ≤Â≠òÁ∑®ËºØÁöÑÊ≠•È©ü ====================
        async function saveEditedStep(itemId, stepIndex) {
            const content = document.getElementById('editStepContent').value.trim();
            const critical = document.getElementById('editStepCritical').checked;

            if (!content) {
                showToast('‚ùå Ë´ãËº∏ÂÖ•Ê≠•È©üÂÖßÂÆπ', 'error');
                return;
            }

            try {
                const itemDoc = await db.collection('trainingItems').doc(itemId).get();
                const item = itemDoc.data();
                const updatedChecklist = [...item.checklist];
                
                updatedChecklist[stepIndex] = {
                    step: content,
                    critical: critical
                };

                await db.collection('trainingItems').doc(itemId).update({
                    checklist: updatedChecklist
                });

                showToast('‚úÖ Ê≠•È©üÂ∑≤Êõ¥Êñ∞', 'success');
                closeModal();
                showCategoryDetail(currentCategoryId);
            } catch (error) {
                console.error('Êõ¥Êñ∞Ê≠•È©üÂ§±Êïó:', error);
                showToast('‚ùå Êõ¥Êñ∞Ê≠•È©üÂ§±Êïó', 'error');
            }
        }

        // ==================== Âà™Èô§ Checklist Ê≠•È©ü ====================
        async function deleteChecklistStep(itemId, stepIndex) {
            if (!confirm('‚ùì Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ê≠•È©üÂóéÔºü')) {
                return;
            }

            try {
                const itemDoc = await db.collection('trainingItems').doc(itemId).get();
                const item = itemDoc.data();
                const updatedChecklist = item.checklist.filter((_, index) => index !== stepIndex);

                await db.collection('trainingItems').doc(itemId).update({
                    checklist: updatedChecklist
                });

                showToast('‚úÖ Ê≠•È©üÂ∑≤Âà™Èô§', 'success');
                showCategoryDetail(currentCategoryId);
            } catch (error) {
                console.error('Âà™Èô§Ê≠•È©üÂ§±Êïó:', error);
                showToast('‚ùå Âà™Èô§Ê≠•È©üÂ§±Êïó', 'error');
            }
        }

        // ==================== Âà™Èô§ÂüπË®ìÈ†ÖÁõÆ ====================
        async function deleteTrainingItem(docId, name) {
            if (!confirm(`‚ùì Á¢∫ÂÆöË¶ÅÂà™Èô§ÂüπË®ìÈ†ÖÁõÆ„Äå${name}„ÄçÂóéÔºü`)) {
                return;
            }

            try {
                await db.collection('trainingItems').doc(docId).delete();
                showToast('‚úÖ ÂüπË®ìÈ†ÖÁõÆÂ∑≤Âà™Èô§', 'success');
                showCategoryDetail(currentCategoryId);
            } catch (error) {
                console.error('Âà™Èô§ÂüπË®ìÈ†ÖÁõÆÂ§±Êïó:', error);
                showToast('‚ùå Âà™Èô§ÂüπË®ìÈ†ÖÁõÆÂ§±Êïó', 'error');
            }
        }

        // ==================== È°ØÁ§∫Âì°Â∑•ÂàóË°® ====================
async function showStaffList(level) {
    currentStaffLevel = level;
    
    const levelNames = {
        'WM': 'WM (ÁóÖÊàøÁ∂ìÁêÜ)',
        'APN': 'APN (Ë≥áÊ∑±Ë≠∑Â∏´)',
        'RN': 'RN (Ë®ªÂÜäË≠∑Â£´)',
        'PCA1': 'PCA1',
        'PCA2': 'PCA2',
        'PCA3': 'PCA3',
        'OTA': 'OTA'
    };
    
    document.getElementById('staffListTitle').textContent = `üìä ${levelNames[level]} - Âì°Â∑•ÂàóË°®`;
    showPage('staffListPage');

    try {
        const accountsSnapshot = await db.collection('accounts')
            .where('level', '==', level)
            .where('role', '==', 'staff')
            .get();

        const staffListHtml = [];

        accountsSnapshot.forEach(doc => {
            const account = doc.data();
            staffListHtml.push(`
                <div class="staff-card level-${level}" onclick="showTrainingProgress('${doc.id}')">
                    <div class="staff-card-name">üë§ ${account.name}</div>
                    <div class="staff-card-info">
                        üìÖ ÂÖ•ËÅ∑Êó•Êúü: ${account.joinDate || 'Êú™Ë®≠ÂÆö'}
                    </div>
                </div>
            `);
        });

        if (staffListHtml.length === 0) {
            staffListHtml.push('<p class="no-data-message">üì≠ Ê≠§ËÅ∑Á¥öÂ∞öÁÑ°Âì°Â∑•</p>');
        }

        document.getElementById('staffList').innerHTML = staffListHtml.join('');
        
        // ‚≠ê‚≠ê‚≠ê Êñ∞Â¢û‰ª•‰∏ãÂÖ©Ë°å ‚≠ê‚≠ê‚≠ê
        document.getElementById('staffSearchInput').value = '';  // Ê∏ÖÁ©∫ÊêúÂ∞ãÊ°Ü
        document.getElementById('staffSearchCount').textContent = `ÂÖ± ${accountsSnapshot.size} ‰ΩçÂêå‰∫ã`;  // È°ØÁ§∫Á∏ΩÊï∏
        
    } catch (error) {
        console.error('ËºâÂÖ•Âì°Â∑•ÂàóË°®Â§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Âì°Â∑•ÂàóË°®Â§±Êïó', 'error');
    }
}

        // ==================== ÊêúÂ∞ãÂì°Â∑•ÂàóË°® ====================
function filterStaffList() {
    const searchInput = document.getElementById('staffSearchInput');
    const filter = searchInput.value.toLowerCase().trim();
    const staffCards = document.querySelectorAll('.staff-card');
    const noResults = document.getElementById('noStaffResults');
    const searchCount = document.getElementById('staffSearchCount');
    
    let visibleCount = 0;
    let totalCount = staffCards.length;
    
    staffCards.forEach(card => {
        const staffName = card.querySelector('.staff-card-name').textContent.toLowerCase();
        const staffInfo = card.querySelector('.staff-card-info').textContent.toLowerCase();
        
        // ÊêúÂ∞ãÂêçÁ®±ÊàñÂÖ•ËÅ∑Êó•Êúü
        if (staffName.includes(filter) || staffInfo.includes(filter)) {
            card.style.display = '';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // È°ØÁ§∫ÁµêÊûúÊï∏Èáè
    if (filter === '') {
        searchCount.textContent = `ÂÖ± ${totalCount} ‰ΩçÂêå‰∫ã`;
    } else {
        searchCount.textContent = `ÊêúÂ∞ãÂà∞ ${visibleCount} ‰ΩçÂêå‰∫ãÔºàÂÖ± ${totalCount} ‰ΩçÔºâ`;
    }
    
    // È°ØÁ§∫/Èö±ËóèÁÑ°ÁµêÊûúÊèêÁ§∫
    if (visibleCount === 0 && filter !== '') {
        noResults.style.display = 'block';
        document.getElementById('staffList').style.display = 'none';
    } else {
        noResults.style.display = 'none';
        document.getElementById('staffList').style.display = '';
    }
}
        
        // ==================== Ë®àÁÆóÊà™Ê≠¢Êó•Êúü ====================
        function calculateDeadline(joinDate, value, unit) {
            const date = new Date(joinDate);
            
            if (unit === 'days') {
                date.setDate(date.getDate() + value);
            } else if (unit === 'weeks') {
                date.setDate(date.getDate() + (value * 7));
            } else if (unit === 'months') {
                date.setMonth(date.getMonth() + value);
            }
            
            return date;
        }

        // ==================== È°ØÁ§∫ÂüπË®ìÈÄ≤Â∫¶ Dashboard ====================
        async function showTrainingProgress(staffId) {
            currentStaffId = staffId;
            showPage('trainingProgressPage');

            try {
                const staffDoc = await db.collection('accounts').doc(staffId).get();
                const staff = staffDoc.data();

                document.getElementById('progressStaffName').textContent = `${staff.name} - ÂüπË®ìÈÄ≤Â∫¶`;

                // Ê†πÊìöÂì°Â∑•ËÅ∑Á¥öÊ±∫ÂÆöË¶ÅÈ°ØÁ§∫Âì™ÂÄãÈ°ûÂûãÁöÑÂüπË®ì
                const staffTrainingType = ['PCA1', 'PCA2', 'PCA3'].includes(staff.level) ? 'PCA' : 'OTA';

                // ËºâÂÖ•ÈáçË¶ÅË©ïÊ†∏ÊôÇÈñìË°®
                await loadImportantTimeline(staffId, staff.joinDate, staffTrainingType);

                const categoriesSnapshot = await db.collection('trainingCategories')
                    .where('trainingType', '==', staffTrainingType)
                    .get();
                
                const categories = [];
                categoriesSnapshot.forEach(doc => {
                    categories.push({ docId: doc.id, ...doc.data() });
                });
                categories.sort((a, b) => (a.order || 0) - (b.order || 0));

                const progressHtml = [];

  for (const category of categories) {
    const itemsSnapshot = await db.collection('trainingItems')
        .where('categoryId', '==', category.docId)
        .get();

    const items = [];
    itemsSnapshot.forEach(doc => {
        const item = doc.data();
        // Filter by PCA level if applicable
        if (staffTrainingType === 'PCA' && item.pcaLevel && item.pcaLevel !== 'ALL') {
            if (item.pcaLevel !== staff.level) {
                return; // Skip this item
            }
        }
        items.push({ docId: doc.id, ...item });
    });
    items.sort((a, b) => (a.order || 0) - (b.order || 0));

    // Continue with existing logic but use 'items' array instead of creating a new one

const recordsSnapshot = await db.collection('trainingRecords')
    .where('userId', '==', staffId)
    .get();

const records = {};
recordsSnapshot.forEach(doc => {
    const record = doc.data();
    records[record.itemId] = record;
});

let completedCount = 0;
let totalCount = items.length; // Use filtered items array

items.forEach(itemObj => {
    const item = itemObj;
    const record = records[itemObj.docId];
    
    // ‚≠ê‚≠ê‚≠ê Êñ∞Â¢ûÔºöÂà§Êñ∑Ë®ìÁ∑¥Ë®òÈåÑÈ°ûÂûã ‚≠ê‚≠ê‚≠ê
    if (item.recordType === 'training' && item.hasChecklist && record) {
        const stepRecords = record.stepRecords || {};
        const actualSteps = item.checklist.filter(s => !s.isSubtitle);
        let completedSteps = 0;
        
        item.checklist.forEach((step, index) => {
            if (!step.isSubtitle && stepRecords[index]?.trainingDate && 
                stepRecords[index]?.traineeSignature && stepRecords[index]?.mentorSignature) {
                completedSteps++;
            }
        });
        
        // Ë®ìÁ∑¥Ë®òÈåÑÔºöÊâÄÊúâÊ≠•È©üÈÉΩÂÆåÊàêÊâçÁÆóÂÆåÊàê
        if (completedSteps === actualSteps.length) {
            completedCount++;
        }
    }
    // ‚≠ê‚≠ê‚≠ê ‰ª•‰∏ãÊòØ Checklist È°ûÂûãÁöÑÂà§Êñ∑ ‚≠ê‚≠ê‚≠ê
    else if (item.recordType === 'checklist' && item.hasChecklist && record) {
        const allCriticalPassed = item.checklist.every((step, index) => {
            if (step.isSubtitle || !step.critical) return true;
            return record.checklistStatus && record.checklistStatus[index] === 'pass';
        });
        
        const actualSteps = item.checklist.filter(s => !s.isSubtitle);
        let passedSteps = 0;
        
        item.checklist.forEach((step, index) => {
            if (!step.isSubtitle && record.checklistStatus && record.checklistStatus[index] === 'pass') {
                passedSteps++;
            }
        });
        
        const completionRate = Math.round((passedSteps / actualSteps.length) * 100);
        
        if (allCriticalPassed && completionRate === 100 && record.status === 'completed') {
            completedCount++;
        }
    }
    // ‚≠ê‚≠ê‚≠ê ËàäÁâàÊ≤íÊúâ recordType ÁöÑÈ†ÖÁõÆ ‚≠ê‚≠ê‚≠ê
    else if (!item.recordType && !item.hasChecklist && record && record.status === 'completed') {
        completedCount++;
    }
});

const percentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
const isCompleted = percentage === 100;

const circumference = 2 * Math.PI * 60;
const offset = circumference - (percentage / 100) * circumference;

                    progressHtml.push(`
                        <div class="training-card ${isCompleted ? 'completed' : 'in-progress'}" 
                             onclick="showCategoryEvaluation('${category.docId}')">
                            <div class="card-icon">${category.emoji}</div>
                            <div class="card-title">${category.name}</div>
                            <div class="card-progress">
                                <svg class="progress-ring" width="150" height="150" viewBox="0 0 150 150">
    <circle class="progress-ring-bg" cx="75" cy="75" r="60" 
        fill="none" stroke-width="12"/>
    <circle class="progress-ring-circle" cx="75" cy="75" r="60" 
        fill="none" stroke-width="12"
        stroke-dasharray="${circumference}" 
        stroke-dashoffset="${offset}"
        stroke-linecap="round"/>
</svg>
                                <div class="progress-text">
                                    <div class="progress-percent">${percentage}%</div>
                                    <div class="progress-label">${completedCount}/${totalCount} È†ÖÁõÆÂÆåÊàê</div>
                                </div>
                            </div>
                            <div class="card-stats">${completedCount}/${totalCount} È†ÖÁõÆÂ∑≤ÂÆåÊàê</div>
                            ${isCompleted ? '<div class="card-success-badge">‚úÖ ÂÖ®ÈÉ®ÂÆåÊàêÔºÅ</div>' : ''}
                        </div>
                    `);
                }

                if (progressHtml.length === 0) {
                    progressHtml.push('<p class="no-data-message">üì≠ Â∞öÁÑ°ÂüπË®ìÈ†ÖÁõÆ</p>');
                }

                document.getElementById('trainingProgress').innerHTML = progressHtml.join('');
            } catch (error) {
                console.error('ËºâÂÖ•ÂüπË®ìÈÄ≤Â∫¶Â§±Êïó:', error);
                showToast('‚ùå ËºâÂÖ•ÂüπË®ìÈÄ≤Â∫¶Â§±Êïó', 'error');
            }
        }

        // ==================== ËºâÂÖ•ÈáçË¶ÅË©ïÊ†∏ÊôÇÈñìË°® ====================
        async function loadImportantTimeline(staffId, joinDate, trainingType) {
            try {
                if (!joinDate) {
                    document.getElementById('importantTimeline').style.display = 'none';
                    return;
                }

                const categoriesSnapshot = await db.collection('trainingCategories')
                    .where('trainingType', '==', trainingType)
                    .get();

                const importantItems = [];

                for (const categoryDoc of categoriesSnapshot.docs) {
                    const category = categoryDoc.data();
                    
                    const itemsSnapshot = await db.collection('trainingItems')
                        .where('categoryId', '==', categoryDoc.id)
                        .where('isImportant', '==', true)
                        .get();

 // ‚≠ê ÂÖàÂèñÂæóÂì°Â∑•Ë≥áÊñô‰ª•Áç≤Âèñ level
const staffDoc = await db.collection('accounts').doc(staffId).get();
const staff = staffDoc.data();

// ... Âú® for loop ÂÖßÈÉ®ÔºåÊâæÂà∞ itemsSnapshot.forEach ÈÄôÊÆµ

itemsSnapshot.forEach(doc => {
    const item = doc.data();
    
    // ‚≠ê ÈÅéÊøæ PCA Á¥öÂà•È†ÖÁõÆ
    if (category.trainingType === 'PCA' && item.pcaLevel && item.pcaLevel !== 'ALL') {
        if (item.pcaLevel !== staff.level) {
            return; // Ë∑≥ÈÅé‰∏çÁ¨¶ÂêàÁ¥öÂà•ÁöÑÈ†ÖÁõÆ
        }
    }
    
    importantItems.push({
        docId: doc.id,
        categoryName: category.name,
        categoryEmoji: category.emoji,
        ...item
    });
});
                }

                if (importantItems.length === 0) {
                    document.getElementById('importantTimeline').style.display = 'none';
                    return;
                }

                // Áç≤ÂèñÂüπË®ìË®òÈåÑ
                const recordsSnapshot = await db.collection('trainingRecords')
                    .where('userId', '==', staffId)
                    .get();

                const records = {};
                recordsSnapshot.forEach(doc => {
                    const record = doc.data();
                    records[record.itemId] = record;
                });

                const now = new Date();
                const timelineHtml = [];

importantItems.forEach(item => {
    let deadline = null;
    let daysRemaining = null;
    let statusClass = '';
    let statusText = '';

    if (item.hasDeadline) {
        deadline = calculateDeadline(joinDate, item.deadlineValue, item.deadlineUnit);
        const diffTime = deadline - now;
        daysRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    const record = records[item.docId];
    let isCompleted = false;

    if (item.hasChecklist && record) {
        // ‚≠ê ÊéíÈô§Á´†ÁØÄÊ®ôÈ°å
        const allCriticalPassed = item.checklist.every((step, index) => {
            if (step.isSubtitle || !step.critical) return true;
            return record.checklistStatus && record.checklistStatus[index] === 'pass';
        });
        
        const actualSteps = item.checklist.filter(s => !s.isSubtitle);
        let passedSteps = 0;
        
        item.checklist.forEach((step, index) => {
            if (!step.isSubtitle && record.checklistStatus && record.checklistStatus[index] === 'pass') {
                passedSteps++;
            }
        });
        
        const completionRate = Math.round((passedSteps / actualSteps.length) * 100);
        isCompleted = allCriticalPassed && completionRate === 100 && record.status === 'completed';
    } else if (record) {
        isCompleted = record.status === 'completed';
    }

    // ‚≠ê‚≠ê‚≠ê ÈóúÈçµ‰øÆÊîπÔºöÂ¶ÇÊûúÂ∑≤ÂÆåÊàêÔºåÁõ¥Êé•Ë∑≥ÈÅéÊ≠§È†ÖÁõÆ
    if (isCompleted) {
        return; // ‰∏çÈ°ØÁ§∫Â∑≤ÂÆåÊàêÁöÑÈ†ÖÁõÆ
    }

    // Âè™ÊúâÊú™ÂÆåÊàêÁöÑÈ†ÖÁõÆÊâçÊúÉÈ°ØÁ§∫
    if (deadline && daysRemaining < 0) {
        statusClass = 'overdue';
        statusText = `‚ö†Ô∏è Â∑≤ÈÄæÊúü ${Math.abs(daysRemaining)} Â§©`;
    } else if (deadline && daysRemaining <= 7) {
        statusClass = 'overdue';
        statusText = `‚è∞ Ââ©È§ò ${daysRemaining} Â§©`;
    } else if (deadline) {
        statusText = `‚è∞ Ââ©È§ò ${daysRemaining} Â§©`;
    } else {
        statusText = '‚è≥ ÂæÖÂÆåÊàê';
    }

    timelineHtml.push(`
        <div class="timeline-item ${statusClass}" onclick="quickEvaluate('${item.categoryName}', '${item.docId}')">
            <div class="timeline-item-info">
                <div class="timeline-item-name">${item.categoryEmoji} ${item.name}</div>
                <div class="timeline-item-details">
                    üìÇ ${item.categoryName}
                    ${deadline ? ` | üìÖ Êà™Ê≠¢Êó•Êúü: ${deadline.toLocaleDateString('zh-TW')}` : ''}
                </div>
            </div>
            <div class="timeline-item-status">${statusText}</div>
        </div>
    `);
});

// ‚≠ê Ê™¢Êü•ÊòØÂê¶ÊúâÊú™ÂÆåÊàêÁöÑÈ†ÖÁõÆ
if (timelineHtml.length === 0) {
    // Ê≤íÊúâÊú™ÂÆåÊàêÁöÑÈáçË¶ÅË©ïÊ†∏ - È°ØÁ§∫ÁÅ∞Ëâ≤ÁãÄÊÖã
    document.getElementById('timelineItems').innerHTML = `
        <div style="text-align: center; padding: 30px; background: #f0f0f0; border-radius: 12px; color: #999;">
            <div style="font-size: 3em; margin-bottom: 10px;">‚úÖ</div>
            <div style="font-size: 1.2em; font-weight: bold;">Êö´Ê≤íÊúâÊú™ÂÆåÊàêÁöÑÈáçË¶ÅË©ïÊ†∏</div>
            <div style="margin-top: 10px; font-size: 0.9em;">ÊâÄÊúâÈáçË¶ÅË©ïÊ†∏Â∑≤ÂÆåÊàê</div>
        </div>
    `;
} else {
    // ÊúâÊú™ÂÆåÊàêÁöÑÈ†ÖÁõÆ - Ê≠£Â∏∏È°ØÁ§∫
    document.getElementById('timelineItems').innerHTML = timelineHtml.join('');
}

document.getElementById('importantTimeline').style.display = 'block';
            } catch (error) {
                console.error('ËºâÂÖ•ÈáçË¶ÅË©ïÊ†∏ÊôÇÈñìË°®Â§±Êïó:', error);
            }
        }

        // ==================== Âø´ÈÄüË©ïÊ†∏ÔºàÂæûÊôÇÈñìË°®ÈªûÊìäÔºâ====================
        async function quickEvaluate(categoryName, itemId) {
            try {
                const itemDoc = await db.collection('trainingItems').doc(itemId).get();
                const item = itemDoc.data();
                
                currentCategoryId = item.categoryId;
                showCategoryEvaluation(item.categoryId);
            } catch (error) {
                console.error('Âø´ÈÄüË©ïÊ†∏Â§±Êïó:', error);
                showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
            }
        }

// ==================== È°ØÁ§∫ÂàÜÈ°ûË©ïÊ†∏ÔºàÂì°Â∑•Ë©ïÊ†∏Ê®°ÂºèÔºâ====================
async function showCategoryEvaluation(categoryId) {
    currentCategoryId = categoryId;
    showPage('itemEvaluationPage');

    try {
        const categoryDoc = await db.collection('trainingCategories').doc(categoryId).get();
        const category = categoryDoc.data();

        document.getElementById('evaluationCategoryTitle').textContent = `${category.emoji} ${category.name} - Ë©ïÊ†∏`;

        // ‚≠ê ÂÖàÂèñÂæóÂì°Â∑•Ë≥áÊñô‰ª•Áç≤Âèñ level
        const staffDoc = await db.collection('accounts').doc(currentStaffId).get();
        const staff = staffDoc.data();
        
        // ‚≠ê‚≠ê‚≠ê Êñ∞Â¢ûÔºöÊ™¢Êü•Áï∂ÂâçÁî®Êà∂ÊòØÂê¶ÊúâÁ∑®ËºØÊ¨äÈôê ‚≠ê‚≠ê‚≠ê
        const hasEditPermission = canEditTrainingRecord(category.name, staff.level);
        const itemsSnapshot = await db.collection('trainingItems')
            .where('categoryId', '==', categoryId)
            .get();

        const items = [];
        itemsSnapshot.forEach(doc => {
            const item = doc.data();
            
            // ‚≠ê ÈÅéÊøæ PCA Á¥öÂà•È†ÖÁõÆ
            if (category.trainingType === 'PCA' && item.pcaLevel && item.pcaLevel !== 'ALL') {
                if (item.pcaLevel !== staff.level) {
                    return; // Ë∑≥ÈÅé‰∏çÁ¨¶ÂêàÁ¥öÂà•ÁöÑÈ†ÖÁõÆ
                }
            }
            
            items.push({ docId: doc.id, ...item });
        });
        items.sort((a, b) => (a.order || 0) - (b.order || 0));

        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .get();

        const records = {};
        recordsSnapshot.forEach(doc => {
            const record = doc.data();
            records[record.itemId] = { docId: doc.id, ...record };
        });

        const itemsHtml = [];

        items.forEach(item => {
            const record = records[item.docId];

            // ‚≠ê Ë®ìÁ∑¥Ë®òÈåÑÈ°ûÂûã
            if (item.recordType === 'training' && item.hasChecklist && item.checklist) {
                const stepRecords = record?.stepRecords || {};
                
                const actualSteps = item.checklist.filter(s => !s.isSubtitle);
                let totalSteps = actualSteps.length;
                let completedSteps = 0;
                
                item.checklist.forEach((step, index) => {
                    if (!step.isSubtitle && stepRecords[index]?.trainingDate && 
                        stepRecords[index]?.traineeSignature && stepRecords[index]?.mentorSignature) {
                        completedSteps++;
                    }
                });

                const completionRate = Math.round((completedSteps / totalSteps) * 100);
                const isCompleted = completionRate === 100;

                let badges = '';
                badges += '<span class="badge badge-info">üìù Ë®ìÁ∑¥Ë®òÈåÑ</span>';
                
                if (item.hasDeadline) {
                    badges += `<span class="badge badge-warning">‚è∞ ${item.deadlineValue} ${item.deadlineUnit === 'days' ? 'Êó•' : item.deadlineUnit === 'weeks' ? 'Âë®' : 'Êúà'}</span>`;
                }
                
                if (item.isImportant) {
                    badges += '<span class="badge badge-critical">‚≠ê ÈáçË¶ÅË©ïÊ†∏</span>';
                }

                const circumference = 2 * Math.PI * 50;
                const offset = circumference - (completionRate / 100) * circumference;

                let stepCounter = 0;
                const stepsHtml = item.checklist.map((step, index) => {
                    if (step.isSubtitle) {
                        return `
                            <div style="margin: 20px 0 10px 0;">
                                <span class="step-subtitle">${step.step}</span>
                            </div>
                        `;
                    }
                    
                    stepCounter++;
                    const stepRecord = stepRecords[index] || {};
                    const trainingDate = stepRecord.trainingDate || '';
                    const traineeSignature = stepRecord.traineeSignature || '';
                    const mentorSignature = stepRecord.mentorSignature || '';
                    const stepCompleted = trainingDate && traineeSignature && mentorSignature;

                    return `
                        <div class="checklist-item ${stepCompleted ? 'completed' : ''}" style="margin-bottom: 20px;">
                            <div class="checklist-step-header">
                                <div class="checklist-step-name">
                                    <span class="step-number">Step ${stepCounter}:</span>
                                    ${step.step}
                                </div>
                            </div>
                            
                            <div class="training-record-item" style="margin-top: 12px;">
      <div class="training-record-row">
    <div class="training-record-label">üìÖ ÊïôÊéà/Ë¨õËß£Êó•Êúü:</div>
    <div>
        ${hasEditPermission ? `
            <input type="date" id="trainingDate_${item.docId}_${index}" 
                   value="${trainingDate}" 
                   onchange="saveStepTrainingDate('${item.docId}', ${index})"
                   style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; width: 100%;">
        ` : `
            <div style="padding: 8px; background: #f0f0f0; border-radius: 6px;">
                ${trainingDate || 'Â∞öÊú™Ë®≠ÂÆö'}
            </div>
        `}
    </div>
</div>
                                
      <div class="training-record-row">
    <div class="training-record-label">‚úçÔ∏è Êñ∞Âêå‰∫ãÁ∞ΩÂêç:</div>
    <div>
        ${hasEditPermission ? `
            <div class="signature-box ${traineeSignature ? 'signed' : ''}" 
                 onclick="editStepSignature('${item.docId}', ${index}, 'trainee', '${traineeSignature}')">
                ${traineeSignature || 'ÈªûÊìäËº∏ÂÖ•Á∞ΩÂêç'}
            </div>
        ` : `
            <div class="signature-box ${traineeSignature ? 'signed' : ''}">
                ${traineeSignature || 'Â∞öÊú™Á∞ΩÂêç'}
            </div>
        `}
    </div>
</div>
                                
<div class="training-record-row">
    <div class="training-record-label">‚úçÔ∏è Èô™Â∏∂Âêå‰∫ãÁ∞ΩÂêç:</div>
    <div>
        ${hasEditPermission ? `
            <div class="signature-box ${mentorSignature ? 'signed' : ''}" 
                 onclick="editStepSignature('${item.docId}', ${index}, 'mentor', '${mentorSignature}')">
                ${mentorSignature || 'ÈªûÊìäËº∏ÂÖ•Á∞ΩÂêç'}
            </div>
        ` : `
            <div class="signature-box ${mentorSignature ? 'signed' : ''}">
                ${mentorSignature || 'Â∞öÊú™Á∞ΩÂêç'}
            </div>
        `}
    </div>
</div>
                                
                                <div style="margin-top: 10px; padding: 10px; background: ${stepCompleted ? '#f0fff4' : '#fff9e6'}; border-radius: 6px; text-align: center; font-size: 0.9em;">
                                    <strong style="color: ${stepCompleted ? '#2ed573' : '#ffa502'};">
                                        ${stepCompleted ? '‚úÖ Ê≠§Ê≠•È©üÂ∑≤ÂÆåÊàê' : '‚è≥ ÂæÖÂÆåÊàê'}
                                    </strong>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                itemsHtml.push(`
                    <div class="item-card ${isCompleted ? 'completed' : ''}" id="eval_item_${item.docId}" onclick="toggleEvalItemCard('${item.docId}')">
                        <button class="back-button" onclick="event.stopPropagation(); collapseItemCard('${item.docId}')">üîô Êî∂Ëµ∑</button>
                        
<div class="item-card-header">
    <div class="item-card-title-section">
        <!-- ‚≠ê‚≠ê‚≠ê ÈÄôË£°ÊòØ‰øÆÊîπÁöÑÂú∞Êñπ ‚≠ê‚≠ê‚≠ê -->
<div class="item-card-name" style="font-size: 1.8em; 
                                   font-weight: 900; 
                                   color: #2c3e50; 
                                   line-height: 1.3;
                                   text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
                                   letter-spacing: 0.5px;
                                   background: linear-gradient(135deg, #ffa502 0%, #ff6b35 100%);
                                   -webkit-background-clip: text;
                                   -webkit-text-fill-color: transparent;
                                   background-clip: text;
                                   padding: 5px 0;
                                   margin-bottom: 10px;
                                   text-align: center;">
     ${item.name}
</div>
        <div class="item-card-badges">${badges}</div>
    </div>
    
    <div class="item-card-progress">
        <svg class="item-progress-ring" width="120" height="120" viewBox="0 0 120 120">
                                    <circle class="item-progress-ring-bg" cx="60" cy="60" r="50" 
                                        fill="none" stroke-width="10"/>
                                    <circle class="item-progress-ring-circle" cx="60" cy="60" r="50" 
                                        fill="none" stroke-width="10"
                                        stroke-dasharray="${circumference}" 
                                        stroke-dashoffset="${offset}"
                                        stroke-linecap="round"/>
                                </svg>
                                <div class="item-progress-text">
                                    <div class="item-progress-percent">${completionRate}%</div>
                                    <div class="item-progress-label">${completedSteps}/${totalSteps}</div>
                                </div>
                            </div>

<div class="item-card-actions">
    ${hasEditPermission ? `
        ${isCompleted ? `<button class="btn btn-danger btn-small" onclick="event.stopPropagation(); resetAllTraining('${item.docId}')">üîÑ ÈáçË®≠ÂÖ®ÈÉ®</button>` : ''}
    ` : ''}
</div>
                        </div>

                        <div class="item-card-content">
                            <div class="score-info">
                                <div class="score-title">üìä Ë®ìÁ∑¥ÈÄ≤Â∫¶</div>
                                <div class="score-details">
                                    <div class="score-item">
                                        <div class="score-item-label">Á∏ΩÊ≠•È©ü</div>
                                        <div class="score-item-value">${totalSteps}</div>
                                    </div>
                                    <div class="score-item">
                                        <div class="score-item-label">Â∑≤ÂÆåÊàê</div>
                                        <div class="score-item-value ${isCompleted ? 'pass' : 'fail'}">${completedSteps}</div>
                                    </div>
                                    <div class="score-item">
                                        <div class="score-item-label">ÂÆåÊàêÁéá</div>
                                        <div class="score-item-value ${isCompleted ? 'pass' : 'fail'}">${completionRate}%</div>
                                    </div>
                                </div>
                                <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px; text-align: center;">
                                    <span class="score-item-value ${isCompleted ? 'pass' : ''}" style="font-size: 1.1em;">
                                        ${isCompleted ? '‚úÖ Ë®ìÁ∑¥Â∑≤ÂÆåÊàê' : '‚è≥ Ë®ìÁ∑¥ÈÄ≤Ë°å‰∏≠'}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="training-record-container">
                                <div class="training-record-header">üìù Ë®ìÁ∑¥Ë®òÈåÑ (ÈÄêÊ≠•ÂÆåÊàê)</div>
                                ${stepsHtml}
                            </div>
                        </div>
                    </div>
                `);
                return; // ‚≠ê ËôïÁêÜÂÆåË®ìÁ∑¥Ë®òÈåÑÂæåË∑≥ÈÅé
            }

            // ‚≠ê ‰ª•‰∏ãÊòØ Checklist ËôïÁêÜÈÇèËºØ
            if (item.hasChecklist && item.checklist) {
                const checklistStatus = record?.checklistStatus || {};
                const remarks = record?.remarks || {};

                let totalSteps = item.checklist.filter(s => !s.isSubtitle).length;
                let passedSteps = 0;

                item.checklist.forEach((step, index) => {
                    if (!step.isSubtitle && checklistStatus[index] === 'pass') {
                        passedSteps++;
                    }
                });

                const completionRate = Math.round((passedSteps / totalSteps) * 100);
                
                const circumference = 2 * Math.PI * 50;
                const offset = circumference - (completionRate / 100) * circumference;

                const allCriticalPassed = item.checklist.every((step, index) => {
                    if (step.isSubtitle || !step.critical) return true;
                    return checklistStatus[index] === 'pass';
                });

                let badges = '';
                
                if (item.hasDeadline) {
                    badges += `<span class="badge badge-warning">‚è∞ ${item.deadlineValue} ${item.deadlineUnit === 'days' ? 'Êó•' : item.deadlineUnit === 'weeks' ? 'Âë®' : 'Êúà'}</span>`;
                }
                
                if (item.isImportant) {
                    badges += '<span class="badge badge-critical">‚≠ê ÈáçË¶ÅË©ïÊ†∏</span>';
                }

                let stepCounter = 0;

                const checklistHtml = item.checklist.map((step, index) => {
                    if (step.isSubtitle) {
                        return `
                            <div style="margin: 20px 0 10px 0;">
                                <span class="step-subtitle">${step.step}</span>
                            </div>
                        `;
                    }
                    
                    stepCounter++;
                    const stepNumber = stepCounter;
                    
                    const status = checklistStatus[index] || 'pending';
                    const remark = remarks[index] || '';
                    let statusClass = '';
                    let statusText = '';

                    if (status === 'pass') {
                        statusClass = 'completed';
                        statusText = '‚úÖ ÂêàÊ†º';
                    } else if (status === 'fail') {
                        statusClass = 'failed';
                        statusText = '‚ùå ‰∏çÂêàÊ†º';
                    } else {
                        statusText = '‚è≥ ÂæÖË©ïÊ†∏';
                    }

                    const criticalBadge = step.critical ? '<span class="badge badge-critical">‚ö†Ô∏è Critical</span>' : '';

                    return `
                        <div class="checklist-item ${statusClass} ${step.critical ? 'critical' : ''}">
                            <div class="checklist-step-header">
                                <div class="checklist-step-name">
                                    <span class="step-number">Step ${stepNumber}:</span>
                                    ${step.step} ${criticalBadge}
                                </div>
  ${currentUser.role === 'admin' || currentUser.role === 'supervisor' ? `
    <div class="checklist-step-actions">
        <button class="step-btn step-btn-pass" onclick="event.stopPropagation(); updateChecklistStepStatus('${item.docId}', ${index}, 'pass')">‚úÖ ÂêàÊ†º</button>
        <button class="step-btn step-btn-fail" onclick="event.stopPropagation(); updateChecklistStepStatus('${item.docId}', ${index}, 'fail')">‚ùå ‰∏çÂêàÊ†º</button>
        <button class="step-btn step-btn-reset" onclick="event.stopPropagation(); updateChecklistStepStatus('${item.docId}', ${index}, 'pending')">üîÑ ÈáçË®≠</button>
    </div>
` : ''}
                            </div>
                            <div style="margin: 8px 0; color: #666;">${statusText}</div>
                            ${currentUser.role === 'admin' || currentUser.role === 'supervisor' ? `
                                <div class="step-remarks">
                                    <label>üí¨ Ë©ïÊ†∏ÊÑèË¶ã/ÂÇôË®ª:</label>
                                    <textarea 
                                        id="remark_${item.docId}_${index}" 
                                        placeholder="Ë´ãËº∏ÂÖ•Ë©ïÊ†∏ÊÑèË¶ãÊàñÂÇôË®ª..."
                                        onchange="saveRemark('${item.docId}', ${index})"
                                    >${remark}</textarea>
                                </div>
                            ` : remark ? `
                                <div class="step-remarks">
                                    <label>üí¨ Ë©ïÊ†∏ÊÑèË¶ã:</label>
                                    <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-top: 5px;">${remark}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                let overallStatus = '';
                let overallClass = '';

                const criticalSteps = item.checklist.filter(s => !s.isSubtitle && s.critical);
                const hasCriticalPending = criticalSteps.some((step) => {
                    const stepIndex = item.checklist.indexOf(step);
                    return !checklistStatus[stepIndex] || checklistStatus[stepIndex] === 'pending';
                });

                if (allCriticalPassed && completionRate === 100 && record?.status === 'completed') {
                    overallStatus = '‚úÖ Â∑≤ÂÆåÊàê';
                    overallClass = 'completed';
                } else if (hasCriticalPending) {
                    overallStatus = '<span class="critical-warning">‚ö†Ô∏è Â∞öÊúâ Critical Ê≠•È©üÊú™ÈÄöÈÅé</span>';
                    overallClass = '';
                } else if (!allCriticalPassed) {
                    overallStatus = '<span class="critical-warning">‚ùå Critical Ê≠•È©ü‰∏çÂêàÊ†º</span>';
                    overallClass = '';
                } else if (completionRate < 100) {
                    overallStatus = `‚ö†Ô∏è ÂÆåÊàêÁéá ${completionRate}%`;
                    overallClass = '';
                } else {
                    overallStatus = '‚è≥ ÂæÖÂÆåÊàê';
                    overallClass = '';
                }

                itemsHtml.push(`
                    <div class="item-card ${overallClass}" id="eval_item_${item.docId}" onclick="toggleEvalItemCard('${item.docId}')">
                        <button class="back-button" onclick="event.stopPropagation(); collapseItemCard('${item.docId}')">üîô Êî∂Ëµ∑</button>
                        
                        <div class="item-card-header">
                            <div class="item-card-title-section">
 <div class="item-card-name" style="font-size: 1.8em; 
                                   font-weight: 900; 
                                   color: #2c3e50; 
                                   line-height: 1.3;
                                   text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
                                   letter-spacing: 0.5px;
                                background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);
                                   -webkit-background-clip: text;
                                   -webkit-text-fill-color: transparent;
                                   background-clip: text;
                                   padding: 5px 0;
                                   margin-bottom: 10px;
                                   text-align: center;">
     ${item.name}
</div>
                                <div class="item-card-badges">${badges}</div>
                            </div>
                            
                            <div class="item-card-progress">
                                <svg class="item-progress-ring" width="120" height="120" viewBox="0 0 120 120">
                                    <circle class="item-progress-ring-bg" cx="60" cy="60" r="50" 
                                        fill="none" stroke-width="10"/>
                                    <circle class="item-progress-ring-circle" cx="60" cy="60" r="50" 
                                        fill="none" stroke-width="10"
                                        stroke-dasharray="${circumference}" 
                                        stroke-dashoffset="${offset}"
                                        stroke-linecap="round"/>
                                </svg>
                                <div class="item-progress-text">
                                    <div class="item-progress-percent">${completionRate}%</div>
                                    <div class="item-progress-label">${passedSteps}/${totalSteps}</div>
                                </div>
                            </div>

                            <div class="item-card-actions">
                                ${currentUser.role === 'admin' || currentUser.role === 'supervisor' ? `
                                    <button class="btn btn-success btn-small" onclick="event.stopPropagation(); markItemComplete('${item.docId}')">‚úÖ Ê®ôË®òÂÆåÊàê</button>
                                    <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); markItemIncomplete('${item.docId}')">üîÑ ÈáçË®≠È†ÖÁõÆ</button>
                                ` : ''}
                            </div>
                        </div>

                        <div class="item-card-content">
                            <div class="score-info">
                                <div class="score-title">üìä Ë©ïÊ†∏ÈÄ≤Â∫¶</div>
                                <div class="score-details">
                                    <div class="score-item">
                                        <div class="score-item-label">Á∏ΩÊ≠•È©ü</div>
                                        <div class="score-item-value">${totalSteps}</div>
                                    </div>
                                    <div class="score-item">
                                        <div class="score-item-label">Â∑≤ÈÄöÈÅé</div>
                                        <div class="score-item-value ${completionRate === 100 ? 'pass' : 'fail'}">${passedSteps}</div>
                                    </div>
                                    <div class="score-item">
                                        <div class="score-item-label">ÂÆåÊàêÁéá</div>
                                        <div class="score-item-value ${completionRate === 100 ? 'pass' : 'fail'}">${completionRate}%</div>
                                    </div>
                                </div>
                                <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px; text-align: center;">
                                    <span class="score-item-value ${overallClass}" style="font-size: 1.1em;">${overallStatus}</span>
                                </div>
                            </div>
                            <div class="checklist-container">
                                <div class="checklist-header">üìã Ë©ïÊ†∏Ê≠•È©ü Checklist</div>
                                ${checklistHtml}
                            </div>
                        </div>
                    </div>
                `);
            }
        });

        if (itemsHtml.length === 0) {
            itemsHtml.push('<p class="no-items-message">üì≠ Ê≠§ÂàÜÈ°ûÂ∞öÁÑ°ÂüπË®ìÈ†ÖÁõÆ</p>');
        }

        document.getElementById('evaluationContent').innerHTML = `<div class="items-dashboard">${itemsHtml.join('')}</div>`;
        
    } catch (error) {
        console.error('ËºâÂÖ•Ë©ïÊ†∏ÂÖßÂÆπÂ§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}

// ==================== ÂàáÊèõË©ïÊ†∏È†ÖÁõÆÂç°ÁâáÂ±ïÈñã/Êî∂Ëµ∑ ====================
function toggleEvalItemCard(itemId) {
    const card = document.getElementById(`eval_item_${itemId}`);
    const allCards = document.querySelectorAll('#evaluationContent .item-card');
    
    // ‚≠ê Â¶ÇÊûúÂ∑≤Á∂ìÂ±ïÈñãÔºåÂ∞±‰∏çÂÅö‰ªª‰Ωï‰∫ãÔºàÁßªÈô§Êî∂Ëµ∑ÂäüËÉΩÔºâ
    if (card.classList.contains('expanded')) {
        return; // ‰ªÄÈ∫ºÈÉΩ‰∏çÂÅöÔºåÂè™ËÉΩÁî®ÊåâÈàïÊî∂Ëµ∑
    }
    
    // ÂÖàÊî∂Ëµ∑ÊâÄÊúâÂç°Áâá
    allCards.forEach(c => c.classList.remove('expanded'));
    // Â±ïÈñãÁï∂ÂâçÂç°Áâá
    card.classList.add('expanded');
}

// ==================== Êî∂Ëµ∑Ë©ïÊ†∏È†ÖÁõÆÂç°Áâá ====================
function collapseItemCard(itemId) {
    const card = document.getElementById(`eval_item_${itemId}`);
    if (card) {
        card.classList.remove('expanded');
    }
}
        
// ==================== Êõ¥Êñ∞ Checklist Ê≠•È©üÁãÄÊÖãÔºà‰∏çËá™ÂãïËøîÂõûÔºâ====================
async function updateChecklistStepStatus(itemId, stepIndex, status) {
    try {
        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        let checklistStatus = {};
        let remarks = {};

        if (!recordsSnapshot.empty) {
            const record = recordsSnapshot.docs[0].data();
            checklistStatus = record.checklistStatus || {};
            remarks = record.remarks || {};
        }

        if (status === 'pending') {
            delete checklistStatus[stepIndex];
        } else {
            checklistStatus[stepIndex] = status;
        }

        const recordData = {
            userId: currentStaffId,
            itemId: itemId,
            checklistStatus: checklistStatus,
            remarks: remarks,
            status: 'pending',
            evaluatedBy: currentUser.docId,
            evaluatedAt: new Date().toISOString()
        };

        if (recordsSnapshot.empty) {
            await db.collection('trainingRecords').add(recordData);
        } else {
            await db.collection('trainingRecords').doc(recordsSnapshot.docs[0].id).update(recordData);
        }

        showToast('‚úÖ Ê≠•È©üË©ïÊ†∏Â∑≤Êõ¥Êñ∞', 'success');
        
        // Âè™Êõ¥Êñ∞Áï∂ÂâçÂç°ÁâáÁöÑÂÖßÂÆπÔºå‰∏çÈáçÊñ∞ËºâÂÖ•Êï¥ÂÄãÈ†ÅÈù¢
        await refreshCurrentItemCard(itemId);
    } catch (error) {
        console.error('Êõ¥Êñ∞Ê≠•È©üÁãÄÊÖãÂ§±Êïó:', error);
        showToast('‚ùå Êõ¥Êñ∞Â§±Êïó', 'error');
    }
}

// ==================== Âà∑Êñ∞Áï∂ÂâçÈ†ÖÁõÆÂç°Áâá ====================
async function refreshCurrentItemCard(itemId) {
    try {
        const itemDoc = await db.collection('trainingItems').doc(itemId).get();
        const item = itemDoc.data();

        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        const record = recordsSnapshot.empty ? null : recordsSnapshot.docs[0].data();
        const checklistStatus = record?.checklistStatus || {};
        const remarks = record?.remarks || {};

let totalSteps = item.checklist.filter(s => !s.isSubtitle).length;
let passedSteps = 0;

item.checklist.forEach((step, index) => {
    if (!step.isSubtitle && checklistStatus[index] === 'pass') {
        passedSteps++;
    }
});

        const completionRate = Math.round((passedSteps / totalSteps) * 100);
        
        // Êõ¥Êñ∞ÈÄ≤Â∫¶Áí∞
        const card = document.getElementById(`eval_item_${itemId}`);
        if (card) {
            const percentElement = card.querySelector('.item-progress-percent');
            const labelElement = card.querySelector('.item-progress-label');
            const circleElement = card.querySelector('.item-progress-ring-circle');
            
            if (percentElement) percentElement.textContent = `${completionRate}%`;
            if (labelElement) labelElement.textContent = `${passedSteps}/${totalSteps}`;
            
            if (circleElement) {
                const circumference = 2 * Math.PI * 50;
                const offset = circumference - (completionRate / 100) * circumference;
                circleElement.setAttribute('stroke-dashoffset', offset);
            }

            // Êõ¥Êñ∞Ë©ïÊ†∏ÈÄ≤Â∫¶ÂçÄÂüü
            const scoreItems = card.querySelectorAll('.score-item-value');
            if (scoreItems.length >= 3) {
                scoreItems[1].textContent = passedSteps;
                scoreItems[1].className = `score-item-value ${completionRate === 100 ? 'pass' : 'fail'}`;
                scoreItems[2].textContent = `${completionRate}%`;
                scoreItems[2].className = `score-item-value ${completionRate === 100 ? 'pass' : 'fail'}`;
            }

// Êõ¥Êñ∞ÊØèÂÄãÊ≠•È©üÁöÑÁãÄÊÖã
let checklistItemIndex = 0; // Âè™Êõ¥Êñ∞ÂØ¶ÈöõÊ≠•È©üÔºåË∑≥ÈÅéÁ´†ÁØÄÊ®ôÈ°å
item.checklist.forEach((step, index) => {
    // Ë∑≥ÈÅéÁ´†ÁØÄÊ®ôÈ°å
    if (step.isSubtitle) {
        return;
    }
    
    const status = checklistStatus[index] || 'pending';
    const checklistItems = card.querySelectorAll('.checklist-item');
    
    if (checklistItems[checklistItemIndex]) {
        checklistItems[checklistItemIndex].className = `checklist-item ${step.critical ? 'critical' : ''} ${status === 'pass' ? 'completed' : status === 'fail' ? 'failed' : ''}`;
        
        const statusTextDiv = checklistItems[checklistItemIndex].querySelector('div[style*="margin: 8px"]');
        if (statusTextDiv) {
            if (status === 'pass') {
                statusTextDiv.textContent = '‚úÖ ÂêàÊ†º';
            } else if (status === 'fail') {
                statusTextDiv.textContent = '‚ùå ‰∏çÂêàÊ†º';
            } else {
                statusTextDiv.textContent = '‚è≥ ÂæÖË©ïÊ†∏';
            }
        }
    }
    
    checklistItemIndex++; // Âè™Âú®ÂØ¶ÈöõÊ≠•È©üÊôÇÂ¢ûÂä†Á¥¢Âºï
});

            // Êõ¥Êñ∞Êï¥È´îÁãÄÊÖã
            const allCriticalPassed = item.checklist.every((step, index) => {
                if (!step.critical) return true;
                return checklistStatus[index] === 'pass';
            });

            let overallStatus = '';
            let overallClass = '';
            
            if (allCriticalPassed && completionRate === 100 && record?.status === 'completed') {
                overallStatus = '‚úÖ Â∑≤ÂÆåÊàê';
                overallClass = 'completed';
                card.classList.add('completed');
            } else {
                card.classList.remove('completed');
                if (!allCriticalPassed) {
overallStatus = '‚ö†Ô∏è Â∞öÊúâ Critical Ê≠•È©üÊú™ÈÄöÈÅé';
                } else if (completionRate < 100) {
                    overallStatus = `‚ö†Ô∏è ÂÆåÊàêÁéá ${completionRate}%`;
                } else {
                    overallStatus = '‚è≥ ÂæÖÂÆåÊàê';
                }
            }

const overallStatusElement = card.querySelector('.score-info .score-item-value[style*="font-size: 1.1em"]');
            if (overallStatusElement) {
                overallStatusElement.textContent = overallStatus;
                overallStatusElement.className = `score-item-value ${overallClass}`;
            }
        }
    } catch (error) {
        console.error('Âà∑Êñ∞Âç°ÁâáÂ§±Êïó:', error);
    }
}

        // ==================== ÂÑ≤Â≠òÂÇôË®ª ====================
        async function saveRemark(itemId, stepIndex) {
            const remarkText = document.getElementById(`remark_${itemId}_${stepIndex}`).value;

            try {
                const recordsSnapshot = await db.collection('trainingRecords')
                    .where('userId', '==', currentStaffId)
                    .where('itemId', '==', itemId)
                    .limit(1)
                    .get();

                let remarks = {};
                let checklistStatus = {};

                if (!recordsSnapshot.empty) {
                    const record = recordsSnapshot.docs[0].data();
                    remarks = record.remarks || {};
                    checklistStatus = record.checklistStatus || {};
                }

                remarks[stepIndex] = remarkText;

                const recordData = {
                    userId: currentStaffId,
                    itemId: itemId,
                    checklistStatus: checklistStatus,
                    remarks: remarks,
                    status: 'pending',
                    evaluatedBy: currentUser.docId,
                    evaluatedAt: new Date().toISOString()
                };

                if (recordsSnapshot.empty) {
                    await db.collection('trainingRecords').add(recordData);
                } else {
                    await db.collection('trainingRecords').doc(recordsSnapshot.docs[0].id).update(recordData);
                }

                showToast('‚úÖ ÂÇôË®ªÂ∑≤ÂÑ≤Â≠ò', 'success');
            } catch (error) {
                console.error('ÂÑ≤Â≠òÂÇôË®ªÂ§±Êïó:', error);
                showToast('‚ùå ÂÑ≤Â≠òÂ§±Êïó', 'error');
            }
        }

// ==================== Ê®ôË®òÈ†ÖÁõÆÂÆåÊàê ====================
async function markItemComplete(itemId) {
    try {
        // ÂÖàÊ™¢Êü•ÊòØÂê¶Êúâ Critical Ê≠•È©üÊú™ÈÄöÈÅé
        const itemDoc = await db.collection('trainingItems').doc(itemId).get();
        const item = itemDoc.data();
        
        if (item.hasChecklist) {
            const recordsSnapshot = await db.collection('trainingRecords')
                .where('userId', '==', currentStaffId)
                .where('itemId', '==', itemId)
                .limit(1)
                .get();
            
            if (!recordsSnapshot.empty) {
                const record = recordsSnapshot.docs[0].data();
                const checklistStatus = record.checklistStatus || {};
                
    // Ê™¢Êü•ÊòØÂê¶Êúâ Critical Ê≠•È©ü‰∏çÂêàÊ†ºÔºàÊéíÈô§Á´†ÁØÄÊ®ôÈ°åÔºâ
const hasCriticalFailed = item.checklist.some((step, index) => {
    return !step.isSubtitle && step.critical && checklistStatus[index] === 'fail';
});

// ...

// Ê™¢Êü•ÊòØÂê¶ÊâÄÊúâ Critical Ê≠•È©üÈÉΩÈÄöÈÅéÔºàÊéíÈô§Á´†ÁØÄÊ®ôÈ°åÔºâ
const allCriticalPassed = item.checklist.every((step, index) => {
    if (step.isSubtitle || !step.critical) return true;
    return checklistStatus[index] === 'pass';
});
                
                if (!allCriticalPassed) {
                    showToast('‚ùå Â∞öÊúâ Critical Ê≠•È©üÊú™Ë©ïÊ†∏ÔºåÁÑ°Ê≥ïÊ®ôË®òÂÆåÊàê', 'error');
                    return;
                }
            } else {
                showToast('‚ùå Ë´ãÂÖàÂÆåÊàêË©ïÊ†∏ÔºåÊâçËÉΩÊ®ôË®òÂÆåÊàê', 'error');
                return;
            }
        }
        
        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        const recordData = {
            status: 'completed',
            evaluatedBy: currentUser.docId,
            evaluatedAt: new Date().toISOString()
        };

        if (recordsSnapshot.empty) {
            recordData.userId = currentStaffId;
            recordData.itemId = itemId;
            await db.collection('trainingRecords').add(recordData);
        } else {
            await db.collection('trainingRecords').doc(recordsSnapshot.docs[0].id).update(recordData);
        }

        showToast('‚úÖ È†ÖÁõÆÂ∑≤Ê®ôË®òÂÆåÊàê', 'success');
        showCategoryEvaluation(currentCategoryId);
    } catch (error) {
        console.error('Ê®ôË®òÂÆåÊàêÂ§±Êïó:', error);
        showToast('‚ùå Êìç‰ΩúÂ§±Êïó', 'error');
    }
}
        
        // ==================== Ê®ôË®òÈ†ÖÁõÆÊú™ÂÆåÊàêÔºàÈáçË®≠Ôºâ====================
        async function markItemIncomplete(itemId) {
            try {
                const recordsSnapshot = await db.collection('trainingRecords')
                    .where('userId', '==', currentStaffId)
                    .where('itemId', '==', itemId)
                    .limit(1)
                    .get();

                if (!recordsSnapshot.empty) {
                    await db.collection('trainingRecords').doc(recordsSnapshot.docs[0].id).delete();
                }

                showToast('‚úÖ È†ÖÁõÆÂ∑≤ÈáçË®≠', 'success');
                showCategoryEvaluation(currentCategoryId);
            } catch (error) {
                console.error('ÈáçË®≠Â§±Êïó:', error);
                showToast('‚ùå Êìç‰ΩúÂ§±Êïó', 'error');
            }
        }

        // ==================== ËøîÂõûÂüπË®ìÈÄ≤Â∫¶ ====================
        function backToProgress() {
            showTrainingProgress(currentStaffId);
        }

        // ==================== ËøîÂõûÂì°Â∑•ÂàóË°® ====================
        function backToStaffList() {
            if (currentUser.role === 'staff') {
                showMainPage();
            } else {
                showStaffList(currentStaffLevel);
            }
        }

        // ==================== ÂåØÂá∫ PDF ====================
        async function exportToPDF() {
            try {
                showToast('üìÑ Ê≠£Âú®ÁîüÊàê PDF...', 'warning');

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const staffDoc = await db.collection('accounts').doc(currentStaffId).get();
                const staff = staffDoc.data();

                doc.setFontSize(20);
                doc.text('TKOH OT Training System', 105, 20, { align: 'center' });
                
                doc.setFontSize(16);
                doc.text(`Staff: ${staff.name}`, 105, 30, { align: 'center' });
                doc.text(`Level: ${staff.level}`, 105, 40, { align: 'center' });
                doc.text(`Join Date: ${staff.joinDate}`, 105, 50, { align: 'center' });

                let yPos = 70;

                const staffTrainingType = ['PCA1', 'PCA2', 'PCA3'].includes(staff.level) ? 'PCA' : 'OTA';

                const categoriesSnapshot = await db.collection('trainingCategories')
                    .where('trainingType', '==', staffTrainingType)
                    .get();
                
                const categories = [];
                categoriesSnapshot.forEach(doc => {
                    categories.push({ docId: doc.id, ...doc.data() });
                });
                categories.sort((a, b) => (a.order || 0) - (b.order || 0));
                
                const recordsSnapshot = await db.collection('trainingRecords')
                    .where('userId', '==', currentStaffId)
                    .get();

                const records = {};
                recordsSnapshot.forEach(doc => {
                    const record = doc.data();
                    records[record.itemId] = record;
                });

                for (const category of categories) {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }

                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${category.emoji} ${category.name}`, 20, yPos);
                    yPos += 10;

                    const itemsSnapshot = await db.collection('trainingItems')
                        .where('categoryId', '==', category.docId)
                        .get();

                    const items = [];
                    itemsSnapshot.forEach(doc => {
                        items.push({ docId: doc.id, ...doc.data() });
                    });
                    items.sort((a, b) => (a.order || 0) - (b.order || 0));

                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');

                    items.forEach(item => {
                        const record = records[item.docId];

                        let status = 'Pending';
                        let completion = '0%';
                        
                        if (item.hasChecklist && record?.checklistStatus) {
                            let passedSteps = 0;
                            
                            item.checklist.forEach((step, index) => {
                                if (record.checklistStatus[index] === 'pass') {
                                    passedSteps++;
                                }
                            });
                            
                            const completionRate = Math.round((passedSteps / item.checklist.length) * 100);
                            
                            const allCriticalPassed = item.checklist.every((step, index) => {
                                if (!step.critical) return true;
                                return record.checklistStatus[index] === 'pass';
                            });
                            
                            completion = `${completionRate}%`;
                            status = allCriticalPassed && completionRate === 100 && record.status === 'completed' ? 'Completed' : 'Pending';
                        } else if (record) {
                            status = record.status === 'completed' ? 'Completed' : 'Failed';
                            completion = status === 'Completed' ? '100%' : '0%';
                        }

                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }

                        doc.text(`- ${item.name}: ${status} [${completion}]`, 25, yPos);
                        yPos += 7;
                    });

                    yPos += 5;
                }

                doc.save(`${staff.name}_Training_Report.pdf`);
                showToast('‚úÖ PDF Â∑≤ÂåØÂá∫', 'success');
            } catch (error) {
                console.error('ÂåØÂá∫ PDF Â§±Êïó:', error);
                showToast('‚ùå ÂåØÂá∫ PDF Â§±Êïó', 'error');
            }
        }

        // ==================== Â∑•ÂÖ∑ÂáΩÊï∏ ====================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        function showModal(title, body) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                closeModal();
            }
        });

        document.getElementById('loginPw').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                login();
            }
        });

        // ==================== AUDIT SYSTEM ====================
let currentAuditLocation = '';
let currentAuditData = {};
let currentAuditId = null;

// ==================== Quiz Á≥ªÁµ±ÂÖ®ÂüüËÆäÊï∏ ====================
let currentQuizCategoryId = '';
let currentQuizRecordId = null;
let quizAnswers = {};

// ==================== ÂØ©Ê†∏Ê®°ÊùøÊï∏Êìö ====================
const AUDIT_TEMPLATE = {
    section1: {
        name: "Á¨¨‰∏ÄÈÉ®ÂàÜ: Ê∂àÊØíÊ∂≤Ê™¢Êü•",
        items: [
            {
                id: "1",
                name: "Ê∂àÊØíÊ∂≤ÊüìËèåÈáè(CFU/ml)",
                type: "category",
                subItems: [
                    { id: "1a", name: "ÊâãÊ¥óSinkÁõ§", type: "checkbox" },
                    { id: "1b", name: "Ë∂ÖËÅ±Ê≥¢Ê©ü", type: "checkbox", hasEquipmentNo: true, equipmentLabel: "USG no" },
                    { id: "1c", name: "Ê∏ÖÊ¥óÊ∂àÊØíÊ©ü", type: "checkbox", hasEquipmentNo: true, equipmentLabel: "Washer no" }
                ]
            },
            {
                id: "2",
                name: "Ê∂àÊØíÊ∂≤‰ΩøÁî®Èáè (9-1pm/ 1-4pm/ 4-7pm)",
                type: "category",
                subItems: [
                    { id: "2a", name: "ÊâãÊ¥óSinkÁõ§", type: "measurement" },
                    { id: "2b", name: "Ë∂ÖËÅ±Ê≥¢Ê©ü", type: "measurement" },
                    { id: "2c", name: "Ê∏ÖÊ¥óÊ∂àÊØíÊ©ü", type: "measurement", hasEquipmentNo: true, equipmentLabel: "Washer no" }
                ]
            },
            {
                id: "3",
                name: "Stella Tristel FuseÊ∂àÊØíÊ∂≤",
                type: "category",
                subItems: [
                    { id: "3a", name: "ÊøÉÂ∫¶", type: "yesno", hasValue: true },
                    { id: "3b", name: "Ê∂àÊØíÊôÇÈñì", type: "yesno", hasValue: true },
                    { id: "3c", name: "Ê∂àÊØíÊôÇÊ∫´Â∫¶", type: "yesno", hasValue: true }
                ]
            },
            {
                id: "4",
                name: "Hemosol Ê∫∂Ë°ÄÁ≤â‰ΩøÁî®Èáè (9-1pm/ 1-4pm/ 4-7pm)",
                type: "single",
                subItems: [
                    { id: "4a", name: "Hemosol Ê∫∂Ë°ÄÁ≤â‰ΩøÁî®Èáè", type: "measurement" }
                ]
            }
        ]
    },
    section2: {
        name: "Á¨¨‰∫åÈÉ®ÂàÜ: Áâ©‰ª∂Ë°®Èù¢ÂæÆÁîüÁâ©Ê±°ÊüìÊ™¢Êü•",
        items: [
            {
                id: "1",
                name: "Áâ©‰ª∂Ë°®Èù¢ËèåËêΩÁ∏ΩÈáè(CFU/cm¬≤)",
                type: "category",
                subItems: [
                    { id: "1a", name: "ÊâãÊ¥óSinkÁõ§", type: "checkbox" },
                    { id: "1b", name: "Ê†∏Â∞çÂÑÄÂô®Â∑•‰ΩúÊû±Èù¢", type: "checkbox" },
                    { id: "1c", name: "Ê∏ÖÊ¥óÊ∂àÊØíÊ©üË°®Èù¢", type: "checkbox", hasEquipmentNo: true, equipmentLabel: "Washer no" },
                    { id: "1d", name: "Cart WasherË°®Èù¢", type: "checkbox" }
                ]
            }
        ]
    },
    section3: {
        name: "Á¨¨‰∏âÈÉ®ÂàÜ: Ê∞¥Ë≥™Ê™¢Êü•",
        items: [
            {
                id: "1",
                name: "ËèåËêΩÁ∏ΩÈáè(CFU/cm¬≤)",
                type: "category",
                subItems: [
                    { id: "1a", name: "Ëá™‰æÜÊ∞¥", type: "checkbox", hasValue: true, valueLabel: "Êï∏ÂÄº" },
                    { id: "1b", name: "ROÊ∞¥ -ÂáçÊ∞¥Âá∫Âè£‰Ωç", type: "checkbox", hasValue: true, valueLabel: "Êï∏ÂÄº" },
                    { id: "1c", name: "ROÊ∞¥ -ÁÜ±Ê∞¥Âá∫Âè£‰Ωç", type: "checkbox", hasValue: true, valueLabel: "Êï∏ÂÄº" }
                ]
            }
        ]
    },
    section4: {
        name: "Á¨¨ÂõõÈÉ®ÂàÜ: ÊøïÁÜ±Ê∂àÊØíThermal Disinfection",
        items: [
            {
                id: "1",
                name: "ÊòØÂê¶ÊúâË®òÈåÑÊØèÊ¨°Ê∏ÖÊØíÊ∫´Â∫¶ËàáÊôÇÈñì/ A‚ÇÄÂÄº",
                type: "category",
                subItems: [
                    { id: "1a", name: "ÊâãÊ¥óSinkÁõ§", type: "checkbox" },
                    { id: "1b", name: "Ê†∏Â∞çÂÑÄÂô®Â∑•‰ΩúÊû±Èù¢", type: "checkbox" },
                    { id: "1c", name: "Ê∏ÖÊ¥óÊ∂àÊØíÊ©üË°®Èù¢", type: "checkbox", hasEquipmentNo: true, equipmentLabel: "Washer no" },
                    { id: "1d", name: "Cart WasherË°®Èù¢", type: "checkbox" }
                ]
            }
        ]
    },
    section5: {
        name: "Á¨¨‰∫îÈÉ®ÂàÜ: Ê∏ÖÊ¥óË≥™Èáè",
        subtitle: "ÊäΩÊü•3-5ÂÄãÂæÖÊªÖËèåÂåÖÂÖßÂÖ®ÈÉ®Áâ©ÂìÅ",
        hasInstrumentCode: true,
        hasDisinfectionMethod: true,
        items: [
            {
                id: "1",
                name: "Ê∏ÖÊ¥óË≥™Èáè(Ê∏ÖÊΩîÂ∫¶: ÁÑ°Ë°ÄÊº¨„ÄÅÊ±°Êº¨„ÄÅÊ∞¥Âû¢Á≠âÊÆòÁïôÁâ©Ë≥™ÂíåÈäπÊñë)",
                type: "category",
                subItems: [
                    { id: "1a", name: "ÂÑÄÂô®Ë°®Èù¢", type: "checkbox" },
                    { id: "1b", name: "ÂÑÄÂô®ÁÆ°ÈÅì", type: "checkbox" },
                    { id: "1c", name: "ÁâôÈΩí‰Ωç", type: "checkbox" },
                    { id: "1d", name: "ÈóúÁØÄËºÉ‰Ωç", type: "checkbox" }
                ]
            },
            {
                id: "2",
                name: "Ê∏ÖÊ¥óË≥™Èáè(ÂÑÄÂô®Ê¥ªÂãïÈ†ÜÊö¢Â∫¶)",
                type: "single",
                subItems: [
                    { id: "2a", name: "ÂÑÄÂô®Ê¥ªÂãïÈ†ÜÊö¢Â∫¶", type: "checkbox" }
                ]
            },
            {
                id: "3",
                name: "ËõãÁôΩÊ∏¨Ë©¶ (Protein Test)",
                type: "single",
                subItems: [
                    { id: "3a", name: "ËõãÁôΩÊ∏¨Ë©¶", type: "checkbox" }
                ]
            }
        ]
    },
    section6: {
        name: "Á¨¨ÂÖ≠ÈÉ®ÂàÜ: Ê∏ÖÊ¥óÊ∂àÊØíÂô®ÂèäË≥™ÈáèÁõ£Ê∏¨",
        items: [
            {
                id: "1",
                name: "Áõ£Ê∏¨Ê∏ÖÊ¥óÊ∂àÊØíÂô®ÁöÑÁâ©ÁêÜÂèÉÊï∏",
                type: "single",
                subItems: [
                    { id: "1a", name: "Áõ£Ê∏¨Ê∏ÖÊ¥óÊ∂àÊØíÂô®ÁöÑÁâ©ÁêÜÂèÉÊï∏", type: "checkbox" }
                ]
            },
            {
                id: "2",
                name: "Â¶•ÂñÑË®òÈåÑÁâ©ÁêÜÂèÉÊï∏ÂèäÈÅãËΩâÊÉÖÊ≥Å",
                type: "single",
                subItems: [
                    { id: "2a", name: "Â¶•ÂñÑË®òÈåÑÁâ©ÁêÜÂèÉÊï∏ÂèäÈÅãËΩâÊÉÖÊ≥Å", type: "checkbox" }
                ]
            }
        ]
    }
};

// ==================== ÈñãÂßãÊñ∞ÂØ©Ê†∏ ====================
function startNewAudit() {
    currentAuditData = {};
    currentAuditId = null;
    showPage('selectLocationPage');
}

// ==================== ÈÅ∏ÊìáÂú∞Èªû ====================
function selectLocation(location) {
    currentAuditLocation = location;
    renderAuditForm();
}

// ==================== Ê∏≤ÊüìÂØ©Ê†∏Ë°®Ê†º ====================
function renderAuditForm() {
    const locationName = currentAuditLocation === '2F_DA' ? '2/F DA' : 'LG/F DA';
    document.getElementById('auditFormTitle').textContent = `Ê∂àÊØíË≥™ÈáèÁõ£Ê∏¨ (ÂéªÊ±°ÂçÄ) - ${locationName}`;
    
    let formHtml = `
        <div class="audit-section">
            <div class="input-group">
                <label>üìÖ Ë≥™ÈáèÁõ£Ê∏¨Êó•Êúü</label>
                <input type="date" id="auditDate" value="${new Date().toISOString().split('T')[0]}">
            </div>
            <div class="input-group">
                <label>üë§ Ë≥™ÈáèÁõ£Ê∏¨Ë≤†Ë≤¨Âêå‰∫ã</label>
                <input type="text" id="auditStaff" value="${currentUser.name}">
            </div>
            <div class="input-group">
                <label>üìç Ë≥™ÈáèÁõ£Ê∏¨Âú∞Èªû</label>
                <input type="text" value="${locationName}" disabled style="background: #f0f0f0;">
            </div>
        </div>
    `;

    // ÁîüÊàêÂêÑÈÉ®ÂàÜ
    Object.keys(AUDIT_TEMPLATE).forEach(sectionKey => {
        const section = AUDIT_TEMPLATE[sectionKey];
        formHtml += `<div class="audit-section">`;
        formHtml += `<div class="audit-section-title">${section.name}</div>`;
        
        if (section.subtitle) {
            formHtml += `<div style="color: #666; margin-bottom: 15px; font-style: italic;">${section.subtitle}</div>`;
        }
        
        if (section.hasInstrumentCode) {
            formHtml += `
                <div class="input-group">
                    <label>üîç ÊäΩÊü•ÂÑÄÂô®SITS CODE</label>
                    <input type="text" id="instrumentCode" placeholder="Ë´ãËº∏ÂÖ•ÂÑÄÂô®Á∑®Ëôü">
                </div>
            `;
        }
        
        if (section.hasDisinfectionMethod) {
            formHtml += `
                <div class="input-group">
                    <label>üß™ ÊâÄ‰ΩøÁî®Ê∂àÊØíÊñπÂºè</label>
                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="disinfectionMethod" value="thermal" style="width: auto;">
                            <span>ÊøïÁÜ±Ê∂àÊØí (Thermal Disinfection)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="disinfectionMethod" value="chemical" style="width: auto;">
                            <span>ÂåñÂ≠∏Ê∂àÊØí (Chemical Disinfection)</span>
                        </label>
                    </div>
                </div>
            `;
        }
        
        section.items.forEach(item => {
            if (item.type === "category" && item.subItems) {
                formHtml += `<div class="subsection-title">${item.name}</div>`;
                item.subItems.forEach(subItem => {
                    formHtml += renderAuditItem(sectionKey, item.id, subItem);
                });
            } else if (item.type === "single" && item.subItems) {
                item.subItems.forEach(subItem => {
                    formHtml += `<div class="subsection-title">${item.name}</div>`;
                    formHtml += renderAuditItem(sectionKey, item.id, subItem);
                });
            }
        });
        
        formHtml += `</div>`;
    });

    document.getElementById('auditFormContent').innerHTML = formHtml;
    showPage('auditFormPage');
}

// ==================== Ê∏≤ÊüìÂñÆÂÄãÂØ©Ê†∏È†ÖÁõÆ ====================
function renderAuditItem(sectionKey, itemId, subItem) {
    const fullId = `${sectionKey}_${itemId}_${subItem.id}`;
    
    let html = `<div class="audit-item-row">`;
    html += `<div class="audit-item-name">`;
    
    if (subItem.hasEquipmentNo) {
        html += `${subItem.name} <input type="text" placeholder="${subItem.equipmentLabel}" id="${fullId}_equipment" 
                 style="width: 120px; margin-left: 10px; padding: 4px 8px; border: 1px solid #e0e0e0; border-radius: 4px;">`;
    } else {
        html += subItem.name;
    }
    
    html += `</div>`;
    
    if (subItem.type === "checkbox") {
        html += `
            <div class="audit-checkbox-group">
                <input type="radio" name="${fullId}" value="pass" id="${fullId}_pass">
                <label for="${fullId}_pass">ÂêàÊ†º</label>
            </div>
            <div class="audit-checkbox-group">
                <input type="radio" name="${fullId}" value="fail" id="${fullId}_fail">
                <label for="${fullId}_fail">‰∏çÂêàÊ†º</label>
            </div>
            <div class="audit-checkbox-group">
                <input type="radio" name="${fullId}" value="na" id="${fullId}_na">
                <label for="${fullId}_na">‰∏çÈÅ©Áî®</label>
            </div>
        `;
        
        if (subItem.hasValue) {
            html += `<input type="text" class="audit-remark-input" id="${fullId}_value" placeholder="${subItem.valueLabel || 'ÂÇôË®ª'}">`;
        } else {
            html += `<input type="text" class="audit-remark-input" id="${fullId}_remark" placeholder="ÂÇôË®ª">`;
        }
    } else if (subItem.type === "measurement") {
        html += `<div style="grid-column: 2 / -1;">`;
        html += `<div class="audit-measurement-group">`;
        html += `
            <div class="audit-measurement-item">
                <label>Áî®ÂâçÂàªÂ∫¶ (cm)</label>
                <input type="number" id="${fullId}_before" placeholder="0">
            </div>
            <div class="audit-measurement-item">
                <label>Áî®ÂæåÂàªÂ∫¶ (cm)</label>
                <input type="number" id="${fullId}_after" placeholder="0">
            </div>
            <div class="audit-measurement-item">
                <label>Áî®Èáè (ml)</label>
                <input type="number" id="${fullId}_usage" placeholder="0" readonly style="background: #f0f0f0;">
            </div>
        `;
        html += `</div></div>`;
        
        // Ëá™ÂãïË®àÁÆóÁî®Èáè
        setTimeout(() => {
            const beforeInput = document.getElementById(`${fullId}_before`);
            const afterInput = document.getElementById(`${fullId}_after`);
            const usageInput = document.getElementById(`${fullId}_usage`);
            
            if (beforeInput && afterInput && usageInput) {
                const calculateUsage = () => {
                    const before = parseFloat(beforeInput.value) || 0;
                    const after = parseFloat(afterInput.value) || 0;
                    usageInput.value = Math.abs(before - after) * 1000;
                };
                
                beforeInput.addEventListener('input', calculateUsage);
                afterInput.addEventListener('input', calculateUsage);
            }
        }, 100);
    } else if (subItem.type === "yesno") {
        html += `<div style="grid-column: 2 / 4;">`;
        html += `<input type="text" class="audit-remark-input" id="${fullId}_value" placeholder="Ë´ãËº∏ÂÖ•${subItem.name}">`;
        html += `</div>`;
        html += `<div style="grid-column: 4 / 5; display: flex; gap: 10px; align-items: center;">`;
        html += `
            <label style="display: flex; align-items: center; gap: 5px; margin: 0;">
                <input type="radio" name="${fullId}_yn" value="Y" style="width: auto;">
                <span>Á¨¶ÂêàË¶èÂÆö</span>
            </label>
            <label style="display: flex; align-items: center; gap: 5px; margin: 0;">
                <input type="radio" name="${fullId}_yn" value="N" style="width: auto;">
                <span>‰∏çÁ¨¶Âêà</span>
            </label>
        `;
        html += `</div>`;
        html += `<input type="text" class="audit-remark-input" id="${fullId}_remark" placeholder="ÂÇôË®ª">`;
    }
    
    html += `</div>`;
    return html;
}

// ==================== Êî∂ÈõÜÂØ©Ê†∏Êï∏Êìö ====================
function collectAuditData() {
    const data = {
        date: document.getElementById('auditDate').value,
        staff: document.getElementById('auditStaff').value,
        location: currentAuditLocation,
        sections: {},
        instrumentCode: document.getElementById('instrumentCode')?.value || '',
        disinfectionMethod: document.querySelector('input[name="disinfectionMethod"]:checked')?.value || ''
    };

    let totalItems = 0;
    let passedItems = 0;
    let failedItems = 0;
    let naItems = 0;

    Object.keys(AUDIT_TEMPLATE).forEach(sectionKey => {
        const section = AUDIT_TEMPLATE[sectionKey];
        data.sections[sectionKey] = {};

        section.items.forEach(item => {
            item.subItems.forEach(subItem => {
                const fullId = `${sectionKey}_${item.id}_${subItem.id}`;
                const itemData = {};

                if (subItem.type === "checkbox") {
                    const selected = document.querySelector(`input[name="${fullId}"]:checked`);
                    itemData.status = selected ? selected.value : null;
                    itemData.remark = document.getElementById(`${fullId}_remark`)?.value || '';
                    
                    if (subItem.hasValue) {
                        itemData.value = document.getElementById(`${fullId}_value`)?.value || '';
                    }
                    
                    if (subItem.hasEquipmentNo) {
                        itemData.equipmentNo = document.getElementById(`${fullId}_equipment`)?.value || '';
                    }

                    if (itemData.status) {
                        totalItems++;
                        if (itemData.status === 'pass') passedItems++;
                        else if (itemData.status === 'fail') failedItems++;
                        else if (itemData.status === 'na') naItems++;
                    }
                } else if (subItem.type === "measurement") {
                    itemData.before = document.getElementById(`${fullId}_before`)?.value || '';
                    itemData.after = document.getElementById(`${fullId}_after`)?.value || '';
                    itemData.usage = document.getElementById(`${fullId}_usage`)?.value || '';
                    
                    if (subItem.hasEquipmentNo) {
                        itemData.equipmentNo = document.getElementById(`${fullId}_equipment`)?.value || '';
                    }
                } else if (subItem.type === "yesno") {
                    itemData.value = document.getElementById(`${fullId}_value`)?.value || '';
                    const ynSelected = document.querySelector(`input[name="${fullId}_yn"]:checked`);
                    itemData.compliance = ynSelected ? ynSelected.value : null;
                    itemData.remark = document.getElementById(`${fullId}_remark`)?.value || '';

                    if (itemData.compliance) {
                        totalItems++;
                        if (itemData.compliance === 'Y') passedItems++;
                        else failedItems++;
                    }
                }

                data.sections[sectionKey][fullId] = itemData;
            });
        });
    });

    // Ë®àÁÆóÂêàÊ†ºÁéá
    const validItems = totalItems - naItems;
    data.passRate = validItems > 0 ? Math.round((passedItems / validItems) * 100) : 0;
    data.totalItems = totalItems;
    data.passedItems = passedItems;
    data.failedItems = failedItems;
    data.naItems = naItems;
    data.isPassed = data.passRate >= 80;

    return data;
}

// ==================== ÂÑ≤Â≠òËçâÁ®ø ====================
async function saveAuditDraft() {
    try {
        const data = collectAuditData();
        data.status = 'draft';
        data.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
        data.auditorId = currentUser.docId;
        data.auditorName = currentUser.name;

        if (currentAuditId) {
            await db.collection('auditRecords').doc(currentAuditId).update(data);
        } else {
            const docRef = await db.collection('auditRecords').add({
                ...data,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            currentAuditId = docRef.id;
        }

        showToast('‚úÖ ËçâÁ®øÂ∑≤ÂÑ≤Â≠ò', 'success');
    } catch (error) {
        console.error('ÂÑ≤Â≠òËçâÁ®øÂ§±Êïó:', error);
        showToast('‚ùå ÂÑ≤Â≠òËçâÁ®øÂ§±Êïó', 'error');
    }
}

// ==================== Êèê‰∫§ÂØ©Ê†∏ ====================
async function submitAudit() {
    if (!confirm('‚ùì Á¢∫ÂÆöË¶ÅÊèê‰∫§Ê≠§ÂØ©Ê†∏Ë®òÈåÑÂóéÔºüÊèê‰∫§ÂæåÂ∞áÁÑ°Ê≥ï‰øÆÊîπ„ÄÇ')) {
        return;
    }

    try {
        const data = collectAuditData();
        
        if (!data.date || !data.staff) {
            showToast('‚ùå Ë´ãÂ°´ÂØ´ÂøÖÂ°´Ê¨Ñ‰ΩçÔºàÊó•Êúü„ÄÅË≤†Ë≤¨Âêå‰∫ãÔºâ', 'error');
            return;
        }

        data.status = 'completed';
        data.submittedAt = firebase.firestore.FieldValue.serverTimestamp();
        data.auditorId = currentUser.docId;
        data.auditorName = currentUser.name;

        if (currentAuditId) {
            await db.collection('auditRecords').doc(currentAuditId).update(data);
        } else {
            await db.collection('auditRecords').add({
                ...data,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        showToast(`‚úÖ ÂØ©Ê†∏Â∑≤Êèê‰∫§ (ÂêàÊ†ºÁéá: ${data.passRate}%)`, 'success');
        currentAuditId = null;
        currentAuditData = {};
        showPage('auditMainPage');
    } catch (error) {
        console.error('Êèê‰∫§ÂØ©Ê†∏Â§±Êïó:', error);
        showToast('‚ùå Êèê‰∫§ÂØ©Ê†∏Â§±Êïó', 'error');
    }
}

// ==================== ÂèñÊ∂àÂØ©Ê†∏ ====================
function cancelAudit() {
    if (confirm('‚ùì Á¢∫ÂÆöË¶ÅÂèñÊ∂àÂóéÔºüÊú™ÂÑ≤Â≠òÁöÑË≥áÊñôÂ∞áÊúÉÈÅ∫Â§±„ÄÇ')) {
        currentAuditId = null;
        currentAuditData = {};
        showPage('auditMainPage');
    }
}

// ==================== Êü•ÁúãÊ≠∑Âè≤Ë®òÈåÑ (AuditBoard Style) ====================
async function viewAuditHistory() {
    showPage('auditHistoryPage');
    
    try {
        const snapshot = await db.collection('auditRecords')
            .orderBy('createdAt', 'desc')
            .get();

        if (snapshot.empty) {
            document.getElementById('auditHistoryContent').innerHTML = `
                <div class="audit-empty-state">
                    <div class="audit-empty-icon">üì≠</div>
                    <div class="audit-empty-title">Â∞öÁÑ°ÂØ©Ê†∏Ë®òÈåÑ</div>
                    <div class="audit-empty-desc">ÈñãÂßãÁ¨¨‰∏ÄÊ¨°Ë≥™ÈáèÁõ£Ê∏¨ÂØ©Ê†∏</div>
                </div>
            `;
            return;
        }

        let historyHtml = '';
        snapshot.forEach(doc => {
            const record = doc.data();
            const locationName = record.location === '2F_DA' ? '2/F DA' : 'LG/F DA';
            const passClass = record.isPassed ? 'passed' : 'failed';
            const draftClass = record.status === 'draft' ? 'draft' : '';
            
            const statusBadge = record.status === 'draft' 
                ? '<span class="badge badge-warning">üìù ËçâÁ®ø</span>' 
                : '<span class="badge badge-success">‚úÖ Â∑≤Êèê‰∫§</span>';

            historyHtml += `
                <div class="audit-history-card-modern ${passClass} ${draftClass}" onclick="viewAuditDetail('${doc.id}')">
                    <div class="audit-card-header">
                        <div>
                            <div class="audit-card-date">üìÖ ${record.date}</div>
                            <div class="audit-card-location">üìç ${locationName} ${statusBadge}</div>
                        </div>
                        <div class="audit-card-score">
                            <div class="audit-score-big ${record.isPassed ? 'pass' : 'fail'}">
                                ${record.passRate}%
                            </div>
                            <div class="audit-score-label">ÂêàÊ†ºÁéá</div>
                        </div>
                    </div>

                    <div class="audit-card-details">
                        <div class="audit-detail-item">
                            <div class="audit-detail-value">${record.totalItems}</div>
                            <div class="audit-detail-label">Á∏ΩÈ†ÖÁõÆ</div>
                        </div>
                        <div class="audit-detail-item">
                            <div class="audit-detail-value success">${record.passedItems}</div>
                            <div class="audit-detail-label">‚úÖ ÂêàÊ†º</div>
                        </div>
                        <div class="audit-detail-item">
                            <div class="audit-detail-value danger">${record.failedItems}</div>
                            <div class="audit-detail-label">‚ùå ‰∏çÂêàÊ†º</div>
                        </div>
                        <div class="audit-detail-item">
                            <div class="audit-detail-value">${record.naItems}</div>
                            <div class="audit-detail-label">‚ö™ ‰∏çÈÅ©Áî®</div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; color: #64748b; font-size: 0.9em;">
                        üë§ ${record.staff}
                        ${record.isPassed ? 
                            '<span style="color: #10b981; margin-left: 15px;">‚óè ÂØ©Ê†∏ÈÄöÈÅé</span>' : 
                            '<span style="color: #ef4444; margin-left: 15px;">‚óè ÂØ©Ê†∏Êú™ÈÄöÈÅé</span>'}
                    </div>
                </div>
            `;
        });

        document.getElementById('auditHistoryContent').innerHTML = historyHtml;
    } catch (error) {
        console.error('ËºâÂÖ•Ê≠∑Âè≤Ë®òÈåÑÂ§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}

// ==================== Êü•ÁúãÂØ©Ê†∏Ë©≥ÊÉÖ ====================
async function viewAuditDetail(auditId) {
    showPage('auditDetailPage');
    
    try {
        const doc = await db.collection('auditRecords').doc(auditId).get();
        const record = doc.data();
        
        const locationName = record.location === '2F_DA' ? '2/F DA' : 'LG/F DA';
        document.getElementById('auditDetailTitle').textContent = 
            `ÂØ©Ê†∏Ë©≥ÊÉÖ - ${record.date} (${locationName})`;

        let detailHtml = `
            <div class="audit-summary">
                <div class="audit-summary-title">ÂØ©Ê†∏ÁµêÊûúÊëòË¶Å</div>
                <div class="audit-summary-rate">${record.passRate}%</div>
                <div class="audit-summary-status">
                    ${record.isPassed ? '‚úÖ ÂØ©Ê†∏ÈÄöÈÅé' : '‚ùå ÂØ©Ê†∏Êú™ÈÄöÈÅé'} 
                    (Ê®ôÊ∫ñ: ‚â•80%)
                </div>
                <div style="margin-top: 15px; font-size: 0.95em;">
                    ÂêàÊ†º: ${record.passedItems} | 
                    ‰∏çÂêàÊ†º: ${record.failedItems} | 
                    ‰∏çÈÅ©Áî®: ${record.naItems} | 
                    Á∏ΩË®à: ${record.totalItems}
                </div>
            </div>

            <div class="audit-section">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div>
                        <strong>üìÖ ÂØ©Ê†∏Êó•Êúü:</strong><br>${record.date}
                    </div>
                    <div>
                        <strong>üë§ Ë≤†Ë≤¨Âêå‰∫ã:</strong><br>${record.staff}
                    </div>
                    <div>
                        <strong>üìç Áõ£Ê∏¨Âú∞Èªû:</strong><br>${locationName}
                    </div>
                </div>
                ${record.instrumentCode ? `
                    <div style="margin-top: 15px;">
                        <strong>üîç ÂÑÄÂô®Á∑®Ëôü:</strong> ${record.instrumentCode}
                    </div>
                ` : ''}
                ${record.disinfectionMethod ? `
                    <div style="margin-top: 10px;">
                        <strong>üß™ Ê∂àÊØíÊñπÂºè:</strong> 
                        ${record.disinfectionMethod === 'thermal' ? 'ÊøïÁÜ±Ê∂àÊØí' : 'ÂåñÂ≠∏Ê∂àÊØí'}
                    </div>
                ` : ''}
            </div>
        `;

        // È°ØÁ§∫ÂêÑÈÉ®ÂàÜË©≥ÊÉÖ
        Object.keys(AUDIT_TEMPLATE).forEach(sectionKey => {
            const section = AUDIT_TEMPLATE[sectionKey];
            const sectionData = record.sections[sectionKey] || {};
            
            detailHtml += `
                <div class="audit-section">
                    <div class="audit-section-title">${section.name}</div>
            `;

            section.items.forEach(item => {
                if (item.subItems) {
                    detailHtml += `<div class="subsection-title">${item.name}</div>`;
                    
                    item.subItems.forEach(subItem => {
                        const fullId = `${sectionKey}_${item.id}_${subItem.id}`;
                        const itemData = sectionData[fullId] || {};
                        
                        let statusText = '';
                        let statusColor = '';
                        
                        if (subItem.type === "checkbox") {
                            if (itemData.status === 'pass') {
                                statusText = '‚úÖ ÂêàÊ†º';
                                statusColor = '#2ed573';
                            } else if (itemData.status === 'fail') {
                                statusText = '‚ùå ‰∏çÂêàÊ†º';
                                statusColor = '#ff4757';
                            } else if (itemData.status === 'na') {
                                statusText = '‚ö™ ‰∏çÈÅ©Áî®';
                                statusColor = '#999';
                            } else {
                                statusText = '‚è≥ Êú™Ë©ïÊ†∏';
                                statusColor = '#999';
                            }
                            
                            detailHtml += `
                                <div style="padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 6px; border-left: 4px solid ${statusColor};">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${subItem.name}</strong>
                                            ${itemData.equipmentNo ? ` (${subItem.equipmentLabel}: ${itemData.equipmentNo})` : ''}
                                            ${itemData.value ? `<br><span style="color: #666; font-size: 0.9em;">Êï∏ÂÄº: ${itemData.value}</span>` : ''}
                                        </div>
                                        <div style="color: ${statusColor}; font-weight: bold;">${statusText}</div>
                                    </div>
                                    ${itemData.remark ? `<div style="margin-top: 8px; color: #666; font-size: 0.9em;">üí¨ ${itemData.remark}</div>` : ''}
                                </div>
                            `;
                        } else if (subItem.type === "measurement") {
                            detailHtml += `
                                <div style="padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 6px;">
                                    <strong>${subItem.name}</strong>
                                    ${itemData.equipmentNo ? ` (${subItem.equipmentLabel}: ${itemData.equipmentNo})` : ''}
                                    <div style="margin-top: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9em;">
                                        <div>Áî®Ââç: <strong>${itemData.before || 'N/A'} cm</strong></div>
                                        <div>Áî®Âæå: <strong>${itemData.after || 'N/A'} cm</strong></div>
                                        <div>Áî®Èáè: <strong>${itemData.usage || 'N/A'} ml</strong></div>
                                    </div>
                                </div>
                            `;
                        } else if (subItem.type === "yesno") {
                            const complianceText = itemData.compliance === 'Y' ? '‚úÖ Á¨¶ÂêàË¶èÂÆö' : 
                                                 itemData.compliance === 'N' ? '‚ùå ‰∏çÁ¨¶Âêà' : '‚è≥ Êú™Ë©ïÊ†∏';
                            const complianceColor = itemData.compliance === 'Y' ? '#2ed573' : 
                                                  itemData.compliance === 'N' ? '#ff4757' : '#999';
                            
                            detailHtml += `
                                <div style="padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 6px; border-left: 4px solid ${complianceColor};">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${subItem.name}</strong>
                                            ${itemData.value ? `<br><span style="color: #666; font-size: 0.9em;">${itemData.value}</span>` : ''}
                                        </div>
                                        <div style="color: ${complianceColor}; font-weight: bold;">${complianceText}</div>
                                    </div>
                                    ${itemData.remark ? `<div style="margin-top: 8px; color: #666; font-size: 0.9em;">üí¨ ${itemData.remark}</div>` : ''}
                                </div>
                            `;
                        }
                    });
                }
            });

            detailHtml += `</div>`;
        });

        document.getElementById('auditDetailContent').innerHTML = detailHtml;
        
        window.currentViewingAuditId = auditId;
    } catch (error) {
        console.error('ËºâÂÖ•ÂØ©Ê†∏Ë©≥ÊÉÖÂ§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}

// ==================== ÂåØÂá∫ÂØ©Ê†∏ PDF ====================
async function exportAuditToPDF() {
    try {
        showToast('üìÑ Ê≠£Âú®ÁîüÊàê PDF...', 'warning');
        
        const doc = await db.collection('auditRecords').doc(window.currentViewingAuditId).get();
        const record = doc.data();
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        
        const locationName = record.location === '2F_DA' ? '2/F DA' : 'LG/F DA';
        
        pdf.setFontSize(16);
        pdf.text('TKOH - Decontamination Area Audit', 105, 20, { align: 'center' });
        
        pdf.setFontSize(12);
        pdf.text(`Date: ${record.date}`, 20, 35);
        pdf.text(`Location: ${locationName}`, 20, 42);
        pdf.text(`Staff: ${record.staff}`, 20, 49);
        pdf.text(`Pass Rate: ${record.passRate}% ${record.isPassed ? '(PASSED)' : '(FAILED)'}`, 20, 56);
        
        pdf.save(`Audit_${record.date}_${locationName}.pdf`);
        showToast('‚úÖ PDF Â∑≤ÂåØÂá∫', 'success');
    } catch (error) {
        console.error('ÂåØÂá∫ PDF Â§±Êïó:', error);
        showToast('‚ùå ÂåØÂá∫ PDF Â§±Êïó', 'error');
    }
}

        // ==================== ËºâÂÖ•ÂØ©Ê†∏Áµ±Ë®àÊï∏Êìö ====================
async function loadAuditStats() {
    try {
        const snapshot = await db.collection('auditRecords')
            .where('status', '==', 'completed')
            .get();

        if (snapshot.empty) {
            document.getElementById('statTotalAudits').textContent = '0';
            document.getElementById('statPassRate').textContent = '0%';
            document.getElementById('statThisMonth').textContent = '0';
            document.getElementById('statFailCount').textContent = '0';
            document.getElementById('recentAuditsPreview').innerHTML = `
                <div class="audit-empty-state" style="padding: 40px;">
                    <div class="audit-empty-icon" style="font-size: 3em;">üì≠</div>
                    <div class="audit-empty-desc">Â∞öÁÑ°ÂØ©Ê†∏Ë®òÈåÑ</div>
                </div>
            `;
            return;
        }

        let totalAudits = 0;
        let totalPassRate = 0;
        let thisMonthCount = 0;
        let failCount = 0;
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        let recentAudits = [];

        snapshot.forEach(doc => {
            const record = doc.data();
            totalAudits++;
            totalPassRate += record.passRate;
            
            if (!record.isPassed) failCount++;

            const recordDate = new Date(record.date);
            if (recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear) {
                thisMonthCount++;
            }

            recentAudits.push({ id: doc.id, ...record });
        });

        const avgPassRate = Math.round(totalPassRate / totalAudits);

        document.getElementById('statTotalAudits').textContent = totalAudits;
        document.getElementById('statPassRate').textContent = `${avgPassRate}%`;
        document.getElementById('statThisMonth').textContent = thisMonthCount;
        document.getElementById('statFailCount').textContent = failCount;

        if (avgPassRate >= 90) {
            document.getElementById('statTrend').textContent = 'üéâ Ë°®ÁèæÂÑ™Áï∞ÔºÅ';
            document.getElementById('statTrend').style.color = '#10b981';
        } else if (avgPassRate >= 80) {
            document.getElementById('statTrend').textContent = '‚úÖ Á¨¶ÂêàÊ®ôÊ∫ñ';
            document.getElementById('statTrend').style.color = '#10b981';
        } else {
            document.getElementById('statTrend').textContent = '‚ö†Ô∏è ÈúÄË¶ÅÊîπÂñÑ';
            document.getElementById('statTrend').style.color = '#f59e0b';
        }

        // È°ØÁ§∫ÊúÄËøë 3 Á≠ÜË®òÈåÑ
        recentAudits.sort((a, b) => new Date(b.date) - new Date(a.date));
        const recent3 = recentAudits.slice(0, 3);

        let recentHtml = '';
        if (recent3.length === 0) {
            recentHtml = '<div class="no-data-message">Â∞öÁÑ°Ë®òÈåÑ</div>';
        } else {
            recent3.forEach(record => {
                const locationName = record.location === '2F_DA' ? '2/F DA' : 'LG/F DA';
                const passClass = record.isPassed ? 'pass' : 'fail';
                
                recentHtml += `
                    <div class="audit-history-card-modern ${record.isPassed ? 'passed' : 'failed'}" 
                         onclick="viewAuditDetail('${record.id}')"
                         style="margin-bottom: 15px;">
                        <div class="audit-card-header">
                            <div>
                                <div class="audit-card-date" style="font-size: 1.1em;">üìÖ ${record.date}</div>
                                <div class="audit-card-location">üìç ${locationName}</div>
                            </div>
                            <div class="audit-card-score">
                                <div class="audit-score-big ${passClass}" style="font-size: 2em;">
                                    ${record.passRate}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        document.getElementById('recentAuditsPreview').innerHTML = recentHtml;
    } catch (error) {
        console.error('ËºâÂÖ•Áµ±Ë®àÊï∏ÊìöÂ§±Êïó:', error);
    }
}

// ‰øÆÊîπÂéüÊúâÁöÑ showPage ÂáΩÊï∏ÔºåÁï∂È°ØÁ§∫ auditMainPage ÊôÇËºâÂÖ•Áµ±Ë®àÊï∏Êìö
const originalShowPage = showPage;
showPage = function(pageId) {
    originalShowPage(pageId);
    if (pageId === 'auditMainPage') {
        loadAuditStats();
    }
};

        // ==================== Ë®ìÁ∑¥Ë®òÈåÑÁõ∏ÈóúÂáΩÊï∏ ====================

// ÂÑ≤Â≠òË®ìÁ∑¥Êó•Êúü
async function saveTrainingDate(itemId) {
    const date = document.getElementById(`trainingDate_${itemId}`).value;
    
    try {
        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        const recordData = {
            userId: currentStaffId,
            itemId: itemId,
            trainingDate: date,
            updatedBy: currentUser.docId,
            updatedAt: new Date().toISOString()
        };

        if (recordsSnapshot.empty) {
            await db.collection('trainingRecords').add(recordData);
        } else {
            await db.collection('trainingRecords').doc(recordsSnapshot.docs[0].id).update({
                trainingDate: date,
                updatedBy: currentUser.docId,
                updatedAt: new Date().toISOString()
            });
        }

        showToast('‚úÖ Ë®ìÁ∑¥Êó•ÊúüÂ∑≤ÂÑ≤Â≠ò', 'success');
    } catch (error) {
        console.error('ÂÑ≤Â≠òË®ìÁ∑¥Êó•ÊúüÂ§±Êïó:', error);
        showToast('‚ùå ÂÑ≤Â≠òÂ§±Êïó', 'error');
    }
}

// Á∑®ËºØÁ∞ΩÂêç
function editSignature(itemId, type, currentValue) {
    const label = type === 'trainee' ? 'Êñ∞Âêå‰∫ã' : 'Èô™Â∏∂Âêå‰∫ã';
    
    const modalBody = `
        <div class="input-group">
            <label>‚úçÔ∏è ${label}Á∞ΩÂêç</label>
            <input type="text" id="signatureInput" value="${currentValue}" placeholder="Ë´ãËº∏ÂÖ•Á∞ΩÂêç">
        </div>
        <div class="modal-buttons">
            <button class="btn btn-success" onclick="saveSignature('${itemId}', '${type}')">‚úÖ Á¢∫ÂÆö</button>
            <button class="btn btn-secondary" onclick="closeModal()">‚ùå ÂèñÊ∂à</button>
        </div>
    `;

    showModal(`‚úçÔ∏è ${label}Á∞ΩÂêç`, modalBody);
}

// ÂÑ≤Â≠òÁ∞ΩÂêç
async function saveSignature(itemId, type) {
    const signature = document.getElementById('signatureInput').value.trim();
    
    if (!signature) {
        showToast('‚ùå Ë´ãËº∏ÂÖ•Á∞ΩÂêç', 'error');
        return;
    }

    try {
        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        const fieldName = type === 'trainee' ? 'traineeSignature' : 'mentorSignature';
        const recordData = {
            userId: currentStaffId,
            itemId: itemId,
            [fieldName]: signature,
            updatedBy: currentUser.docId,
            updatedAt: new Date().toISOString()
        };

        if (recordsSnapshot.empty) {
            await db.collection('trainingRecords').add(recordData);
        } else {
            await db.collection('trainingRecords').doc(recordsSnapshot.docs[0].id).update({
                [fieldName]: signature,
                updatedBy: currentUser.docId,
                updatedAt: new Date().toISOString()
            });
        }

        showToast('‚úÖ Á∞ΩÂêçÂ∑≤ÂÑ≤Â≠ò', 'success');
        closeModal();
        showCategoryEvaluation(currentCategoryId);
    } catch (error) {
        console.error('ÂÑ≤Â≠òÁ∞ΩÂêçÂ§±Êïó:', error);
        showToast('‚ùå ÂÑ≤Â≠òÂ§±Êïó', 'error');
    }
}

// Ê®ôË®òË®ìÁ∑¥ÂÆåÊàê
async function markTrainingComplete(itemId) {
    try {
        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        if (recordsSnapshot.empty) {
            showToast('‚ùå Ë´ãÂÖàÂ°´ÂØ´Ë®ìÁ∑¥Ë®òÈåÑ', 'error');
            return;
        }

        const record = recordsSnapshot.docs[0].data();
        
        if (!record.trainingDate || !record.traineeSignature || !record.mentorSignature) {
            showToast('‚ùå Ë´ãÂÆåÊï¥Â°´ÂØ´Êó•ÊúüÂèäÈõôÊñπÁ∞ΩÂêç', 'error');
            return;
        }

        await db.collection('trainingRecords').doc(recordsSnapshot.docs[0].id).update({
            status: 'completed',
            completedBy: currentUser.docId,
            completedAt: new Date().toISOString()
        });

        showToast('‚úÖ Ë®ìÁ∑¥Â∑≤Ê®ôË®òÂÆåÊàê', 'success');
        showCategoryEvaluation(currentCategoryId);
    } catch (error) {
        console.error('Ê®ôË®òÂÆåÊàêÂ§±Êïó:', error);
        showToast('‚ùå Êìç‰ΩúÂ§±Êïó', 'error');
    }
}

// ÈáçË®≠Ë®ìÁ∑¥Ë®òÈåÑ
async function resetTraining(itemId) {
    if (!confirm('‚ùì Á¢∫ÂÆöË¶ÅÈáçË®≠Ê≠§Ë®ìÁ∑¥Ë®òÈåÑÂóéÔºü')) {
        return;
    }

    try {
        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        if (!recordsSnapshot.empty) {
            await db.collection('trainingRecords').doc(recordsSnapshot.docs[0].id).delete();
        }

        showToast('‚úÖ Ë®ìÁ∑¥Ë®òÈåÑÂ∑≤ÈáçË®≠', 'success');
        showCategoryEvaluation(currentCategoryId);
    } catch (error) {
        console.error('ÈáçË®≠Â§±Êïó:', error);
        showToast('‚ùå Êìç‰ΩúÂ§±Êïó', 'error');
    }
}

        // ==================== Ë®ìÁ∑¥Ë®òÈåÑÁõ∏ÈóúÂáΩÊï∏ ====================

// ‚≠ê‚≠ê‚≠ê ÂÑ≤Â≠òÂñÆ‰∏ÄÊ≠•È©üÁöÑË®ìÁ∑¥Êó•ÊúüÔºàÂç≥ÊôÇÊõ¥Êñ∞ÁãÄÊÖãÔºâ‚≠ê‚≠ê‚≠ê
async function saveStepTrainingDate(itemId, stepIndex) {
    const date = document.getElementById(`trainingDate_${itemId}_${stepIndex}`).value;
    
    try {
        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        let stepRecords = {};
        
        if (!recordsSnapshot.empty) {
            const record = recordsSnapshot.docs[0].data();
            stepRecords = record.stepRecords || {};
        }

        if (!stepRecords[stepIndex]) {
            stepRecords[stepIndex] = {};
        }
        stepRecords[stepIndex].trainingDate = date;

        const recordData = {
            userId: currentStaffId,
            itemId: itemId,
            stepRecords: stepRecords,
            updatedBy: currentUser.docId,
            updatedAt: new Date().toISOString()
        };

        if (recordsSnapshot.empty) {
            await db.collection('trainingRecords').add(recordData);
        } else {
            await db.collection('trainingRecords').doc(recordsSnapshot.docs[0].id).update(recordData);
        }

        showToast('‚úÖ Ë®ìÁ∑¥Êó•ÊúüÂ∑≤ÂÑ≤Â≠ò', 'success');
        
        // ‚≠ê Âç≥ÊôÇÊõ¥Êñ∞ÂÆåÊàêÁãÄÊÖãÈ°ØÁ§∫
        await refreshTrainingStepStatus(itemId, stepIndex);
        
    } catch (error) {
        console.error('ÂÑ≤Â≠òË®ìÁ∑¥Êó•ÊúüÂ§±Êïó:', error);
        showToast('‚ùå ÂÑ≤Â≠òÂ§±Êïó', 'error');
    }
}

// ‚≠ê‚≠ê‚≠ê Á∑®ËºØÂñÆ‰∏ÄÊ≠•È©üÁöÑÁ∞ΩÂêçÔºàÊñ∞Â¢ûÂèØÈÅ∏ÊìáÊÄß‰∏ÄÈçµÂ§öÁ∞Ω + Ëá™ÂãïÂ°´ÂÖ•Èô™Â∏∂Âêå‰∫ãÔºâ‚≠ê‚≠ê‚≠ê
function editStepSignature(itemId, stepIndex, type, currentValue) {
    const label = type === 'trainee' ? 'Êñ∞Âêå‰∫ã' : 'Èô™Â∏∂Âêå‰∫ã';
    
    // ‚≠ê Èô™Â∏∂Âêå‰∫ãËá™ÂãïÂ°´ÂÖ•ÁôªÂÖ•ËÄÖÂßìÂêç
    const defaultValue = type === 'mentor' && !currentValue ? currentUser.name : currentValue;
    
    // ‚≠ê‚≠ê‚≠ê Êñ∞Â¢ûÔºöÂÖ©Á®ÆÁ∞ΩÂêçÈÉΩÊîØÊè¥‰∏ÄÈçµÂ§öÁ∞Ω ‚≠ê‚≠ê‚≠ê
    const batchSignButton = `
        <button class="btn btn-warning" style="width: 100%; margin-top: 10px;" 
                onclick="showBatchSignModal('${itemId}', '${type}')">
            ‚úçÔ∏è ‰∏ÄÈçµÂ§öÁ∞ΩÔºàÂèØÈÅ∏ÊìáÊ≠•È©üÔºâ
        </button>
        <div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 6px; font-size: 0.85em; text-align: center;">
            üí° ÊèêÁ§∫ÔºöÂèØ‰ª•ÈÅ∏ÊìáË¶ÅÁ∞ΩÁΩ≤Âì™‰∫õÊ≠•È©ü
        </div>
    `;
    
    // ‚≠ê‚≠ê‚≠ê Êñ∞Â¢ûÔºöÈáçË®≠Á∞ΩÂêçÊåâÈàï ‚≠ê‚≠ê‚≠ê
    const resetButton = currentValue ? `
        <button class="btn btn-danger" style="width: 100%; margin-top: 10px;" 
                onclick="resetStepSignature('${itemId}', ${stepIndex}, '${type}')">
            üóëÔ∏è Ê∏ÖÈô§Ê≠§Á∞ΩÂêç
        </button>
    ` : '';
    
    const modalBody = `
        <div class="input-group">
            <label>‚úçÔ∏è ${label}Á∞ΩÂêç</label>
            <input type="text" id="signatureInput" value="${defaultValue}" placeholder="Ë´ãËº∏ÂÖ•Á∞ΩÂêç" autofocus>
        </div>
        ${batchSignButton}
        ${resetButton}
        <div class="modal-buttons">
            <button class="btn btn-success" onclick="saveStepSignature('${itemId}', ${stepIndex}, '${type}')">‚úÖ Á¢∫ÂÆö</button>
            <button class="btn btn-secondary" onclick="closeModal()">‚ùå ÂèñÊ∂à</button>
        </div>
    `;

    showModal(`‚úçÔ∏è ${label}Á∞ΩÂêç`, modalBody);
}

// ‚≠ê‚≠ê‚≠ê ‰øÆÊîπÂáΩÊï∏Á∞ΩÂêçÔºåÂ¢ûÂä† type ÂèÉÊï∏ ‚≠ê‚≠ê‚≠ê
async function showBatchSignModal(itemId, type = 'trainee') {
    const signature = document.getElementById('signatureInput').value.trim();
    
    if (!signature) {
        showToast('‚ùå Ë´ãÂÖàËº∏ÂÖ•Á∞ΩÂêç', 'error');
        return;
    }

    const label = type === 'trainee' ? 'Êñ∞Âêå‰∫ã' : 'Èô™Â∏∂Âêå‰∫ã';
    const fieldName = type === 'trainee' ? 'traineeSignature' : 'mentorSignature';

    try {
        const itemDoc = await db.collection('trainingItems').doc(itemId).get();
        const item = itemDoc.data();

        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        let stepRecords = {};
        if (!recordsSnapshot.empty) {
            const record = recordsSnapshot.docs[0].data();
            stepRecords = record.stepRecords || {};
        }

        // ÁîüÊàêÊ≠•È©üÈÅ∏ÊìáÊ∏ÖÂñÆ
        let stepCounter = 0;
        let checkboxesHtml = '<div style="max-height: 400px; overflow-y: auto; margin: 15px 0;">';
        
        // ‚≠ê Âø´ÈÄüÈÅ∏ÊìáÊåâÈàï
        checkboxesHtml += `
            <div style="display: flex; gap: 10px; margin-bottom: 15px; padding: 10px; background: #f0f4ff; border-radius: 8px;">
                <button class="btn btn-info btn-small" onclick="selectAllSteps()" style="flex: 1;">
                    ‚úÖ ÂÖ®ÈÅ∏
                </button>
                <button class="btn btn-secondary btn-small" onclick="deselectAllSteps()" style="flex: 1;">
                    ‚ùå Ê∏ÖÈô§
                </button>
                <button class="btn btn-warning btn-small" onclick="selectUnsignedSteps('${type}')" style="flex: 1;">
                    üìù Âè™ÈÅ∏Êú™Á∞Ω
                </button>
            </div>
        `;

        item.checklist.forEach((step, index) => {
            if (step.isSubtitle) {
                checkboxesHtml += `
                    <div style="margin: 20px 0 10px 0;">
                        <span class="step-subtitle">${step.step}</span>
                    </div>
                `;
            } else {
                stepCounter++;
                // ‚≠ê Ê†πÊìöÈ°ûÂûãÊ™¢Êü•Á∞ΩÂêçÁãÄÊÖã
                const isSigned = stepRecords[index]?.[fieldName] ? true : false;
                const statusBadge = isSigned 
                    ? '<span class="badge badge-success" style="font-size: 0.75em; margin-left: 8px;">‚úÖ Â∑≤Á∞Ω</span>' 
                    : '<span class="badge badge-warning" style="font-size: 0.75em; margin-left: 8px;">‚è≥ Êú™Á∞Ω</span>';
                
                const checkboxId = `step_checkbox_${index}`;
                const isChecked = !isSigned;
                
                checkboxesHtml += `
                    <label style="display: flex; align-items: center; padding: 12px; margin: 5px 0; 
                                  background: ${isSigned ? '#f0f0f0' : '#fff'}; 
                                  border: 2px solid ${isSigned ? '#e0e0e0' : '#ffa502'}; 
                                  border-radius: 8px; cursor: pointer; 
                                  transition: all 0.3s;"
                           onmouseover="this.style.background='#fffbf0'"
                           onmouseout="this.style.background='${isSigned ? '#f0f0f0' : '#fff'}'">
                        <input type="checkbox" 
                               id="${checkboxId}" 
                               data-step-index="${index}"
                               data-signature-type="${type}"
                               ${isChecked ? 'checked' : ''}
                               style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="flex: 1;">
                            <strong style="color: #ffa502;">Step ${stepCounter}:</strong> 
                            ${step.step}
                            ${statusBadge}
                        </span>
                    </label>
                `;
            }
        });
        
        checkboxesHtml += '</div>';

        const modalBody = `
            <div style="margin-bottom: 15px;">
                <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <strong>‚úçÔ∏è ${label}Á∞ΩÂêçÔºö</strong>${signature}
                </div>
            </div>
            
            <div style="font-weight: bold; color: #ffa502; margin-bottom: 10px; font-size: 1.1em;">
                üìã Ë´ãÈÅ∏ÊìáË¶ÅÁ∞ΩÁΩ≤ÁöÑÊ≠•È©üÔºö
            </div>
            
            ${checkboxesHtml}
            
            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; text-align: center; font-size: 0.9em;">
                <strong>üí° ÊèêÁ§∫Ôºö</strong>È†êË®≠Â∑≤ÂãæÈÅ∏ÊâÄÊúâÊú™Á∞ΩÁΩ≤ÁöÑÊ≠•È©üÔºå‰Ω†ÂèØ‰ª•Ëá™Áî±Ë™øÊï¥
            </div>
            
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmBatchSign('${itemId}', '${signature}', '${type}')">
                    ‚úÖ Á¢∫ÂÆöÁ∞ΩÁΩ≤
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">
                    ‚ùå ÂèñÊ∂à
                </button>
            </div>
        `;

        showModal(`‚úçÔ∏è ${label}‰∏ÄÈçµÂ§öÁ∞Ω - ÈÅ∏ÊìáÊ≠•È©ü`, modalBody);
        
    } catch (error) {
        console.error('ËºâÂÖ•Ê≠•È©üÊ∏ÖÂñÆÂ§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}

        // ‚≠ê‚≠ê‚≠ê Âø´ÈÄüÈÅ∏ÊìáÂáΩÊï∏ ‚≠ê‚≠ê‚≠ê
function selectAllSteps() {
    document.querySelectorAll('[id^="step_checkbox_"]').forEach(cb => {
        cb.checked = true;
    });
}

function deselectAllSteps() {
    document.querySelectorAll('[id^="step_checkbox_"]').forEach(cb => {
        cb.checked = false;
    });
}

// ‚≠ê‚≠ê‚≠ê ‰øÆÊîπÔºöÂ¢ûÂä† type ÂèÉÊï∏‰ª•Ê≠£Á¢∫Âà§Êñ∑ ‚≠ê‚≠ê‚≠ê
function selectUnsignedSteps(type = 'trainee') {
    document.querySelectorAll('[id^="step_checkbox_"]').forEach(cb => {
        // Âè™ÂãæÈÅ∏ËàáÁï∂ÂâçÈ°ûÂûãÁõ∏Á¨¶ÁöÑÊú™Á∞ΩÊ≠•È©ü
        if (cb.dataset.signatureType === type) {
            const label = cb.closest('label');
            const hasSigned = label.querySelector('.badge-success');
            cb.checked = !hasSigned;
        }
    });
}

// ‚≠ê‚≠ê‚≠ê Á¢∫Ë™çÊâπÈáèÁ∞ΩÁΩ≤ ‚≠ê‚≠ê‚≠ê
async function confirmBatchSign(itemId, signature, type = 'trainee') {
    try {
        const checkedBoxes = document.querySelectorAll('[id^="step_checkbox_"]:checked');
        
        if (checkedBoxes.length === 0) {
            showToast('‚ùå Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãÊ≠•È©ü', 'error');
            return;
        }

        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        let stepRecords = {};
        if (!recordsSnapshot.empty) {
            const record = recordsSnapshot.docs[0].data();
            stepRecords = record.stepRecords || {};
        }

        const fieldName = type === 'trainee' ? 'traineeSignature' : 'mentorSignature';

        // ÁÇ∫ÈÅ∏‰∏≠ÁöÑÊ≠•È©üÁ∞ΩÂêç
        let signedCount = 0;
        const stepIndexes = []; // ‚≠ê Êî∂ÈõÜÊâÄÊúâÊ≠•È©üÁ¥¢Âºï
        
        checkedBoxes.forEach(checkbox => {
            const stepIndex = parseInt(checkbox.dataset.stepIndex);
            
            if (!stepRecords[stepIndex]) {
                stepRecords[stepIndex] = {};
            }
            
            stepRecords[stepIndex][fieldName] = signature;
            stepIndexes.push(stepIndex); // ‚≠ê Ë®òÈåÑÁ¥¢Âºï
            signedCount++;
        });

        const recordData = {
            userId: currentStaffId,
            itemId: itemId,
            stepRecords: stepRecords,
            updatedBy: currentUser.docId,
            updatedAt: new Date().toISOString()
        };

        if (recordsSnapshot.empty) {
            await db.collection('trainingRecords').add(recordData);
        } else {
            await db.collection('trainingRecords').doc(recordsSnapshot.docs[0].id).update(recordData);
        }

        const label = type === 'trainee' ? 'Êñ∞Âêå‰∫ã' : 'Èô™Â∏∂Âêå‰∫ã';
        showToast(`‚úÖ Â∑≤ÊàêÂäüÁÇ∫ ${signedCount} ÂÄãÊ≠•È©üÁ∞ΩÁΩ≤„Äê${label}„ÄëÁ∞ΩÂêçÔºÅ`, 'success');
        closeModal();
        
        // ‚≠ê‚≠ê‚≠ê ÈóúÈçµ‰øÆÊîπÔºöÂîîÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢ÔºåÂè™Êõ¥Êñ∞Á∞ΩÂêçÊ°Ü ‚≠ê‚≠ê‚≠ê
        for (const stepIndex of stepIndexes) {
            await refreshSignatureBox(itemId, stepIndex, type, signature);
        }
        
    } catch (error) {
        console.error('ÊâπÈáèÁ∞ΩÁΩ≤Â§±Êïó:', error);
        showToast('‚ùå ÊâπÈáèÁ∞ΩÁΩ≤Â§±Êïó', 'error');
    }
}
        
        // ‚≠ê‚≠ê‚≠ê Êñ∞Â¢ûÔºö‰∏ÄÈçµÁ∞ΩÁΩ≤ÂÖ®ÈÉ®Ê≠•È©üÔºàÊñ∞Âêå‰∫ãÂ∞àÁî®Ôºâ‚≠ê‚≠ê‚≠ê
async function batchSignAllSteps(itemId) {
    const signature = document.getElementById('signatureInput').value.trim();
    
    if (!signature) {
        showToast('‚ùå Ë´ãÂÖàËº∏ÂÖ•Á∞ΩÂêç', 'error');
        return;
    }

    if (!confirm(`‚ùì Á¢∫ÂÆöË¶Å‰ΩøÁî®„Äå${signature}„ÄçÁ∞ΩÁΩ≤ÊâÄÊúâÊ≠•È©üÂóéÔºü`)) {
        return;
    }

    try {
        const itemDoc = await db.collection('trainingItems').doc(itemId).get();
        const item = itemDoc.data();

        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        let stepRecords = {};
        if (!recordsSnapshot.empty) {
            const record = recordsSnapshot.docs[0].data();
            stepRecords = record.stepRecords || {};
        }

        // ÁÇ∫ÊâÄÊúâÂØ¶ÈöõÊ≠•È©üÔºàÈùûÁ´†ÁØÄÊ®ôÈ°åÔºâÁ∞ΩÂêç
        let signedCount = 0;
        item.checklist.forEach((step, index) => {
            if (!step.isSubtitle) {
                if (!stepRecords[index]) {
                    stepRecords[index] = {};
                }
                // Âè™ÊúâÊú™Á∞ΩÂêçÁöÑÊâçÁ∞Ω
                if (!stepRecords[index].traineeSignature) {
                    stepRecords[index].traineeSignature = signature;
                    signedCount++;
                }
            }
        });

        const recordData = {
            userId: currentStaffId,
            itemId: itemId,
            stepRecords: stepRecords,
            updatedBy: currentUser.docId,
            updatedAt: new Date().toISOString()
        };

        if (recordsSnapshot.empty) {
            await db.collection('trainingRecords').add(recordData);
        } else {
            await db.collection('trainingRecords').doc(recordsSnapshot.docs[0].id).update(recordData);
        }

        showToast(`‚úÖ Â∑≤ÊàêÂäüÁ∞ΩÁΩ≤ ${signedCount} ÂÄãÊ≠•È©üÔºÅ`, 'success');
        closeModal();
        
        // ‚≠ê ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢‰ª•È°ØÁ§∫ÊâÄÊúâÁ∞ΩÂêç
        showCategoryEvaluation(currentCategoryId);
        
    } catch (error) {
        console.error('‰∏ÄÈçµÁ∞ΩÁΩ≤Â§±Êïó:', error);
        showToast('‚ùå ÊâπÈáèÁ∞ΩÁΩ≤Â§±Êïó', 'error');
    }
}

        // ‚≠ê‚≠ê‚≠ê Êñ∞Â¢ûÔºöÈáçË®≠ÂñÆ‰∏ÄÊ≠•È©üÁ∞ΩÂêç ‚≠ê‚≠ê‚≠ê
async function resetStepSignature(itemId, stepIndex, type) {
    const label = type === 'trainee' ? 'Êñ∞Âêå‰∫ã' : 'Èô™Â∏∂Âêå‰∫ã';
    
    if (!confirm(`‚ùì Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§„Äê${label}„ÄëÂú®Ê≠§Ê≠•È©üÁöÑÁ∞ΩÂêçÂóéÔºü`)) {
        return;
    }

    try {
        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        if (recordsSnapshot.empty) {
            showToast('‚ö†Ô∏è Ê≤íÊúâÊâæÂà∞Á∞ΩÂêçË®òÈåÑ', 'warning');
            closeModal();
            return;
        }

        const record = recordsSnapshot.docs[0].data();
        let stepRecords = record.stepRecords || {};

        if (!stepRecords[stepIndex]) {
            showToast('‚ö†Ô∏è Ê≠§Ê≠•È©üÊ≤íÊúâÁ∞ΩÂêçË®òÈåÑ', 'warning');
            closeModal();
            return;
        }

        const fieldName = type === 'trainee' ? 'traineeSignature' : 'mentorSignature';
        
        // Âà™Èô§Á∞ΩÂêç
        delete stepRecords[stepIndex][fieldName];

        // Â¶ÇÊûúÊï¥ÂÄãÊ≠•È©üË®òÈåÑÈÉΩÁ©∫‰∫ÜÔºåÂ∞±Âà™Èô§Êï¥ÂÄãÊ≠•È©ü
        if (!stepRecords[stepIndex].trainingDate && 
            !stepRecords[stepIndex].traineeSignature && 
            !stepRecords[stepIndex].mentorSignature) {
            delete stepRecords[stepIndex];
        }

        await db.collection('trainingRecords').doc(recordsSnapshot.docs[0].id).update({
            stepRecords: stepRecords,
            updatedBy: currentUser.docId,
            updatedAt: new Date().toISOString()
        });

        showToast(`‚úÖ Â∑≤Ê∏ÖÈô§„Äê${label}„ÄëÁ∞ΩÂêç`, 'success');
        closeModal();
        
        // Âà∑Êñ∞Á∞ΩÂêçÊ°Ü
        await refreshSignatureBox(itemId, stepIndex, type, '');
        
    } catch (error) {
        console.error('Ê∏ÖÈô§Á∞ΩÂêçÂ§±Êïó:', error);
        showToast('‚ùå Ê∏ÖÈô§Â§±Êïó', 'error');
    }
}
        
// ÂÑ≤Â≠òÂñÆ‰∏ÄÊ≠•È©üÁöÑÁ∞ΩÂêç (‚≠ê ‰∏çËá™ÂãïÊî∂Ëµ∑È†ÅÈù¢)
async function saveStepSignature(itemId, stepIndex, type) {
    const signature = document.getElementById('signatureInput').value.trim();
    
    if (!signature) {
        showToast('‚ùå Ë´ãËº∏ÂÖ•Á∞ΩÂêç', 'error');
        return;
    }

    try {
        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        let stepRecords = {};
        
        if (!recordsSnapshot.empty) {
            const record = recordsSnapshot.docs[0].data();
            stepRecords = record.stepRecords || {};
        }

        if (!stepRecords[stepIndex]) {
            stepRecords[stepIndex] = {};
        }
        
        const fieldName = type === 'trainee' ? 'traineeSignature' : 'mentorSignature';
        stepRecords[stepIndex][fieldName] = signature;

        const recordData = {
            userId: currentStaffId,
            itemId: itemId,
            stepRecords: stepRecords,
            updatedBy: currentUser.docId,
            updatedAt: new Date().toISOString()
        };

        if (recordsSnapshot.empty) {
            await db.collection('trainingRecords').add(recordData);
        } else {
            await db.collection('trainingRecords').doc(recordsSnapshot.docs[0].id).update(recordData);
        }

        showToast('‚úÖ Á∞ΩÂêçÂ∑≤ÂÑ≤Â≠ò', 'success');
        closeModal();
        
        // ‚≠ê‚≠ê‚≠ê ÈóúÈçµ‰øÆÊîπÔºöÂè™Êõ¥Êñ∞Á∞ΩÂêçÊ°ÜÂÖßÂÆπÔºå‰∏çÈáçÊñ∞ËºâÂÖ•Êï¥ÂÄãÈ†ÅÈù¢ ‚≠ê‚≠ê‚≠ê
        await refreshSignatureBox(itemId, stepIndex, type, signature);
        
    } catch (error) {
        console.error('ÂÑ≤Â≠òÁ∞ΩÂêçÂ§±Êïó:', error);
        showToast('‚ùå ÂÑ≤Â≠òÂ§±Êïó', 'error');
    }
}

// ‚≠ê‚≠ê‚≠ê Êõ¥Êñ∞Á∞ΩÂêçÊ°ÜÂèäÂÆåÊàêÁãÄÊÖã ‚≠ê‚≠ê‚≠ê
async function refreshSignatureBox(itemId, stepIndex, type, signature) {
    try {
        const signatureBoxes = document.querySelectorAll(`#eval_item_${itemId} .signature-box`);
        
        const itemDoc = await db.collection('trainingItems').doc(itemId).get();
        const item = itemDoc.data();
        
        let actualBoxIndex = 0;
        for (let i = 0; i <= stepIndex; i++) {
            if (!item.checklist[i].isSubtitle) {
                if (i === stepIndex) break;
                actualBoxIndex++;
            }
        }
        
        const boxIndex = (actualBoxIndex * 2) + (type === 'trainee' ? 0 : 1);
        
        if (signatureBoxes[boxIndex]) {
            signatureBoxes[boxIndex].textContent = signature;
            signatureBoxes[boxIndex].classList.add('signed');
        }
        
        // ‚≠ê ÂêåÊôÇÊõ¥Êñ∞ÂÆåÊàêÁãÄÊÖã
        await refreshTrainingStepStatus(itemId, stepIndex);
        
    } catch (error) {
        console.error('Êõ¥Êñ∞Á∞ΩÂêçÊ°ÜÂ§±Êïó:', error);
        showCategoryEvaluation(currentCategoryId);
    }
}

        // ‚≠ê‚≠ê‚≠ê Êñ∞Â¢ûÔºöÂç≥ÊôÇÊõ¥Êñ∞Ë®ìÁ∑¥Ê≠•È©üÂÆåÊàêÁãÄÊÖã ‚≠ê‚≠ê‚≠ê
async function refreshTrainingStepStatus(itemId, stepIndex) {
    try {
        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        if (recordsSnapshot.empty) return;

        const record = recordsSnapshot.docs[0].data();
        const stepRecords = record.stepRecords || {};
        const stepRecord = stepRecords[stepIndex] || {};

        const trainingDate = stepRecord.trainingDate || '';
        const traineeSignature = stepRecord.traineeSignature || '';
        const mentorSignature = stepRecord.mentorSignature || '';
        const stepCompleted = trainingDate && traineeSignature && mentorSignature;

        // ÊâæÂà∞Â∞çÊáâÁöÑ checklist-item ÂÖÉÁ¥†
        const itemDoc = await db.collection('trainingItems').doc(itemId).get();
        const item = itemDoc.data();
        
        let actualStepIndex = 0;
        for (let i = 0; i <= stepIndex; i++) {
            if (!item.checklist[i].isSubtitle) {
                if (i === stepIndex) break;
                actualStepIndex++;
            }
        }

        const checklistItems = document.querySelectorAll(`#eval_item_${itemId} .checklist-item`);
        const targetItem = checklistItems[actualStepIndex];

        if (targetItem) {
            // Êõ¥Êñ∞ÂÆåÊàêÁãÄÊÖãÊ®£Âºè
            if (stepCompleted) {
                targetItem.classList.add('completed');
            } else {
                targetItem.classList.remove('completed');
            }

            // Êõ¥Êñ∞ÂÆåÊàêÁãÄÊÖãÊñáÂ≠ó
            const statusDiv = targetItem.querySelector('div[style*="margin-top: 10px"]');
            if (statusDiv) {
                const statusText = stepCompleted 
                    ? '<strong style="color: #2ed573;">‚úÖ Ê≠§Ê≠•È©üÂ∑≤ÂÆåÊàê</strong>'
                    : '<strong style="color: #ffa502;">‚è≥ ÂæÖÂÆåÊàê</strong>';
                statusDiv.innerHTML = statusText;
            }
        }

        // ‚≠ê ÂêåÊôÇÊõ¥Êñ∞Êï¥È´îÈÄ≤Â∫¶
        await updateOverallProgress(itemId);

    } catch (error) {
        console.error('Êõ¥Êñ∞Ê≠•È©üÁãÄÊÖãÂ§±Êïó:', error);
    }
}

        // ‚≠ê‚≠ê‚≠ê Êñ∞Â¢ûÔºöÊõ¥Êñ∞Êï¥È´îË®ìÁ∑¥ÈÄ≤Â∫¶ ‚≠ê‚≠ê‚≠ê
async function updateOverallProgress(itemId) {
    try {
        const itemDoc = await db.collection('trainingItems').doc(itemId).get();
        const item = itemDoc.data();

        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        if (recordsSnapshot.empty) return;

        const record = recordsSnapshot.docs[0].data();
        const stepRecords = record.stepRecords || {};

        const actualSteps = item.checklist.filter(s => !s.isSubtitle);
        let totalSteps = actualSteps.length;
        let completedSteps = 0;

        item.checklist.forEach((step, index) => {
            if (!step.isSubtitle && stepRecords[index]?.trainingDate && 
                stepRecords[index]?.traineeSignature && stepRecords[index]?.mentorSignature) {
                completedSteps++;
            }
        });

        const completionRate = Math.round((completedSteps / totalSteps) * 100);
        const isCompleted = completionRate === 100;

        // Êõ¥Êñ∞ÈÄ≤Â∫¶Áí∞
        const card = document.getElementById(`eval_item_${itemId}`);
        if (card) {
            const percentElement = card.querySelector('.item-progress-percent');
            const labelElement = card.querySelector('.item-progress-label');
            const circleElement = card.querySelector('.item-progress-ring-circle');

            if (percentElement) percentElement.textContent = `${completionRate}%`;
            if (labelElement) labelElement.textContent = `${completedSteps}/${totalSteps}`;

            if (circleElement) {
                const circumference = 2 * Math.PI * 50;
                const offset = circumference - (completionRate / 100) * circumference;
                circleElement.setAttribute('stroke-dashoffset', offset);
            }

            // Êõ¥Êñ∞Êï¥È´îÂÆåÊàêÁãÄÊÖã
            const scoreItems = card.querySelectorAll('.score-item-value');
            if (scoreItems.length >= 3) {
                scoreItems[1].textContent = completedSteps;
                scoreItems[1].className = `score-item-value ${isCompleted ? 'pass' : 'fail'}`;
                scoreItems[2].textContent = `${completionRate}%`;
                scoreItems[2].className = `score-item-value ${isCompleted ? 'pass' : 'fail'}`;
            }

            const overallStatusElement = card.querySelector('.score-info .score-item-value[style*="font-size: 1.1em"]');
            if (overallStatusElement) {
                const statusText = isCompleted ? '‚úÖ Ë®ìÁ∑¥Â∑≤ÂÆåÊàê' : '‚è≥ Ë®ìÁ∑¥ÈÄ≤Ë°å‰∏≠';
                overallStatusElement.innerHTML = statusText;
                overallStatusElement.className = `score-item-value ${isCompleted ? 'pass' : ''}`;
            }

            // Êõ¥Êñ∞Âç°ÁâáÊ®£Âºè
            if (isCompleted) {
                card.classList.add('completed');
            } else {
                card.classList.remove('completed');
            }
        }

    } catch (error) {
        console.error('Êõ¥Êñ∞Êï¥È´îÈÄ≤Â∫¶Â§±Êïó:', error);
    }
}
        
// ÈáçË®≠ÊâÄÊúâË®ìÁ∑¥Ë®òÈåÑ
async function resetAllTraining(itemId) {
    if (!confirm('‚ùì Á¢∫ÂÆöË¶ÅÈáçË®≠Ê≠§È†ÖÁõÆÁöÑÊâÄÊúâË®ìÁ∑¥Ë®òÈåÑÂóéÔºü')) {
        return;
    }

    try {
        const recordsSnapshot = await db.collection('trainingRecords')
            .where('userId', '==', currentStaffId)
            .where('itemId', '==', itemId)
            .limit(1)
            .get();

        if (!recordsSnapshot.empty) {
            await db.collection('trainingRecords').doc(recordsSnapshot.docs[0].id).delete();
        }

        showToast('‚úÖ Ë®ìÁ∑¥Ë®òÈåÑÂ∑≤ÈáçË®≠', 'success');
        showCategoryEvaluation(currentCategoryId);
    } catch (error) {
        console.error('ÈáçË®≠Â§±Êïó:', error);
        showToast('‚ùå Êìç‰ΩúÂ§±Êïó', 'error');
    }
}

        // ==================== PCA1 Èô™Â∏∂Ë®ìÁ∑¥Â∞àÁî®ÈÅ∏ÂñÆ ====================
function showPCA1MentorMenu() {
    showPage('staffLevelPage');
    
    // ‰øÆÊîπÊ®ôÈ°å
    document.querySelector('#staffLevelPage .top-bar h2').textContent = 'üìä ÈÅ∏ÊìáË¶ÅÈô™Â∏∂ÁöÑÂì°Â∑•ËÅ∑Á¥ö';
    
    // Âè™È°ØÁ§∫ PCA2 Âíå PCA3 Âç°Áâá
    const menuGrid = document.querySelector('#staffLevelPage .menu-grid');
    menuGrid.innerHTML = `
        <div class="menu-card level-PCA2" onclick="showStaffList('PCA2')">
            <div class="emoji">üôãüèª‚Äç‚ôÇÔ∏è</div>
            <div class="title">PCA2</div>
        </div>
        <div class="menu-card level-PCA3" onclick="showStaffList('PCA3')">
            <div class="emoji">üôãüèª‚Äç‚ôÄÔ∏è</div>
            <div class="title">PCA3</div>
        </div>
    `;
}

// ==================== QUIZ SYSTEM FUNCTIONS ====================

// ==================== Êñ∞Â¢ûÊ∏¨È©óÂàÜÈ°û ====================
function showAddQuizCategoryModal() {
    const modalBody = `
        <div class="form-section">
            <label>ÂàÜÈ°ûÂêçÁ®±</label>
            <input type="text" id="newQuizCategoryName" placeholder="‰æãÂ¶ÇÔºöÊâãÈÉ®Ë°õÁîüÊ∏¨È©ó">
        </div>
        
        <div class="form-section">
            <label>Emoji ÂúñÁ§∫</label>
            <input type="text" id="newQuizCategoryEmoji" placeholder="‰æãÂ¶ÇÔºöüßº" maxlength="2">
        </div>
        
        <div class="form-section">
            <label>ÂêàÊ†ºÂàÜÊï∏ (%)</label>
            <input type="number" id="newQuizCategoryPassingScore" min="0" max="100" value="60" placeholder="60">
        </div>
        
        <div class="form-section">
            <label>È°ØÁ§∫È†ÜÂ∫è</label>
            <input type="number" id="newQuizCategoryOrder" min="1" value="1" placeholder="1">
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-success" onclick="saveNewQuizCategory()">‚úÖ Êñ∞Â¢û</button>
            <button class="btn btn-secondary" onclick="closeModal()">‚ùå ÂèñÊ∂à</button>
        </div>
    `;
    
    showModal('‚ûï Êñ∞Â¢ûÊ∏¨È©óÂàÜÈ°û', modalBody);
}

// ==================== ÂÑ≤Â≠òÊñ∞Ê∏¨È©óÂàÜÈ°û ====================
async function saveNewQuizCategory() {
    const name = document.getElementById('newQuizCategoryName').value.trim();
    const emoji = document.getElementById('newQuizCategoryEmoji').value.trim();
    const passingScore = parseInt(document.getElementById('newQuizCategoryPassingScore').value) || 60;
    const order = parseInt(document.getElementById('newQuizCategoryOrder').value) || 1;
    
    if (!name) {
        showToast('‚ùå Ë´ãËº∏ÂÖ•ÂàÜÈ°ûÂêçÁ®±', 'error');
        return;
    }
    
    if (!emoji) {
        showToast('‚ùå Ë´ãËº∏ÂÖ• Emoji ÂúñÁ§∫', 'error');
        return;
    }
    
    try {
        await db.collection('quizCategories').add({
            name: name,
            emoji: emoji,
            passingScore: passingScore,
            order: order,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser.docId
        });
        
        showToast('‚úÖ Ê∏¨È©óÂàÜÈ°ûÊñ∞Â¢ûÊàêÂäü', 'success');
        closeModal();
        loadQuizCategories();
        
    } catch (error) {
        console.error('Êñ∞Â¢ûÊ∏¨È©óÂàÜÈ°ûÂ§±Êïó:', error);
        showToast('‚ùå Êñ∞Â¢ûÂ§±Êïó', 'error');
    }
}

// ==================== Âà™Èô§Ê∏¨È©óÂàÜÈ°û ====================
async function deleteQuizCategory(categoryId, categoryName) {
    if (!confirm(`‚ùì Á¢∫ÂÆöË¶ÅÂà™Èô§Ê∏¨È©óÂàÜÈ°û„Äå${categoryName}„ÄçÂóéÔºü\n\n‚ö†Ô∏è Ê≠§Êìç‰ΩúÊúÉÂêåÊôÇÂà™Èô§ÊâÄÊúâÁõ∏ÈóúÈ°åÁõÆÂíåË®òÈåÑÔºåÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`)) {
        return;
    }
    
    try {
        // Âà™Èô§Áõ∏ÈóúÈ°åÁõÆ
        const itemsSnapshot = await db.collection('quizItems')
            .where('categoryId', '==', categoryId)
            .get();
        
        const itemDeletePromises = itemsSnapshot.docs.map(doc => doc.ref.delete());
        await Promise.all(itemDeletePromises);
        
        // Âà™Èô§Áõ∏ÈóúË®òÈåÑ
        const recordsSnapshot = await db.collection('quizRecords')
            .where('categoryId', '==', categoryId)
            .get();
        
        const recordDeletePromises = recordsSnapshot.docs.map(doc => doc.ref.delete());
        await Promise.all(recordDeletePromises);
        
        // Âà™Èô§ÂàÜÈ°ûÊú¨Ë∫´
        await db.collection('quizCategories').doc(categoryId).delete();
        
        showToast('‚úÖ Ê∏¨È©óÂàÜÈ°ûÂ∑≤Âà™Èô§', 'success');
        loadQuizCategories();
        
    } catch (error) {
        console.error('Âà™Èô§Ê∏¨È©óÂàÜÈ°ûÂ§±Êïó:', error);
        showToast('‚ùå Âà™Èô§Â§±Êïó', 'error');
    }
}

// ==================== È°ØÁ§∫ Quiz ‰∏ªÈ†ÅÈù¢ ====================
async function showQuizMain() {
    showPage('quizMainPage');
    
    // Ê†πÊìöÊ¨äÈôêÈ°ØÁ§∫/Èö±ËóèÊåâÈàï
    const addBtn = document.getElementById('addQuizCategoryBtn');
    if (currentUser.role === 'admin') {
        addBtn.style.display = 'inline-block';
    } else {
        addBtn.style.display = 'none';
    }
    
    await loadQuizCategories();
}

// ==================== ËºâÂÖ•Ê∏¨È©óÂàÜÈ°û ====================
async function loadQuizCategories() {
    try {
        const snapshot = await db.collection('quizCategories')
            .orderBy('order', 'asc')
            .get();
        
        if (snapshot.empty) {
            document.getElementById('quizCategoryDashboard').innerHTML = 
                '<div class="no-data-message">üì≠ Â∞öÁÑ°Ê∏¨È©óÂàÜÈ°ûÔºåË´ãÊñ∞Â¢ûÂàÜÈ°ûÈñãÂßã‰ΩøÁî®</div>';
            return;
        }
        
        let cardsHtml = '';
        
        for (const doc of snapshot.docs) {
            const category = doc.data();
            
            // Ë®àÁÆóÈ°åÁõÆÊï∏Èáè
            const itemsSnapshot = await db.collection('quizItems')
                .where('categoryId', '==', doc.id)
                .get();
            const totalItems = itemsSnapshot.size;
            
            // Ë®àÁÆóÁ∏ΩÂàÜ
            let totalScore = 0;
            itemsSnapshot.forEach(itemDoc => {
                totalScore += itemDoc.data().score || 0;
            });
            
            const circumference = 2 * Math.PI * 60;
            const percentage = 100;
            const offset = circumference - (percentage / 100) * circumference;

            // ‚≠ê‚≠ê‚≠ê Ê™¢Êü•Âì°Â∑•ÁöÑÊ∏¨È©óÁãÄÊÖãÔºàÂè™ÊúâÂì°Â∑•ÂÖàÊ™¢Êü•Ôºâ‚≠ê‚≠ê‚≠ê
            let quizStatusClass = '';  // ‚≠ê ÊîπÁÇ∫Á©∫Â≠ó‰∏≤
            let quizStatusText = 'Êú™ÂÆåÊàê';

            if (currentUser.role === 'staff') {
                quizStatusClass = 'quiz-incomplete';  // ‚≠ê ÂÖàË®≠ÂÆöÈ†êË®≠ÂÄº
                const userRecordsSnapshot = await db.collection('quizRecords')
                    .where('userId', '==', currentUser.docId)
                    .where('categoryId', '==', doc.id)
                    .orderBy('completedAt', 'desc')
                    .limit(1)
                    .get();
                
                if (!userRecordsSnapshot.empty) {
                    const latestRecord = userRecordsSnapshot.docs[0].data();
                    
                    if (latestRecord.status === 'submitted') {
                        quizStatusClass = 'quiz-pending';
                        quizStatusText = 'ÂæÖÊâπÊîπ';
                    } else if (latestRecord.status === 'graded' && latestRecord.isPassed) {
                        quizStatusClass = 'quiz-passed';
                        quizStatusText = 'ÂêàÊ†º';
                    } else if (latestRecord.status === 'failed' || (latestRecord.status === 'graded' && !latestRecord.isPassed)) {
                        quizStatusClass = 'quiz-failed';
                        quizStatusText = '‰∏çÂêàÊ†º';
                    }
                }
            }

            cardsHtml += `
                <div class="training-card ${quizStatusClass}" onclick="viewQuizCategory('${doc.id}')">
                    <div class="card-icon">${category.emoji}</div>
                    <div class="card-title">${category.name}</div>
                    <div class="card-progress">
                        <svg class="progress-ring" width="150" height="150" viewBox="0 0 150 150">
                            <circle class="progress-ring-bg" cx="75" cy="75" r="60" 
                                fill="none" stroke-width="12"/>
                            <circle class="progress-ring-circle" cx="75" cy="75" r="60" 
                                fill="none" stroke-width="12"
                                stroke-dasharray="${circumference}" 
                                stroke-dashoffset="${offset}"
                                stroke-linecap="round"/>
                        </svg>
                        <div class="progress-text">
                            <div class="progress-percent">${totalItems}</div>
                            <div class="progress-label">È°åÁõÆ</div>
                        </div>
                    </div>
                    <div class="card-stats">
                        Á∏ΩÂàÜ: ${totalScore} ÂàÜ | ÂêàÊ†º: ${category.passingScore}%
                        ${currentUser.role === 'staff' ? `<br><strong style="font-size: 1.1em; margin-top: 8px; display: block;">ÁãÄÊÖãÔºö${quizStatusText}</strong>` : ''}
                    </div>
                    ${currentUser.role === 'admin' ? `
                        <div class="card-actions">
                            <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteQuizCategory('${doc.id}', '${category.name}')">üóëÔ∏è Âà™Èô§</button>
                        </div>
                    ` : ''}
                </div>
            `;
        } // ‚≠ê‚≠ê‚≠ê Âë¢ÂÄã } ‰øÇ for loop ÂòÖÁµêÂ∞æÔºå‰øùÁïôÔºÅ
        
        document.getElementById('quizCategoryDashboard').innerHTML = cardsHtml;
        
    } catch (error) {
        console.error('ËºâÂÖ•Ê∏¨È©óÂàÜÈ°ûÂ§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}

// ==================== Êü•ÁúãÊ∏¨È©óÂàÜÈ°ûÔºà‰∏çÂêåËßíËâ≤‰∏çÂêåÂäüËÉΩÔºâ====================
async function viewQuizCategory(categoryId) {
    currentQuizCategoryId = categoryId;
    
    if (currentUser.role === 'admin') {
        // ÁÆ°ÁêÜÂì°ÔºöÈÄ≤ÂÖ•È°åÁõÆÁÆ°ÁêÜ
        await showQuizCategoryDetail(categoryId);
    } else if (currentUser.role === 'supervisor') {
        // ‰∏ªÁÆ°ÔºöÊü•ÁúãÊâÄÊúâÂì°Â∑•Ë®òÈåÑ
        await showQuizRecordsForSupervisor(categoryId);
    } else {
        // Âì°Â∑•ÔºöÈñãÂßãÊ∏¨È©óÊàñÊü•ÁúãËá™Â∑±Ë®òÈåÑ
        await showQuizOptionsForStaff(categoryId);
    }
}

// ==================== È°ØÁ§∫Ê∏¨È©óÂàÜÈ°ûË©≥ÊÉÖÔºàÁÆ°ÁêÜÂì°Ôºâ====================
async function showQuizCategoryDetail(categoryId) {
    showPage('quizCategoryDetailPage');
    
    try {
        const categoryDoc = await db.collection('quizCategories').doc(categoryId).get();
        const category = categoryDoc.data();
        
        document.getElementById('quizCategoryDetailTitle').textContent = 
            `${category.emoji} ${category.name} - È°åÁõÆÁÆ°ÁêÜ`;
        
        // È°ØÁ§∫Êñ∞Â¢ûÊåâÈàï
        document.getElementById('addQuizItemBtn').style.display = 'inline-block';
        
        const itemsSnapshot = await db.collection('quizItems')
            .where('categoryId', '==', categoryId)
            .orderBy('order', 'asc')
            .get();
        
        if (itemsSnapshot.empty) {
            document.getElementById('quizCategoryDetailContent').innerHTML = 
                '<div class="no-data-message">üì≠ Ê≠§Ê∏¨È©óÂ∞öÁÑ°È°åÁõÆ</div>';
            return;
        }
        
        let itemsHtml = '<div class="items-dashboard">';
        
        itemsSnapshot.forEach(doc => {
            const item = doc.data();
            
            let typeText = '';
            let typeBadge = '';
            
            if (item.type === 'fill') {
                typeText = 'Â°´ÂÖÖÈ°å';
                typeBadge = 'fill';
            } else if (item.type === 'choice') {
                typeText = item.isMultipleChoice ? 'Â§öÈÅ∏È°å' : 'ÂñÆÈÅ∏È°å';
                typeBadge = 'choice';
            } else if (item.type === 'sort') {
                typeText = 'ÊéíÂ∫èÈ°å';
                typeBadge = 'sort';
            }
            
            itemsHtml += `
                <div class="quiz-question-card">
                    <div class="quiz-question-header">
                        <div>
                            <span class="quiz-question-number">Á¨¨ ${item.order} È°å</span>
                            <span class="quiz-type-badge ${typeBadge}">${typeText}</span>
                        </div>
                        <span class="quiz-question-score">${item.score} ÂàÜ</span>
                    </div>
                    <div class="quiz-question-text">${item.question}</div>
                    
                    ${item.type === 'choice' ? `
                        <div class="quiz-answer-area">
                            <strong>ÈÅ∏È†ÖÔºö</strong>
                            ${item.options.map(opt => `
                                <div style="padding: 8px 0;">
                                    ${opt.label}. ${opt.text} 
                                    ${opt.isCorrect ? '<span class="badge badge-success">‚úÖ Ê≠£Á¢∫Á≠îÊ°à</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${item.type === 'sort' ? `
                        <div class="quiz-answer-area">
                            <strong>Ê≠£Á¢∫È†ÜÂ∫èÔºö</strong>
                            ${item.items.sort((a, b) => a.correctOrder - b.correctOrder).map(sortItem => `
                                <div style="padding: 8px 0;">
                                    ${sortItem.correctOrder}. ${sortItem.text}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-warning btn-small" onclick="editQuizItem('${doc.id}')">‚úèÔ∏è Á∑®ËºØ</button>
                        <button class="btn btn-danger btn-small" onclick="deleteQuizItem('${doc.id}', '${item.question}')">üóëÔ∏è Âà™Èô§</button>
                    </div>
                </div>
            `;
        });
        
        itemsHtml += '</div>';
        document.getElementById('quizCategoryDetailContent').innerHTML = itemsHtml;
        
    } catch (error) {
        console.error('ËºâÂÖ•È°åÁõÆÂ§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}

        // ==================== Êñ∞Â¢ûÊ∏¨È©óÈ°åÁõÆ ====================
function showAddQuizItemModal() {
    const modalBody = `
        <div class="form-section">
            <label>È°åÁõÆÂÖßÂÆπ</label>
            <textarea id="newQuizQuestion" rows="3" placeholder="‰æãÂ¶ÇÔºöÊâãÈÉ®Ë°õÁîüÁöÑ‰∫îÂÄãÊôÇÊ©üÊòØ‰ªÄÈ∫ºÔºü"></textarea>
        </div>
        
        <div class="form-section">
            <label>È°åÁõÆÈ°ûÂûã</label>
            <select id="quizItemType" onchange="updateQuizItemTypeOptions()">
                <option value="choice">ÈÅ∏ÊìáÈ°åÔºàÂñÆÈÅ∏/Â§öÈÅ∏Ôºâ</option>
                <option value="fill">Â°´ÂÖÖÈ°å</option>
                <option value="sort">ÊéíÂ∫èÈ°å</option>
            </select>
        </div>
        
        <!-- ÈÅ∏ÊìáÈ°åÈÅ∏È†Ö -->
        <div id="choiceOptions" class="form-section">
            <div style="margin-bottom: 10px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="isMultipleChoice">
                    <span>Ë®≠ÁÇ∫Â§öÈÅ∏È°åÔºàÂèØÈÅ∏ÊìáÂ§öÂÄãÊ≠£Á¢∫Á≠îÊ°àÔºâ</span>
                </label>
            </div>
            
            <label>ÈÅ∏È†Ö A</label>
            <input type="text" id="optionA" placeholder="ÈÅ∏È†Ö A ÂÖßÂÆπ">
            <label style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                <input type="checkbox" id="correctA">
                <span>Ê≠£Á¢∫Á≠îÊ°à</span>
            </label>
            
            <label style="margin-top: 15px;">ÈÅ∏È†Ö B</label>
            <input type="text" id="optionB" placeholder="ÈÅ∏È†Ö B ÂÖßÂÆπ">
            <label style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                <input type="checkbox" id="correctB">
                <span>Ê≠£Á¢∫Á≠îÊ°à</span>
            </label>
            
            <label style="margin-top: 15px;">ÈÅ∏È†Ö C</label>
            <input type="text" id="optionC" placeholder="ÈÅ∏È†Ö C ÂÖßÂÆπ">
            <label style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                <input type="checkbox" id="correctC">
                <span>Ê≠£Á¢∫Á≠îÊ°à</span>
            </label>
            
            <label style="margin-top: 15px;">ÈÅ∏È†Ö D</label>
            <input type="text" id="optionD" placeholder="ÈÅ∏È†Ö D ÂÖßÂÆπ">
            <label style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                <input type="checkbox" id="correctD">
                <span>Ê≠£Á¢∫Á≠îÊ°à</span>
            </label>
        </div>
        
        <!-- ÊéíÂ∫èÈ°åÈÅ∏È†Ö -->
        <div id="sortOptions" class="form-section" style="display: none;">
            <div id="sortItemsContainer">
                <div class="sort-item-input" style="margin-bottom: 10px;">
                    <label>È†ÖÁõÆ 1</label>
                    <input type="text" class="sort-item-text" placeholder="Ëº∏ÂÖ•È†ÖÁõÆÂÖßÂÆπ">
                </div>
            </div>
            <button type="button" class="btn btn-info btn-small" onclick="addSortItem()">‚ûï Êñ∞Â¢ûÈ†ÖÁõÆ</button>
        </div>
        
        <div class="form-section">
            <label>ÂàÜÊï∏</label>
            <input type="number" id="quizItemScore" min="1" value="10" placeholder="10">
        </div>
        
        <div class="form-section">
            <label>È°åÁõÆÈ†ÜÂ∫è</label>
            <input type="number" id="quizItemOrder" min="1" value="1" placeholder="1">
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-success" onclick="saveNewQuizItem()">‚úÖ Êñ∞Â¢û</button>
            <button class="btn btn-secondary" onclick="closeModal()">‚ùå ÂèñÊ∂à</button>
        </div>
    `;
    
    showModal('‚ûï Êñ∞Â¢ûÊ∏¨È©óÈ°åÁõÆ', modalBody);
}

// ==================== Êõ¥Êñ∞È°åÁõÆÈ°ûÂûãÈÅ∏È†Ö ====================
function updateQuizItemTypeOptions() {
    const type = document.getElementById('quizItemType').value;
    
    document.getElementById('choiceOptions').style.display = type === 'choice' ? 'block' : 'none';
    document.getElementById('sortOptions').style.display = type === 'sort' ? 'block' : 'none';
}

// ==================== Êñ∞Â¢ûÊéíÂ∫èÈ†ÖÁõÆ ====================
function addSortItem() {
    const container = document.getElementById('sortItemsContainer');
    const count = container.children.length + 1;
    
    const itemHtml = `
        <div class="sort-item-input" style="margin-bottom: 10px;">
            <label>È†ÖÁõÆ ${count}</label>
            <input type="text" class="sort-item-text" placeholder="Ëº∏ÂÖ•È†ÖÁõÆÂÖßÂÆπ">
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', itemHtml);
}

// ==================== ÂÑ≤Â≠òÊñ∞Ê∏¨È©óÈ°åÁõÆ ====================
async function saveNewQuizItem() {
    const question = document.getElementById('newQuizQuestion').value.trim();
    const type = document.getElementById('quizItemType').value;
    const score = parseInt(document.getElementById('quizItemScore').value) || 10;
    const order = parseInt(document.getElementById('quizItemOrder').value) || 1;
    
    if (!question) {
        showToast('‚ùå Ë´ãËº∏ÂÖ•È°åÁõÆÂÖßÂÆπ', 'error');
        return;
    }
    
    let itemData = {
        categoryId: currentQuizCategoryId,
        question: question,
        type: type,
        score: score,
        order: order,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: currentUser.docId
    };
    
    // Ê†πÊìöÈ°åÁõÆÈ°ûÂûãËôïÁêÜË≥áÊñô
    if (type === 'choice') {
        const optionA = document.getElementById('optionA').value.trim();
        const optionB = document.getElementById('optionB').value.trim();
        const optionC = document.getElementById('optionC').value.trim();
        const optionD = document.getElementById('optionD').value.trim();
        
        if (!optionA || !optionB || !optionC || !optionD) {
            showToast('‚ùå Ë´ãÂ°´ÂØ´ÊâÄÊúâÈÅ∏È†Ö', 'error');
            return;
        }
        
        const correctA = document.getElementById('correctA').checked;
        const correctB = document.getElementById('correctB').checked;
        const correctC = document.getElementById('correctC').checked;
        const correctD = document.getElementById('correctD').checked;
        
        if (!correctA && !correctB && !correctC && !correctD) {
            showToast('‚ùå Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãÊ≠£Á¢∫Á≠îÊ°à', 'error');
            return;
        }
        
        itemData.isMultipleChoice = document.getElementById('isMultipleChoice').checked;
        itemData.options = [
            { label: 'A', text: optionA, isCorrect: correctA },
            { label: 'B', text: optionB, isCorrect: correctB },
            { label: 'C', text: optionC, isCorrect: correctC },
            { label: 'D', text: optionD, isCorrect: correctD }
        ];
        
    } else if (type === 'sort') {
        const sortInputs = document.querySelectorAll('.sort-item-text');
        const items = [];
        
        sortInputs.forEach((input, index) => {
            const text = input.value.trim();
            if (text) {
                items.push({
                    text: text,
                    correctOrder: index + 1
                });
            }
        });
        
        if (items.length < 2) {
            showToast('‚ùå ÊéíÂ∫èÈ°åËá≥Â∞ëÈúÄË¶Å 2 ÂÄãÈ†ÖÁõÆ', 'error');
            return;
        }
        
        itemData.items = items;
    }
    
    try {
        await db.collection('quizItems').add(itemData);
        
        showToast('‚úÖ È°åÁõÆÊñ∞Â¢ûÊàêÂäü', 'success');
        closeModal();
        showQuizCategoryDetail(currentQuizCategoryId);
        
    } catch (error) {
        console.error('Êñ∞Â¢ûÈ°åÁõÆÂ§±Êïó:', error);
        showToast('‚ùå Êñ∞Â¢ûÂ§±Êïó', 'error');
    }
}

// ==================== Á∑®ËºØÊ∏¨È©óÈ°åÁõÆ ====================
async function editQuizItem(itemId) {
    try {
        const itemDoc = await db.collection('quizItems').doc(itemId).get();
        const item = itemDoc.data();
        
        let typeOptions = `
            <option value="choice" ${item.type === 'choice' ? 'selected' : ''}>ÈÅ∏ÊìáÈ°å</option>
            <option value="fill" ${item.type === 'fill' ? 'selected' : ''}>Â°´ÂÖÖÈ°å</option>
            <option value="sort" ${item.type === 'sort' ? 'selected' : ''}>ÊéíÂ∫èÈ°å</option>
        `;
        
        let choiceOptionsHtml = '';
        if (item.type === 'choice') {
            choiceOptionsHtml = `
                <div id="editChoiceOptions" class="form-section">
                    <div style="margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="editIsMultipleChoice" ${item.isMultipleChoice ? 'checked' : ''}>
                            <span>Ë®≠ÁÇ∫Â§öÈÅ∏È°å</span>
                        </label>
                    </div>
                    ${item.options.map(opt => `
                        <label style="margin-top: 15px;">ÈÅ∏È†Ö ${opt.label}</label>
                        <input type="text" id="editOption${opt.label}" value="${opt.text}">
                        <label style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                            <input type="checkbox" id="editCorrect${opt.label}" ${opt.isCorrect ? 'checked' : ''}>
                            <span>Ê≠£Á¢∫Á≠îÊ°à</span>
                        </label>
                    `).join('')}
                </div>
            `;
        }
        
        let sortOptionsHtml = '';
        if (item.type === 'sort') {
            sortOptionsHtml = `
                <div id="editSortOptions" class="form-section">
                    <div id="editSortItemsContainer">
                        ${item.items.map((sortItem, index) => `
                            <div class="sort-item-input" style="margin-bottom: 10px;">
                                <label>È†ÖÁõÆ ${index + 1}</label>
                                <input type="text" class="edit-sort-item-text" value="${sortItem.text}">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        const modalBody = `
            <div class="form-section">
                <label>È°åÁõÆÂÖßÂÆπ</label>
                <textarea id="editQuizQuestion" rows="3">${item.question}</textarea>
            </div>
            
            <div class="form-section">
                <label>È°åÁõÆÈ°ûÂûã</label>
                <select id="editQuizItemType" disabled style="background: #f0f0f0;">
                    ${typeOptions}
                </select>
                <div style="margin-top: 5px; color: #666; font-size: 0.9em;">‚ö†Ô∏è È°åÁõÆÈ°ûÂûãÁÑ°Ê≥ï‰øÆÊîπ</div>
            </div>
            
            ${choiceOptionsHtml}
            ${sortOptionsHtml}
            
            <div class="form-section">
                <label>ÂàÜÊï∏</label>
                <input type="number" id="editQuizItemScore" min="1" value="${item.score}">
            </div>
            
            <div class="form-section">
                <label>È°åÁõÆÈ†ÜÂ∫è</label>
                <input type="number" id="editQuizItemOrder" min="1" value="${item.order}">
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="updateQuizItem('${itemId}')">‚úÖ ÂÑ≤Â≠ò</button>
                <button class="btn btn-secondary" onclick="closeModal()">‚ùå ÂèñÊ∂à</button>
            </div>
        `;
        
        showModal('‚úèÔ∏è Á∑®ËºØÊ∏¨È©óÈ°åÁõÆ', modalBody);
        
    } catch (error) {
        console.error('ËºâÂÖ•È°åÁõÆÂ§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}

// ==================== Êõ¥Êñ∞Ê∏¨È©óÈ°åÁõÆ ====================
async function updateQuizItem(itemId) {
    const question = document.getElementById('editQuizQuestion').value.trim();
    const score = parseInt(document.getElementById('editQuizItemScore').value) || 10;
    const order = parseInt(document.getElementById('editQuizItemOrder').value) || 1;
    
    if (!question) {
        showToast('‚ùå Ë´ãËº∏ÂÖ•È°åÁõÆÂÖßÂÆπ', 'error');
        return;
    }
    
    try {
        const itemDoc = await db.collection('quizItems').doc(itemId).get();
        const item = itemDoc.data();
        
        let updateData = {
            question: question,
            score: score,
            order: order,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser.docId
        };
        
        if (item.type === 'choice') {
            const optionA = document.getElementById('editOptionA').value.trim();
            const optionB = document.getElementById('editOptionB').value.trim();
            const optionC = document.getElementById('editOptionC').value.trim();
            const optionD = document.getElementById('editOptionD').value.trim();
            
            if (!optionA || !optionB || !optionC || !optionD) {
                showToast('‚ùå Ë´ãÂ°´ÂØ´ÊâÄÊúâÈÅ∏È†Ö', 'error');
                return;
            }
            
            const correctA = document.getElementById('editCorrectA').checked;
            const correctB = document.getElementById('editCorrectB').checked;
            const correctC = document.getElementById('editCorrectC').checked;
            const correctD = document.getElementById('editCorrectD').checked;
            
            if (!correctA && !correctB && !correctC && !correctD) {
                showToast('‚ùå Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãÊ≠£Á¢∫Á≠îÊ°à', 'error');
                return;
            }
            
            updateData.isMultipleChoice = document.getElementById('editIsMultipleChoice').checked;
            updateData.options = [
                { label: 'A', text: optionA, isCorrect: correctA },
                { label: 'B', text: optionB, isCorrect: correctB },
                { label: 'C', text: optionC, isCorrect: correctC },
                { label: 'D', text: optionD, isCorrect: correctD }
            ];
            
        } else if (item.type === 'sort') {
            const sortInputs = document.querySelectorAll('.edit-sort-item-text');
            const items = [];
            
            sortInputs.forEach((input, index) => {
                const text = input.value.trim();
                if (text) {
                    items.push({
                        text: text,
                        correctOrder: index + 1
                    });
                }
            });
            
            if (items.length < 2) {
                showToast('‚ùå ÊéíÂ∫èÈ°åËá≥Â∞ëÈúÄË¶Å 2 ÂÄãÈ†ÖÁõÆ', 'error');
                return;
            }
            
            updateData.items = items;
        }
        
        await db.collection('quizItems').doc(itemId).update(updateData);
        
        showToast('‚úÖ È°åÁõÆÊõ¥Êñ∞ÊàêÂäü', 'success');
        closeModal();
        showQuizCategoryDetail(currentQuizCategoryId);
        
    } catch (error) {
        console.error('Êõ¥Êñ∞È°åÁõÆÂ§±Êïó:', error);
        showToast('‚ùå Êõ¥Êñ∞Â§±Êïó', 'error');
    }
}

// ==================== Âà™Èô§Ê∏¨È©óÈ°åÁõÆ ====================
async function deleteQuizItem(itemId, question) {
    if (!confirm(`‚ùì Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§È°åÁõÆÂóéÔºü\n\n„Äå${question}„Äç`)) {
        return;
    }
    
    try {
        await db.collection('quizItems').doc(itemId).delete();
        showToast('‚úÖ È°åÁõÆÂ∑≤Âà™Èô§', 'success');
        showQuizCategoryDetail(currentQuizCategoryId);
        
    } catch (error) {
        console.error('Âà™Èô§È°åÁõÆÂ§±Êïó:', error);
        showToast('‚ùå Âà™Èô§Â§±Êïó', 'error');
    }
}
        
// ==================== È°ØÁ§∫Âì°Â∑•ÈÅ∏È†ÖÔºàÈñãÂßãÊ∏¨È©óÊàñÊü•ÁúãË®òÈåÑÔºâ====================
async function showQuizOptionsForStaff(categoryId) {
    try {
        const categoryDoc = await db.collection('quizCategories').doc(categoryId).get();
        const category = categoryDoc.data();
        
        // Ê™¢Êü•ÊòØÂê¶Â∑≤ÊúâË®òÈåÑ
        const recordsSnapshot = await db.collection('quizRecords')
            .where('userId', '==', currentUser.docId)
            .where('categoryId', '==', categoryId)
            .get();
        
        let modalBody = `
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 3em; margin-bottom: 10px;">${category.emoji}</div>
                <h3 style="color: #ffa502;">${category.name}</h3>
                <p style="color: #666; margin-top: 10px;">ÂêàÊ†ºÂàÜÊï∏Ôºö${category.passingScore}%</p>
            </div>
        `;
        
        if (recordsSnapshot.empty) {
            modalBody += `
                <p style="text-align: center; margin: 20px 0;">‰Ω†Â∞öÊú™ÂÆåÊàêÊ≠§Ê∏¨È©ó</p>
                <div class="modal-buttons">
                    <button class="btn btn-success" onclick="startQuiz('${categoryId}')">‚úçÔ∏è ÈñãÂßãÊ∏¨È©ó</button>
                    <button class="btn btn-secondary" onclick="closeModal()">‚ùå ÂèñÊ∂à</button>
                </div>
            `;
        } else {
            modalBody += `
                <p style="text-align: center; margin: 20px 0;">‰Ω†Â∑≤ÂÆåÊàêÈÅéÊ≠§Ê∏¨È©ó</p>
                <div class="modal-buttons">
                    <button class="btn btn-info" onclick="viewMyQuizRecords('${categoryId}')">üìä Êü•ÁúãË®òÈåÑ</button>
                    <button class="btn btn-success" onclick="startQuiz('${categoryId}')">‚úçÔ∏è ÈáçÊñ∞Ê∏¨È©ó</button>
                    <button class="btn btn-secondary" onclick="closeModal()">‚ùå ÂèñÊ∂à</button>
                </div>
            `;
        }
        
        showModal('üìù Quiz Ê∏¨È©ó', modalBody);
        
    } catch (error) {
        console.error('ËºâÂÖ•Â§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}

// ==================== ÈñãÂßãÊ∏¨È©ó ====================
async function startQuiz(categoryId) {
    closeModal();
    currentQuizCategoryId = categoryId;
    quizAnswers = {};
    
    showPage('quizTakingPage');
    
    try {
        const categoryDoc = await db.collection('quizCategories').doc(categoryId).get();
        const category = categoryDoc.data();
        
        document.getElementById('quizTakingTitle').textContent = 
            `${category.emoji} ${category.name}`;
        
        const itemsSnapshot = await db.collection('quizItems')
            .where('categoryId', '==', categoryId)
            .orderBy('order', 'asc')
            .get();
        
        let questionsHtml = '';
        
        itemsSnapshot.forEach(doc => {
            const item = doc.data();
            const itemId = doc.id;
            
            let typeText = '';
            let typeBadge = '';
            
            if (item.type === 'fill') {
                typeText = 'Â°´ÂÖÖÈ°å';
                typeBadge = 'fill';
            } else if (item.type === 'choice') {
                typeText = item.isMultipleChoice ? 'Â§öÈÅ∏È°å' : 'ÂñÆÈÅ∏È°å';
                typeBadge = 'choice';
            } else if (item.type === 'sort') {
                typeText = 'ÊéíÂ∫èÈ°å';
                typeBadge = 'sort';
            }
            
            questionsHtml += `
                <div class="quiz-question-card">
                    <div class="quiz-question-header">
                        <div>
                            <span class="quiz-question-number">Á¨¨ ${item.order} È°å</span>
                            <span class="quiz-type-badge ${typeBadge}">${typeText}</span>
                        </div>
                        <span class="quiz-question-score">${item.score} ÂàÜ</span>
                    </div>
                    <div class="quiz-question-text">${item.question}</div>
                    
                    <div class="quiz-answer-area">
                        ${renderQuizAnswerInput(itemId, item)}
                    </div>
                </div>
            `;
        });
        
        document.getElementById('quizTakingContent').innerHTML = questionsHtml;
        
    } catch (error) {
        console.error('ËºâÂÖ•Ê∏¨È©óÂ§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}

// ==================== Ê∏≤ÊüìÁ≠îÈ°åËº∏ÂÖ•ÂçÄ ====================
function renderQuizAnswerInput(itemId, item) {
    if (item.type === 'fill') {
        return `
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Ë´ãÂ°´ÂØ´Á≠îÊ°àÔºö</label>
            <textarea id="answer_${itemId}" rows="4" 
                      style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;"
                      placeholder="Ë´ãÂú®Ê≠§Ëº∏ÂÖ•‰Ω†ÁöÑÁ≠îÊ°à..."></textarea>
        `;
    } else if (item.type === 'choice') {
        const inputType = item.isMultipleChoice ? 'checkbox' : 'radio';
        
        return `
            <label style="display: block; margin-bottom: 12px; font-weight: bold;">
                ${item.isMultipleChoice ? 'Ë´ãÈÅ∏ÊìáÊâÄÊúâÊ≠£Á¢∫Á≠îÊ°àÔºö' : 'Ë´ãÈÅ∏Êìá‰∏ÄÂÄãÁ≠îÊ°àÔºö'}
            </label>
            ${item.options.map(opt => `
                <div class="quiz-option" onclick="toggleQuizOption('${itemId}', '${opt.label}', ${item.isMultipleChoice})">
                    <input type="${inputType}" name="answer_${itemId}" value="${opt.label}" 
                           id="opt_${itemId}_${opt.label}"
                           ${inputType === 'checkbox' ? '' : `onchange="selectRadioOption('${itemId}', '${opt.label}')"`}>
                    <label for="opt_${itemId}_${opt.label}" style="margin: 0; cursor: pointer; flex: 1;">
                        ${opt.label}. ${opt.text}
                    </label>
                </div>
            `).join('')}
        `;
    } else if (item.type === 'sort') {
        const shuffledItems = [...item.items].sort(() => Math.random() - 0.5);
        
        return `
            <label style="display: block; margin-bottom: 12px; font-weight: bold;">
                Ë´ãÂú®ÊñπÊ†ºÂÖßÂ°´ÂÖ•Ê≠£Á¢∫È†ÜÂ∫èÔºà1 ÁÇ∫ÊúÄÂÖàÔºå${item.items.length} ÁÇ∫ÊúÄÂæåÔºâÔºö
            </label>
            <div id="sortContainer_${itemId}">
                ${shuffledItems.map((sortItem, index) => `
                    <div class="quiz-sort-item">
                        <input type="number" class="sort-number" 
                               id="sort_${itemId}_${index}"
                               min="1" max="${item.items.length}"
                               placeholder="?"
                               data-item-text="${sortItem.text}">
                        <span class="sort-text">${sortItem.text}</span>
                    </div>
                `).join('')}
            </div>
        `;
    }
}

// ==================== ÂàáÊèõÈÅ∏È†ÖÈÅ∏Êìá ====================
function toggleQuizOption(itemId, optLabel, isMultiple) {
    const checkbox = document.getElementById(`opt_${itemId}_${optLabel}`);
    
    if (isMultiple) {
        checkbox.checked = !checkbox.checked;
    } else {
        // ÂñÆÈÅ∏ÔºöÂÖàÊ∏ÖÈô§ÊâÄÊúâÈÅ∏Êìá
        document.querySelectorAll(`input[name="answer_${itemId}"]`).forEach(input => {
            input.checked = false;
            input.closest('.quiz-option').classList.remove('selected');
        });
        checkbox.checked = true;
    }
    
    // Êõ¥Êñ∞Ë¶ñË¶∫Ê®£Âºè
    if (checkbox.checked) {
        checkbox.closest('.quiz-option').classList.add('selected');
    } else {
        checkbox.closest('.quiz-option').classList.remove('selected');
    }
}

// ==================== ÈÅ∏ÊìáÂñÆÈÅ∏ÈÅ∏È†Ö ====================
function selectRadioOption(itemId, optLabel) {
    document.querySelectorAll(`input[name="answer_${itemId}"]`).forEach(input => {
        input.closest('.quiz-option').classList.remove('selected');
    });
    
    const selected = document.getElementById(`opt_${itemId}_${optLabel}`);
    selected.closest('.quiz-option').classList.add('selected');
}

// ==================== Êèê‰∫§Ê∏¨È©óÁ≠îÊ°à ====================
async function submitQuizAnswers() {
    if (!confirm('‚ùì Á¢∫ÂÆöË¶ÅÊèê‰∫§Ê∏¨È©óÂóéÔºüÊèê‰∫§ÂæåÂ∞áÁÑ°Ê≥ï‰øÆÊîπ„ÄÇ')) {
        return;
    }
    
    try {
        const itemsSnapshot = await db.collection('quizItems')
            .where('categoryId', '==', currentQuizCategoryId)
            .get();
        
        const answers = {};
        let totalScore = 0;
        let maxScore = 0;
        
        itemsSnapshot.forEach(doc => {
            const item = doc.data();
            const itemId = doc.id;
            maxScore += item.score;
            
            if (item.type === 'fill') {
                const answerText = document.getElementById(`answer_${itemId}`)?.value || '';
                answers[itemId] = {
                    type: 'fill',
                    answer: answerText,
                    score: null, // ÂæÖÊâπÊîπ
                    remark: ''
                };
            } else if (item.type === 'choice') {
                const selected = Array.from(document.querySelectorAll(`input[name="answer_${itemId}"]:checked`))
                    .map(input => input.value);
                
                const correctOptions = item.options.filter(opt => opt.isCorrect).map(opt => opt.label);
                const isCorrect = selected.length === correctOptions.length && 
                                 selected.every(s => correctOptions.includes(s));
                
                answers[itemId] = {
                    type: 'choice',
                    selectedOptions: selected,
                    isCorrect: isCorrect,
                    score: isCorrect ? item.score : 0
                };
                
                if (isCorrect) totalScore += item.score;
            } else if (item.type === 'sort') {
                const userOrder = [];
                const container = document.getElementById(`sortContainer_${itemId}`);
                const inputs = container.querySelectorAll('.sort-number');
                
                inputs.forEach(input => {
                    userOrder.push({
                        text: input.dataset.itemText,
                        order: parseInt(input.value) || 0
                    });
                });
                
                // Ê™¢Êü•Á≠îÊ°à
                let isCorrect = true;
                item.items.forEach(correctItem => {
                    const userItem = userOrder.find(u => u.text === correctItem.text);
                    if (!userItem || userItem.order !== correctItem.correctOrder) {
                        isCorrect = false;
                    }
                });
                
                answers[itemId] = {
                    type: 'sort',
                    userOrder: userOrder,
                    isCorrect: isCorrect,
                    score: isCorrect ? item.score : 0
                };
                
                if (isCorrect) totalScore += item.score;
            }
        });
        
        const categoryDoc = await db.collection('quizCategories').doc(currentQuizCategoryId).get();
        const category = categoryDoc.data();
        
        const currentPercentage = Math.round((totalScore / maxScore) * 100);
        
        // ÂÑ≤Â≠òË®òÈåÑ
        await db.collection('quizRecords').add({
            userId: currentUser.docId,
            categoryId: currentQuizCategoryId,
            status: 'submitted',
            answers: answers,
            totalScore: totalScore,
            maxScore: maxScore,
            isPassed: currentPercentage >= category.passingScore,
            staffName: currentUser.name,
            staffLevel: currentUser.level,
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast('‚úÖ Ê∏¨È©óÂ∑≤Êèê‰∫§ÔºåÁ≠âÂæÖ‰∏ªÁÆ°ÊâπÊîπ', 'success');
        showQuizMain();
        
    } catch (error) {
        console.error('Êèê‰∫§Ê∏¨È©óÂ§±Êïó:', error);
        showToast('‚ùå Êèê‰∫§Â§±Êïó', 'error');
    }
}

// ==================== ÂèñÊ∂àÊ∏¨È©ó ====================
function cancelQuizTaking() {
    if (confirm('‚ùì Á¢∫ÂÆöË¶ÅÂèñÊ∂àÂóéÔºüÂ∑≤Â°´ÂØ´ÁöÑÁ≠îÊ°àÂ∞áÊúÉÈÅ∫Â§±„ÄÇ')) {
        showQuizMain();
    }
}

// ==================== ËøîÂõû Quiz Dashboard ====================
function backToQuizDashboard() {
    showQuizMain();
}

        // ==================== ‰∏ªÁÆ°Êü•ÁúãÊåáÂÆöÊ∏¨È©óÁöÑÂæÖÊâπÊîπË®òÈåÑ + Âì°Â∑•ÈÄ≤Â∫¶ ====================
async function showQuizRecordsForSupervisor(categoryId) {
    currentQuizCategoryId = categoryId;
    showPage('quizRecordsPage');
    
    try {
        const categoryDoc = await db.collection('quizCategories').doc(categoryId).get();
        const category = categoryDoc.data();
        
        document.getElementById('quizRecordsTitle').textContent = 
            `${category.emoji} ${category.name} - Ê∏¨È©óÁÆ°ÁêÜ`;
        
        // ‚≠ê‚≠ê‚≠ê Êñ∞Â¢ûÔºöÂì°Â∑•ÈÅ∏Êìá‰∏ãÊãâÈÅ∏ÂñÆ ‚≠ê‚≠ê‚≠ê
        let employeeSelectorHtml = `
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 3px 15px rgba(0,0,0,0.08);">
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: bold; color: #ffa502; margin-bottom: 8px; display: block;">
                        üë• Êü•Ë©¢Âì°Â∑•ÈÄ≤Â∫¶Ôºö
                    </label>
                    <select id="employeeProgressSelect" 
                            onchange="loadEmployeeQuizProgress('${categoryId}')"
                            style="width: 100%; padding: 12px; border: 2px solid #ffa502; border-radius: 8px; font-size: 1em;">
                        <option value="">-- ÈÅ∏ÊìáÂì°Â∑• --</option>
                    </select>
                </div>
                <div id="employeeProgressDisplay" style="display: none;"></div>
            </div>
        `;
        
        // ‚≠ê‚≠ê‚≠ê ËºâÂÖ•Âì°Â∑•Ê∏ÖÂñÆÂà∞‰∏ãÊãâÈÅ∏ÂñÆ ‚≠ê‚≠ê‚≠ê
        const accountsSnapshot = await db.collection('accounts')
            .where('role', '==', 'staff')
            .get();
        
        const employeeOptions = [];
        accountsSnapshot.forEach(doc => {
            const account = doc.data();
            employeeOptions.push(`
                <option value="${doc.id}">
                    ${account.name} (${account.level})
                </option>
            `);
        });
        
        // ÂæÖÊâπÊîπË®òÈåÑÂçÄÂüü
        const recordsSnapshot = await db.collection('quizRecords')
            .where('categoryId', '==', categoryId)
            .where('status', 'in', ['submitted', 'failed']) // ‚≠ê Âè™È°ØÁ§∫ÂæÖÊâπÊîπÂíå‰∏çÂêàÊ†º
            .orderBy('completedAt', 'desc')
            .get();
        
        let pendingRecordsHtml = `
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 3px 15px rgba(0,0,0,0.08);">
                <h3 style="color: #ffa502; margin-bottom: 20px;">üìã ÂæÖÊâπÊîπÊ∏¨È©ó</h3>
        `;
        
        if (recordsSnapshot.empty) {
            pendingRecordsHtml += '<div class="no-data-message">‚úÖ ÁõÆÂâçÊ≤íÊúâÂæÖÊâπÊîπÁöÑÊ∏¨È©ó</div>';
        } else {
            recordsSnapshot.forEach(doc => {
                const record = doc.data();
                const percentage = Math.round((record.totalScore / record.maxScore) * 100);
                const isFailed = record.status === 'failed';
                
                pendingRecordsHtml += `
                    <div class="quiz-record-card ${isFailed ? 'failed' : 'pending'}" 
                         onclick="gradeQuiz('${doc.id}')"
                         style="${isFailed ? 'background: linear-gradient(135deg, #ff4757 0%, #e84118 100%); color: white;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h3 style="margin-bottom: 5px; ${isFailed ? 'color: white;' : ''}">${record.staffName}</h3>
                                <div style="${isFailed ? 'color: rgba(255,255,255,0.9);' : 'color: #666;'}">
                                    <span class="badge badge-${record.staffLevel}">${record.staffLevel}</span>
                                    <span style="margin-left: 10px;">${record.completedAt?.toDate().toLocaleString('zh-TW')}</span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 2em; font-weight: bold; color: ${isFailed ? 'white' : '#ff4757'};">
                                    ${percentage}%
                                </div>
                                <div style="${isFailed ? 'color: rgba(255,255,255,0.9);' : 'color: #666;'}">
                                    ${record.totalScore} / ${record.maxScore} ÂàÜ
                                </div>
                            </div>
                        </div>
                        <div style="padding: 10px; background: ${isFailed ? 'rgba(255,255,255,0.2)' : '#fff3cd'}; border-radius: 8px; text-align: center;">
                            <strong>${isFailed ? 'üî¥ ‰∏çÂêàÊ†º - ÈúÄÈáçÂÅö' : '‚è≥ ÂæÖÊâπÊîπ'}</strong>
                        </div>
                    </div>
                `;
            });
        }
        
        pendingRecordsHtml += '</div>';
        
        // ÁµÑÂêà HTML
        document.getElementById('quizRecordsContent').innerHTML = 
            employeeSelectorHtml + pendingRecordsHtml;
        
        // ‚≠ê‚≠ê‚≠ê ÂãïÊÖãÂ°´ÂÖ•Âì°Â∑•ÈÅ∏È†Ö ‚≠ê‚≠ê‚≠ê
        const selectElement = document.getElementById('employeeProgressSelect');
        if (selectElement) {
            selectElement.innerHTML += employeeOptions.join('');
        }
        
    } catch (error) {
        console.error('ËºâÂÖ•Ë®òÈåÑÂ§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}

// ‚≠ê‚≠ê‚≠ê Êñ∞Â¢ûÔºöËºâÂÖ•Âì°Â∑• Quiz ÈÄ≤Â∫¶ ‚≠ê‚≠ê‚≠ê
async function loadEmployeeQuizProgress(categoryId) {
    const employeeId = document.getElementById('employeeProgressSelect').value;
    const displayDiv = document.getElementById('employeeProgressDisplay');
    
    if (!employeeId) {
        displayDiv.style.display = 'none';
        return;
    }
    
    try {
        const employeeDoc = await db.collection('accounts').doc(employeeId).get();
        const employee = employeeDoc.data();
        
        const recordsSnapshot = await db.collection('quizRecords')
            .where('userId', '==', employeeId)
            .where('categoryId', '==', categoryId)
            .orderBy('completedAt', 'desc')
            .get();
        
        let progressHtml = `
            <div style="border-top: 2px solid #f0f0f0; padding-top: 20px; margin-top: 20px;">
                <h4 style="color: #333; margin-bottom: 15px;">
                    üìä ${employee.name} (${employee.level}) ÁöÑÊ∏¨È©óË®òÈåÑ
                </h4>
        `;
        
        if (recordsSnapshot.empty) {
            progressHtml += '<div style="text-align: center; color: #999; padding: 20px;">Ê≠§Âì°Â∑•Â∞öÊú™ÂÆåÊàêÊ∏¨È©ó</div>';
        } else {
            recordsSnapshot.forEach(doc => {
                const record = doc.data();
                const percentage = Math.round((record.totalScore / record.maxScore) * 100);
                const statusText = record.status === 'graded' ? 'Â∑≤ÊâπÊîπ' : record.status === 'failed' ? '‰∏çÂêàÊ†º' : 'ÂæÖÊâπÊîπ';
                const statusColor = record.status === 'graded' && record.isPassed ? '#2ed573' : '#ff4757';
                
                progressHtml += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${record.completedAt?.toDate().toLocaleString('zh-TW')}</strong>
                                <div style="color: #666; font-size: 0.9em; margin-top: 5px;">
                                    ${statusText} | 
                                    ${record.isPassed ? '‚úÖ ÂêàÊ†º' : '‚ùå ‰∏çÂêàÊ†º'}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5em; font-weight: bold; color: ${statusColor};">
                                    ${percentage}%
                                </div>
                                <div style="color: #666; font-size: 0.9em;">
                                    ${record.totalScore} / ${record.maxScore} ÂàÜ
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        progressHtml += '</div>';
        
        displayDiv.innerHTML = progressHtml;
        displayDiv.style.display = 'block';
        
    } catch (error) {
        console.error('ËºâÂÖ•Âì°Â∑•ÈÄ≤Â∫¶Â§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}
        
// ==================== ÊâπÊîπÊ∏¨È©ó ====================
async function gradeQuiz(recordId) {
    currentQuizRecordId = recordId;
    showPage('quizGradingPage');
    
    try {
        const recordDoc = await db.collection('quizRecords').doc(recordId).get();
        const record = recordDoc.data();
        
        const categoryDoc = await db.collection('quizCategories').doc(record.categoryId).get();
        const category = categoryDoc.data();
        
        document.getElementById('quizGradingTitle').textContent = 
            `ÊâπÊîπÊ∏¨È©ó - ${record.staffName}`;
        
        const itemsSnapshot = await db.collection('quizItems')
            .where('categoryId', '==', record.categoryId)
            .orderBy('order', 'asc')
            .get();
        
        let gradingHtml = `
            <div style="background: #f0f4ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="color: #ffa502; margin-bottom: 10px;">${category.emoji} ${category.name}</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div>
                        <strong>Âì°Â∑•Ôºö</strong>${record.staffName} (${record.staffLevel})
                    </div>
                    <div>
                        <strong>ÂÆåÊàêÊôÇÈñìÔºö</strong>${record.completedAt?.toDate().toLocaleString('zh-TW')}
                    </div>
                    <div>
                        <strong>Áï∂ÂâçÂàÜÊï∏Ôºö</strong>${record.totalScore} / ${record.maxScore} ÂàÜ
                    </div>
                </div>
            </div>
        `;
        
        itemsSnapshot.forEach(doc => {
            const item = doc.data();
            const itemId = doc.id;
            const answer = record.answers[itemId];
            
            if (!answer) return;
            
            let typeText = '';
            let typeBadge = '';
            
            if (item.type === 'fill') {
                typeText = 'Â°´ÂÖÖÈ°å';
                typeBadge = 'fill';
            } else if (item.type === 'choice') {
                typeText = item.isMultipleChoice ? 'Â§öÈÅ∏È°å' : 'ÂñÆÈÅ∏È°å';
                typeBadge = 'choice';
            } else if (item.type === 'sort') {
                typeText = 'ÊéíÂ∫èÈ°å';
                typeBadge = 'sort';
            }
            
            gradingHtml += `
                <div class="quiz-question-card">
                    <div class="quiz-question-header">
                        <div>
                            <span class="quiz-question-number">Á¨¨ ${item.order} È°å</span>
                            <span class="quiz-type-badge ${typeBadge}">${typeText}</span>
                        </div>
                        <span class="quiz-question-score">${item.score} ÂàÜ</span>
                    </div>
                    <div class="quiz-question-text">${item.question}</div>
                    
                    <div class="quiz-answer-area">
                        ${renderGradingInterface(itemId, item, answer)}
                    </div>
                </div>
            `;
        });
        
        document.getElementById('quizGradingContent').innerHTML = gradingHtml;
        
    } catch (error) {
        console.error('ËºâÂÖ•ÊâπÊîπ‰ªãÈù¢Â§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}

// ==================== Ê∏≤ÊüìÊâπÊîπ‰ªãÈù¢ ====================
function renderGradingInterface(itemId, item, answer) {
    let html = '<div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">';
    
    if (answer.type === 'fill') {
        html += `
            <div style="margin-bottom: 15px;">
                <strong>Â≠∏Âì°Á≠îÊ°àÔºö</strong>
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-top: 8px; white-space: pre-wrap;">
                    ${answer.answer || '(Êú™‰ΩúÁ≠î)'}
                </div>
            </div>
            <div class="quiz-grading-input">
                <div>
                    <label>Áµ¶ÂàÜÔºö</label>
                    <input type="number" id="score_${itemId}" min="0" max="${item.score}" 
                           value="${answer.score !== null ? answer.score : ''}"
                           placeholder="0-${item.score}">
                </div>
                <div>
                    <label>Ë©ïË™ûÔºö</label>
                    <textarea id="remark_${itemId}" placeholder="Ë´ãËº∏ÂÖ•Ë©ïË™û...">${answer.remark || ''}</textarea>
                </div>
            </div>
        `;
    } else if (answer.type === 'choice') {
        const correctOptions = item.options.filter(opt => opt.isCorrect).map(opt => opt.label);
        
        html += `
            <div style="margin-bottom: 15px;">
                <strong>ÈÅ∏È†ÖÔºö</strong>
                ${item.options.map(opt => {
                    const isUserSelected = answer.selectedOptions.includes(opt.label);
                    const isCorrect = opt.isCorrect;
                    let optionClass = '';
                    
                    if (isUserSelected && isCorrect) {
                        optionClass = 'correct';
                    } else if (isUserSelected && !isCorrect) {
                        optionClass = 'incorrect';
                    } else if (!isUserSelected && isCorrect) {
                        optionClass = 'correct';
                    }
                    
                    return `
                        <div class="quiz-option ${optionClass}" style="cursor: default;">
                            <input type="checkbox" ${isUserSelected ? 'checked' : ''} disabled>
                            <span>
                                ${opt.label}. ${opt.text}
                                ${isCorrect ? '<span class="badge badge-success" style="margin-left: 10px;">‚úÖ Ê≠£Á¢∫Á≠îÊ°à</span>' : ''}
                                ${isUserSelected && !isCorrect ? '<span class="badge badge-danger" style="margin-left: 10px;">‚ùå Â≠∏Âì°Ë™§ÈÅ∏</span>' : ''}
                            </span>
                        </div>
                    `;
                }).join('')}
            </div>
            <div style="padding: 12px; background: ${answer.isCorrect ? '#f0fff4' : '#fff5f5'}; border-radius: 8px; text-align: center;">
                <strong style="color: ${answer.isCorrect ? '#2ed573' : '#ff4757'};">
                    ${answer.isCorrect ? '‚úÖ Á≠îÂ∞ç‰∫ÜÔºÅ' : '‚ùå Á≠îÈåØ‰∫Ü'}
                </strong>
                <div style="margin-top: 5px;">ÂæóÂàÜÔºö${answer.score} / ${item.score} ÂàÜ</div>
            </div>
        `;
    } else if (answer.type === 'sort') {
        html += `
            <div style="margin-bottom: 15px;">
                <strong>Â≠∏Âì°ÊéíÂ∫èÔºö</strong>
                <div style="margin-top: 10px;">
                    ${answer.userOrder.map(userItem => {
                        const correctItem = item.items.find(i => i.text === userItem.text);
                        const isCorrect = userItem.order === correctItem.correctOrder;
                        
                        return `
                            <div style="display: flex; align-items: center; padding: 8px; margin: 5px 0; background: ${isCorrect ? '#f0fff4' : '#fff5f5'}; border-radius: 8px;">
                                <span style="width: 40px; text-align: center; font-weight: bold; color: ${isCorrect ? '#2ed573' : '#ff4757'};">
                                    ${userItem.order}
                                </span>
                                <span style="flex: 1;">${userItem.text}</span>
                                <span style="width: 80px; text-align: center;">
                                    ${isCorrect ? '‚úÖ' : `‚ùå ÊáâÁÇ∫ ${correctItem.correctOrder}`}
                                </span>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            <div style="padding: 12px; background: ${answer.isCorrect ? '#f0fff4' : '#fff5f5'}; border-radius: 8px; text-align: center;">
                <strong style="color: ${answer.isCorrect ? '#2ed573' : '#ff4757'};">
                    ${answer.isCorrect ? '‚úÖ ÊéíÂ∫èÊ≠£Á¢∫ÔºÅ' : '‚ùå ÊéíÂ∫èÈåØË™§'}
                </strong>
                <div style="margin-top: 5px;">ÂæóÂàÜÔºö${answer.score} / ${item.score} ÂàÜ</div>
            </div>
        `;
    }
    
    html += '</div>';
    return html;
}

// ==================== Êèê‰∫§ÊâπÊîπÁµêÊûú ====================
async function submitQuizGrade() {
    if (!confirm('‚ùì Á¢∫ÂÆöË¶ÅÊèê‰∫§ÊâπÊîπÁµêÊûúÂóéÔºü')) {
        return;
    }
    
    try {
        const recordDoc = await db.collection('quizRecords').doc(currentQuizRecordId).get();
        const record = recordDoc.data();
        
        const itemsSnapshot = await db.collection('quizItems')
            .where('categoryId', '==', record.categoryId)
            .get();
        
        let totalScore = 0;
        const updatedAnswers = { ...record.answers };
        
        itemsSnapshot.forEach(doc => {
            const item = doc.data();
            const itemId = doc.id;
            const answer = updatedAnswers[itemId];
            
            if (answer.type === 'fill') {
                const score = parseInt(document.getElementById(`score_${itemId}`)?.value) || 0;
                const remark = document.getElementById(`remark_${itemId}`)?.value || '';
                
                answer.score = score;
                answer.remark = remark;
                totalScore += score;
            } else {
                totalScore += answer.score;
            }
        });
        
        const categoryDoc = await db.collection('quizCategories').doc(record.categoryId).get();
        const category = categoryDoc.data();
        
        const percentage = Math.round((totalScore / record.maxScore) * 100);
        const isPassed = percentage >= category.passingScore;
        
        // ‚≠ê‚≠ê‚≠ê ÈóúÈçµ‰øÆÊîπÔºöÊ†πÊìöÂêàÊ†ºËàáÂê¶Ë®≠ÂÆö status ‚≠ê‚≠ê‚≠ê
        await db.collection('quizRecords').doc(currentQuizRecordId).update({
            status: isPassed ? 'graded' : 'failed', // ‚≠ê ‰∏çÂêàÊ†ºË®≠ÁÇ∫ 'failed'
            answers: updatedAnswers,
            totalScore: totalScore,
            isPassed: isPassed,
            gradedBy: currentUser.docId,
            gradedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast(isPassed ? '‚úÖ ÊâπÊîπÂÆåÊàê - ÂêàÊ†º' : '‚ö†Ô∏è ÊâπÊîπÂÆåÊàê - ‰∏çÂêàÊ†ºÔºàÂ∞áÁπºÁ∫åÈ°ØÁ§∫ÊèêÈÜíÔºâ', isPassed ? 'success' : 'warning');
        showQuizRecordsForSupervisor(record.categoryId);
        
    } catch (error) {
        console.error('Êèê‰∫§ÊâπÊîπÂ§±Êïó:', error);
        showToast('‚ùå Êèê‰∫§Â§±Êïó', 'error');
    }
}

// ==================== ËøîÂõûË®òÈåÑÂàóË°® ====================
function backToQuizRecords() {
    showQuizRecordsForSupervisor(currentQuizCategoryId);
}

// ==================== Êü•ÁúãÊàëÁöÑÊ∏¨È©óË®òÈåÑÔºàÂì°Â∑•Ôºâ====================
async function viewMyQuizRecords(categoryId) {
    closeModal();
    currentQuizCategoryId = categoryId;
    showPage('quizRecordsPage');
    
    try {
        const categoryDoc = await db.collection('quizCategories').doc(categoryId).get();
        const category = categoryDoc.data();
        
        document.getElementById('quizRecordsTitle').textContent = 
            `${category.emoji} ${category.name} - ÊàëÁöÑË®òÈåÑ`;
        
        const recordsSnapshot = await db.collection('quizRecords')
            .where('userId', '==', currentUser.docId)
            .where('categoryId', '==', categoryId)
            .orderBy('completedAt', 'desc')
            .get();
        
        if (recordsSnapshot.empty) {
            document.getElementById('quizRecordsContent').innerHTML = 
                '<div class="no-data-message">üì≠ Â∞öÁÑ°Ê∏¨È©óË®òÈåÑ</div>';
            return;
        }
        
        let recordsHtml = '';
        
        recordsSnapshot.forEach(doc => {
            const record = doc.data();
            const statusClass = record.status === 'graded' ? 'graded' : 'pending';
            const statusText = record.status === 'graded' ? 'Â∑≤ÊâπÊîπ' : 'ÂæÖÊâπÊîπ';
            const percentage = Math.round((record.totalScore / record.maxScore) * 100);
            
            recordsHtml += `
                <div class="quiz-record-card ${statusClass}" onclick="viewQuizResult('${doc.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h3 style="margin-bottom: 5px;">Ê∏¨È©óË®òÈåÑ</h3>
                            <div style="color: #666;">
                                ${record.completedAt?.toDate().toLocaleString('zh-TW')}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 2em; font-weight: bold; color: ${record.isPassed ? '#2ed573' : '#ff4757'};">
                                ${percentage}%
                            </div>
                            <div style="color: #666;">${record.totalScore} / ${record.maxScore} ÂàÜ</div>
                        </div>
                    </div>
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                        <strong>${statusText}</strong>
                        ${record.status === 'graded' ? (record.isPassed ? ' | ‚úÖ ÂêàÊ†º' : ' | ‚ùå ‰∏çÂêàÊ†º') : ''}
                    </div>
                </div>
            `;
        });
        
        document.getElementById('quizRecordsContent').innerHTML = recordsHtml;
        
    } catch (error) {
        console.error('ËºâÂÖ•Ë®òÈåÑÂ§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}

// ==================== Êü•ÁúãÊ∏¨È©óÁµêÊûúË©≥ÊÉÖ ====================
async function viewQuizResult(recordId) {
    showPage('quizResultPage');
    
    try {
        const recordDoc = await db.collection('quizRecords').doc(recordId).get();
        const record = recordDoc.data();
        
        const categoryDoc = await db.collection('quizCategories').doc(record.categoryId).get();
        const category = categoryDoc.data();
        
        document.getElementById('quizResultTitle').textContent = 
            `${category.emoji} ${category.name} - Ê∏¨È©óÁµêÊûú`;
        
        const percentage = Math.round((record.totalScore / record.maxScore) * 100);
        const isPassed = record.isPassed;
        
        let resultHtml = `
            <div class="quiz-result-summary ${isPassed ? 'passed' : 'failed'}">
                <div style="font-size: 1.5em; margin-bottom: 10px;">
                    ${isPassed ? 'üéâ ÊÅ≠ÂñúÂêàÊ†ºÔºÅ' : 'üí™ ÁπºÁ∫åÂä™ÂäõÔºÅ'}
                </div>
                <div class="quiz-score-display">${percentage}%</div>
                <div style="font-size: 1.2em; margin: 10px 0;">
                    ${record.totalScore} / ${record.maxScore} ÂàÜ
                </div>
                <div class="quiz-status-badge">
                    ${record.status === 'graded' ? (isPassed ? '‚úÖ Â∑≤ÊâπÊîπ - ÂêàÊ†º' : '‚ùå Â∑≤ÊâπÊîπ - ‰∏çÂêàÊ†º') : '‚è≥ ÂæÖÊâπÊîπ'}
                </div>
                <div style="margin-top: 15px; font-size: 0.95em;">
                    ÂêàÊ†ºÊ®ôÊ∫ñÔºö${category.passingScore}%
                </div>
            </div>
        `;
        
        const itemsSnapshot = await db.collection('quizItems')
            .where('categoryId', '==', record.categoryId)
            .orderBy('order', 'asc')
            .get();
        
        itemsSnapshot.forEach(doc => {
            const item = doc.data();
            const itemId = doc.id;
            const answer = record.answers[itemId];
            
            if (!answer) return;
            
            let typeText = '';
            let typeBadge = '';
            
            if (item.type === 'fill') {
                typeText = 'Â°´ÂÖÖÈ°å';
                typeBadge = 'fill';
            } else if (item.type === 'choice') {
                typeText = item.isMultipleChoice ? 'Â§öÈÅ∏È°å' : 'ÂñÆÈÅ∏È°å';
                typeBadge = 'choice';
            } else if (item.type === 'sort') {
                typeText = 'ÊéíÂ∫èÈ°å';
                typeBadge = 'sort';
            }
            
            let answerDisplay = '';
            
            if (answer.type === 'fill') {
                answerDisplay = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        <strong>‰Ω†ÁöÑÁ≠îÊ°àÔºö</strong>
                        <div style="margin-top: 8px; white-space: pre-wrap;">${answer.answer || '(Êú™‰ΩúÁ≠î)'}</div>
                    </div>
                    ${record.status === 'graded' ? `
                        <div style="margin-top: 15px; padding: 12px; background: ${answer.score > 0 ? '#f0fff4' : '#fff5f5'}; border-radius: 8px;">
                            <strong>ÂæóÂàÜÔºö</strong>${answer.score} / ${item.score} ÂàÜ
                            ${answer.remark ? `<div style="margin-top: 8px;"><strong>Ë©ïË™ûÔºö</strong>${answer.remark}</div>` : ''}
                        </div>
                    ` : ''}
                `;
            } else if (answer.type === 'choice') {
                answerDisplay = `
                    <div style="margin-top: 10px;">
                        ${item.options.map(opt => {
                            const isUserSelected = answer.selectedOptions.includes(opt.label);
                            const isCorrect = opt.isCorrect;
                            let optionClass = '';
                            
                            if (record.status === 'graded') {
                                if (isUserSelected && isCorrect) {
                                    optionClass = 'correct';
                                } else if (isUserSelected && !isCorrect) {
                                    optionClass = 'incorrect';
                                } else if (!isUserSelected && isCorrect) {
                                    optionClass = 'correct';
                                }
                            }
                            
                            return `
                                <div class="quiz-option ${optionClass}" style="cursor: default;">
                                    <input type="checkbox" ${isUserSelected ? 'checked' : ''} disabled>
                                    <span>
                                        ${opt.label}. ${opt.text}
                                        ${record.status === 'graded' && isCorrect ? '<span class="badge badge-success" style="margin-left: 10px;">‚úÖ Ê≠£Á¢∫Á≠îÊ°à</span>' : ''}
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: ${answer.isCorrect ? '#f0fff4' : '#fff5f5'}; border-radius: 8px; text-align: center;">
                        <strong>ÂæóÂàÜÔºö</strong>${answer.score} / ${item.score} ÂàÜ
                    </div>
                `;
            } else if (answer.type === 'sort') {
                answerDisplay = `
                    <div style="margin-top: 10px;">
                        ${answer.userOrder.map(userItem => {
                            const correctItem = item.items.find(i => i.text === userItem.text);
                            const isCorrect = userItem.order === correctItem.correctOrder;
                            
                            return `
                                <div style="display: flex; align-items: center; padding: 8px; margin: 5px 0; background: ${isCorrect ? '#f0fff4' : '#fff5f5'}; border-radius: 8px;">
                                    <span style="width: 40px; text-align: center; font-weight: bold; color: ${isCorrect ? '#2ed573' : '#ff4757'};">
                                        ${userItem.order}
                                    </span>
                                    <span style="flex: 1;">${userItem.text}</span>
                                    <span style="width: 100px; text-align: center; font-size: 0.9em; color: #666;">
                                        ${isCorrect ? '‚úÖ Ê≠£Á¢∫' : `ÊáâÁÇ∫ ${correctItem.correctOrder}`}
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: ${answer.isCorrect ? '#f0fff4' : '#fff5f5'}; border-radius: 8px; text-align: center;">
                        <strong>ÂæóÂàÜÔºö</strong>${answer.score} / ${item.score} ÂàÜ
                    </div>
                `;
            }
            
            resultHtml += `
                <div class="quiz-question-card">
                    <div class="quiz-question-header">
                        <div>
                            <span class="quiz-question-number">Á¨¨ ${item.order} È°å</span>
                            <span class="quiz-type-badge ${typeBadge}">${typeText}</span>
                        </div>
                        <span class="quiz-question-score">${item.score} ÂàÜ</span>
                    </div>
                    <div class="quiz-question-text">${item.question}</div>
                    ${answerDisplay}
                </div>
            `;
        });
        
        document.getElementById('quizResultContent').innerHTML = resultHtml;
        
    } catch (error) {
        console.error('ËºâÂÖ•ÁµêÊûúÂ§±Êïó:', error);
        showToast('‚ùå ËºâÂÖ•Â§±Êïó', 'error');
    }
}
    </script>
</body>
</html>
